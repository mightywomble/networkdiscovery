{% extends "base_patternfly.html" %}

{% block title %}Statistics Dashboard - Home Lab{% endblock %}

{% block breadcrumb %}
<li class="pf-c-breadcrumb__item">
    <a href="{{ url_for('index') }}" class="pf-c-breadcrumb__link">Home</a>
</li>
<li class="pf-c-breadcrumb__item" aria-current="page">
    <a href="#" class="pf-c-breadcrumb__link pf-m-current" aria-current="page">Statistics</a>
</li>
{% endblock %}

{% block styles %}
<style>
/* Statistics-specific styles */
.nm-chart-container {
    position: relative;
    height: 350px;
    margin-top: var(--pf-global--spacer--md);
}

.nm-chart-container.small {
    height: 200px;
}

.nm-metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--pf-global--spacer--sm) 0;
    border-bottom: 1px solid var(--pf-global--BorderColor--100);
}

.nm-metric-row:last-child {
    border-bottom: none;
}

.nm-metric-label {
    font-weight: var(--pf-global--FontWeight--semi-bold);
    color: var(--pf-global--Color--dark-200);
}

.nm-metric-value {
    font-weight: var(--pf-global--FontWeight--bold);
    color: var(--pf-global--primary-color--100);
}

.nm-stats-grid {
    display: grid;
    gap: var(--pf-global--spacer--lg);
    grid-template-columns: 1fr;
}

@media (min-width: 768px) {
    .nm-stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}

@media (min-width: 1200px) {
    .nm-stats-grid-triple {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .nm-stats-grid-wide {
        grid-template-columns: 2fr 1fr;
    }
}

.nm-progress-bar {
    background-color: var(--pf-global--BackgroundColor--300);
    border-radius: var(--pf-global--BorderRadius--sm);
    height: 8px;
    overflow: hidden;
    margin: var(--pf-global--spacer--xs) 0;
}

.nm-progress-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.nm-badge {
    display: inline-flex;
    align-items: center;
    padding: var(--pf-global--spacer--xs) var(--pf-global--spacer--sm);
    border-radius: var(--pf-global--BorderRadius--sm);
    font-size: var(--pf-global--FontSize--sm);
    font-weight: var(--pf-global--FontWeight--semi-bold);
}

.nm-badge-primary {
    background-color: var(--pf-global--primary-color--100);
    color: white;
}

.nm-badge-success {
    background-color: var(--pf-global--success-color--100);
    color: white;
}

.nm-badge-info {
    background-color: var(--pf-global--info-color--100);
    color: white;
}

.nm-badge-warning {
    background-color: var(--pf-global--warning-color--100);
    color: var(--pf-global--Color--dark-100);
}

.nm-table-container {
    max-height: 400px;
    overflow-y: auto;
}

.nm-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: var(--pf-global--spacer--xl);
    color: var(--pf-global--Color--200);
}

.nm-error {
    text-align: center;
    padding: var(--pf-global--spacer--lg);
    color: var(--pf-global--danger-color--100);
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="pf-c-page__main-section pf-m-light">
    <div class="pf-c-content">
        <h1>
            <i class="fas fa-chart-bar pf-u-mr-sm"></i>
            Statistics Dashboard
        </h1>
        <p class="pf-u-color-200">Comprehensive network activity and performance analytics</p>
    </div>
</section>

<!-- Last Update Info -->
<section class="pf-c-page__main-section" style="padding-top: 0;">
    <div class="pf-c-alert pf-m-info pf-m-inline pf-u-mb-md" style="border: none; background: transparent; padding: 0;">
        <div class="pf-c-alert__title" style="color: var(--pf-global--Color--200); font-size: var(--pf-global--FontSize--sm);">
            <i class="fas fa-clock pf-u-mr-sm"></i>
            Last Updated: <span id="lastUpdateTime">Loading...</span>
            <button class="pf-c-button pf-m-plain pf-u-ml-sm" onclick="refreshAllData()">
                <i id="refreshIcon" class="fas fa-sync"></i>
            </button>
        </div>
    </div>
</section>

<!-- Statistics Overview -->
<section class="pf-c-page__main-section" style="padding-top: 0;">
    {% include "unified_stats_cards.html" %}
</section>

<!-- Network Analysis Section -->
<section class="pf-c-page__main-section">
    <div class="nm-stats-grid">
        <!-- LAN vs External Analysis -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-globe-americas pf-u-mr-sm"></i>
                    Network Traffic Analysis
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="lanExternalChart" class="nm-chart-container small">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading network analysis...
                    </div>
                </div>
                <div id="lanExternalSummary" class="pf-u-mt-md">
                    <!-- Summary will be populated here -->
                </div>
            </div>
        </div>

        <!-- Protocol Breakdown -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-network-wired pf-u-mr-sm"></i>
                    Protocol Distribution
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="protocolBreakdown">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading protocols...
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Host and Connection Statistics -->
<section class="pf-c-page__main-section">
    <div class="nm-stats-grid">
        <!-- Top Hosts by Connections -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-server pf-u-mr-sm"></i>
                    Top Active Hosts
                </div>
            </div>
            <div class="pf-c-card__body">
                <div class="nm-table-container">
                    <table class="pf-c-table pf-m-compact pf-m-grid-md" id="topHostsTable">
                        <thead>
                            <tr>
                                <th>Host</th>
                                <th>Status</th>
                                <th>Connections</th>
                                <th>Destinations</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="nm-loading">
                                    <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                                    Loading hosts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top External Destinations -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-external-link-alt pf-u-mr-sm"></i>
                    Top External Destinations
                </div>
            </div>
            <div class="pf-c-card__body">
                <div class="nm-table-container">
                    <table class="pf-c-table pf-m-compact pf-m-grid-md" id="topDestinationsTable">
                        <thead>
                            <tr>
                                <th>Destination IP</th>
                                <th>Connections</th>
                                <th>Source Hosts</th>
                                <th>Ports</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="nm-loading">
                                    <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                                    Loading destinations...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Agent Activity Section -->
<section class="pf-c-page__main-section">
    <div class="nm-stats-grid">
        <!-- Agent Activity Overview -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-robot pf-u-mr-sm"></i>
                    Agent Activity Overview
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="agentOverview">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading agent data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Activity -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-search pf-u-mr-sm"></i>
                    Recent Scan Activity
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="scanActivity">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading scan activity...
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Agent Version and Platform Analysis -->
<section class="pf-c-page__main-section">
    <div class="nm-stats-grid">
        <!-- Agent Versions -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-code-branch pf-u-mr-sm"></i>
                    Agent Version Distribution
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="versionBreakdown">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading version data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Distribution -->
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-desktop pf-u-mr-sm"></i>
                    Platform Distribution
                </div>
            </div>
            <div class="pf-c-card__body">
                <div id="platformBreakdown">
                    <div class="nm-loading">
                        <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                        Loading platform data...
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Historical Trends -->
<section class="pf-c-page__main-section">
    <div class="pf-c-card">
        <div class="pf-c-card__header">
            <div class="pf-c-card__title">
                <i class="fas fa-chart-line pf-u-mr-sm"></i>
                Network Activity Trends (24 Hours)
            </div>
            <div class="pf-c-card__actions">
                <div class="pf-c-select" id="timeRangeSelect">
                    <select class="pf-c-form-control" onchange="updateTimeRange(this.value)">
                        <option value="24">Last 24 Hours</option>
                        <option value="72">Last 3 Days</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="pf-c-card__body">
            <div id="activityChart" class="nm-chart-container">
                <div class="nm-loading">
                    <i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>
                    Loading activity trends...
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let charts = {};
let refreshInterval;
let currentTimeRange = 24;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadAllStatistics();
    startAutoRefresh();
});

// Auto-refresh every 30 seconds
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        loadAllStatistics();
    }, 30000);
}

// Load all statistics data
async function loadAllStatistics() {
    showLoadingState();
    
    try {
        await Promise.all([
            loadNetworkStatistics(),
            loadAgentStatistics(),
            loadHistoricalStatistics()
        ]);
        
        updateLastRefreshTime();
    } catch (error) {
        console.error('Error loading statistics:', error);
        showErrorState('Failed to load statistics data');
    }
    
    hideLoadingState();
}

// Manual refresh function
function refreshAllData() {
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.style.animation = 'spin 1s linear infinite';
    
    loadAllStatistics().finally(() => {
        refreshIcon.style.animation = '';
    });
}

// Load network statistics
async function loadNetworkStatistics() {
    try {
        const response = await fetch('/api/statistics/network');
        const result = await response.json();
        
        if (result.success) {
            displayNetworkStatistics(result.data);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error loading network statistics:', error);
        showErrorInContainer('lanExternalChart', 'Failed to load network statistics');
    }
}

// Load agent statistics
async function loadAgentStatistics() {
    try {
        const response = await fetch('/api/statistics/agents');
        const result = await response.json();
        
        if (result.success) {
            displayAgentStatistics(result.data);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error loading agent statistics:', error);
        showErrorInContainer('agentOverview', 'Failed to load agent statistics');
    }
}

// Load historical statistics
async function loadHistoricalStatistics() {
    try {
        const response = await fetch(`/api/statistics/historical?hours=${currentTimeRange}`);
        const result = await response.json();
        
        if (result.success) {
            displayHistoricalStatistics(result.data);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error loading historical statistics:', error);
        showErrorInContainer('activityChart', 'Failed to load historical statistics');
    }
}

// Display network statistics
function displayNetworkStatistics(data) {
    // LAN vs External Chart
    displayLANExternalChart(data.lan_vs_external);
    
    // Protocol Breakdown
    displayProtocolBreakdown(data.protocol_breakdown);
    
    // Top Hosts Table
    displayTopHostsTable(data.top_hosts);
    
    // Top Destinations Table
    displayTopDestinationsTable(data.top_destinations);
}

// Display LAN vs External chart
function displayLANExternalChart(data) {
    const ctx = document.createElement('canvas');
    const container = document.getElementById('lanExternalChart');
    container.innerHTML = '';
    container.appendChild(ctx);
    
    if (charts.lanExternal) {
        charts.lanExternal.destroy();
    }
    
    const lanData = data.LAN || { connection_count: 0, percentage: 0 };
    const externalData = data.External || { connection_count: 0, percentage: 0 };
    
    charts.lanExternal = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['LAN Connections', 'External Connections'],
            datasets: [{
                data: [lanData.connection_count, externalData.connection_count],
                backgroundColor: ['#28a745', '#ffc107'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Update summary
    const summary = document.getElementById('lanExternalSummary');
    summary.innerHTML = `
        <div class="pf-l-flex pf-m-space-items-lg">
            <div class="pf-l-flex__item">
                <div class="nm-badge nm-badge-success">LAN: ${lanData.connection_count} (${lanData.percentage}%)</div>
            </div>
            <div class="pf-l-flex__item">
                <div class="nm-badge nm-badge-warning">External: ${externalData.connection_count} (${externalData.percentage}%)</div>
            </div>
        </div>
    `;
}

// Display protocol breakdown
function displayProtocolBreakdown(protocols) {
    const container = document.getElementById('protocolBreakdown');
    
    if (!protocols || protocols.length === 0) {
        container.innerHTML = '<p class="pf-u-text-align-center pf-u-color-200">No protocol data available</p>';
        return;
    }
    
    container.innerHTML = protocols.map(protocol => `
        <div class="nm-metric-row">
            <span class="nm-metric-label">${protocol.protocol.toUpperCase()}</span>
            <div>
                <span class="nm-badge nm-badge-primary">${protocol.connection_count}</span>
                <div class="pf-u-font-size-sm pf-u-color-200 pf-u-mt-xs">
                    ${protocol.unique_hosts} hosts → ${protocol.unique_destinations} destinations
                </div>
            </div>
        </div>
    `).join('');
}

// Display top hosts table
function displayTopHostsTable(hosts) {
    const tbody = document.querySelector('#topHostsTable tbody');
    
    if (!hosts || hosts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="pf-u-text-align-center pf-u-color-200">No host data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = hosts.map(host => `
        <tr>
            <td>
                <strong>${host.host_name || 'Unknown'}</strong>
                <div class="pf-u-font-size-sm pf-u-color-200">${host.ip_address}</div>
            </td>
            <td>
                <span class="nm-badge ${host.status === 'online' ? 'nm-badge-success' : 'nm-badge-warning'}">
                    ${host.status}
                </span>
            </td>
            <td>
                <span class="nm-badge nm-badge-primary">${host.connection_count}</span>
            </td>
            <td>
                <span class="pf-u-font-size-sm">${host.unique_destinations} destinations</span>
            </td>
        </tr>
    `).join('');
}

// Display top destinations table
function displayTopDestinationsTable(destinations) {
    const tbody = document.querySelector('#topDestinationsTable tbody');
    
    if (!destinations || destinations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="pf-u-text-align-center pf-u-color-200">No destination data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = destinations.map(dest => `
        <tr>
            <td><code>${dest.dest_ip}</code></td>
            <td><span class="nm-badge nm-badge-warning">${dest.connection_count}</span></td>
            <td><span class="pf-u-font-size-sm">${dest.source_hosts} hosts</span></td>
            <td><span class="pf-u-font-size-sm">${dest.dest_ports} ports</span></td>
        </tr>
    `).join('');
}

// Display agent statistics
function displayAgentStatistics(data) {
    displayAgentOverview(data.overview);
    displayScanActivity(data.scan_activity);
    displayVersionBreakdown(data.version_breakdown);
    displayPlatformBreakdown(data.platform_breakdown);
}

// Display agent overview
function displayAgentOverview(overview) {
    const container = document.getElementById('agentOverview');
    
    container.innerHTML = `
        <div class="pf-l-gallery pf-m-gutter" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
            <div class="pf-u-text-align-center">
                <div class="pf-u-font-size-xl pf-u-font-weight-bold pf-u-color-100">${overview.total_agents}</div>
                <div class="pf-u-font-size-sm pf-u-color-200">Total Agents</div>
            </div>
            <div class="pf-u-text-align-center">
                <div class="pf-u-font-size-xl pf-u-font-weight-bold" style="color: var(--pf-global--success-color--100);">${overview.active_agents}</div>
                <div class="pf-u-font-size-sm pf-u-color-200">Active</div>
            </div>
            <div class="pf-u-text-align-center">
                <div class="pf-u-font-size-xl pf-u-font-weight-bold" style="color: var(--pf-global--info-color--100);">${overview.recent_heartbeats}</div>
                <div class="pf-u-font-size-sm pf-u-color-200">Recent Heartbeats</div>
            </div>
            <div class="pf-u-text-align-center">
                <div class="pf-u-font-size-xl pf-u-font-weight-bold" style="color: var(--pf-global--warning-color--100);">${overview.recent_scans}</div>
                <div class="pf-u-font-size-sm pf-u-color-200">Recent Scans</div>
            </div>
        </div>
    `;
}

// Display scan activity
function displayScanActivity(scanActivity) {
    const container = document.getElementById('scanActivity');
    
    if (!scanActivity || scanActivity.length === 0) {
        container.innerHTML = '<p class="pf-u-text-align-center pf-u-color-200">No recent scan activity</p>';
        return;
    }
    
    container.innerHTML = scanActivity.map(scan => `
        <div class="nm-metric-row">
            <span class="nm-metric-label">${scan.scan_type}</span>
            <div>
                <span class="nm-badge nm-badge-info">${scan.scan_count} scans</span>
                <div class="pf-u-font-size-sm pf-u-color-200 pf-u-mt-xs">${scan.unique_agents} agents</div>
            </div>
        </div>
    `).join('');
}

// Display version breakdown
function displayVersionBreakdown(versions) {
    const container = document.getElementById('versionBreakdown');
    
    if (!versions || versions.length === 0) {
        container.innerHTML = '<p class="pf-u-text-align-center pf-u-color-200">No version data available</p>';
        return;
    }
    
    container.innerHTML = versions.map(version => `
        <div class="nm-metric-row">
            <span class="nm-metric-label">v${version.version}</span>
            <div>
                <span class="nm-badge nm-badge-primary">${version.agent_count} agents</span>
                <div class="pf-u-font-size-sm pf-u-color-200 pf-u-mt-xs">${version.active_count} active</div>
            </div>
        </div>
    `).join('');
}

// Display platform breakdown
function displayPlatformBreakdown(platforms) {
    const container = document.getElementById('platformBreakdown');
    
    if (!platforms || platforms.length === 0) {
        container.innerHTML = '<p class="pf-u-text-align-center pf-u-color-200">No platform data available</p>';
        return;
    }
    
    container.innerHTML = platforms.map(platform => `
        <div class="nm-metric-row">
            <span class="nm-metric-label">${platform.platform}</span>
            <div>
                <span class="nm-badge nm-badge-info">${platform.agent_count} agents</span>
                <div class="pf-u-font-size-sm pf-u-color-200 pf-u-mt-xs">${platform.active_count} active</div>
            </div>
        </div>
    `).join('');
}

// Display historical statistics
function displayHistoricalStatistics(data) {
    displayActivityChart(data.hourly_activity);
}

// Display activity chart
function displayActivityChart(hourlyData) {
    const ctx = document.createElement('canvas');
    const container = document.getElementById('activityChart');
    container.innerHTML = '';
    container.appendChild(ctx);
    
    if (charts.activity) {
        charts.activity.destroy();
    }
    
    if (!hourlyData || hourlyData.length === 0) {
        container.innerHTML = '<div class="nm-error">No historical data available for the selected time period</div>';
        return;
    }
    
    const labels = hourlyData.map(item => {
        const date = new Date(item.hour);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    });
    
    charts.activity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Connections',
                data: hourlyData.map(item => item.connections),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Active Hosts',
                data: hourlyData.map(item => item.unique_hosts),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Update time range
function updateTimeRange(hours) {
    currentTimeRange = parseInt(hours);
    loadHistoricalStatistics();
}

// Utility functions
function showLoadingState() {
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.style.animation = 'spin 1s linear infinite';
}

function hideLoadingState() {
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.style.animation = '';
}

function updateLastRefreshTime() {
    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
}

function showErrorState(message) {
    console.error(message);
}

function showErrorInContainer(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="nm-error"><i class="fas fa-exclamation-triangle pf-u-mr-sm"></i>${message}</div>`;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) clearInterval(refreshInterval);
    
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
});

// Add CSS animation for spinning
const style = document.createElement('style');
style.textContent = `
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
