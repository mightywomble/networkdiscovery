{% extends "base_patternfly.html" %}

{% block title %}Network Diagram - Home Lab{% endblock %}

{% block breadcrumb %}
<li class="pf-c-breadcrumb__item">
    <a href="{{ url_for('index') }}" class="pf-c-breadcrumb__link">Home</a>
</li>
<li class="pf-c-breadcrumb__item pf-m-current" aria-current="page">
    <span class="pf-c-breadcrumb__item-divider">
        <i class="fas fa-angle-right" aria-hidden="true"></i>
    </span>
    <span class="pf-c-breadcrumb__link">Network Diagram</span>
</li>
{% endblock %}

{% block extra_head %}
<!-- Override base template to exclude vis.js -->
<style>
    .network-canvas {
        background: white;
        border: 2px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .device-icon {
        cursor: pointer;
    }
    
    .device-icon:hover {
        opacity: 0.8;
    }
    
    .device-label {
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        fill: #333;
    }
    
    .connection-line {
        stroke: #666;
        stroke-width: 2;
        opacity: 0.7;
    }
    
    .connection-line.external {
        stroke: #dc3545;
        stroke-dasharray: 5,5;
    }
    
    .connection-line.internal {
        stroke: #007bff;
    }
    
    .tooltip {
        position: absolute;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }
    
    .banner {
        background: #28a745;
        color: white;
        padding: 10px 15px;
        text-align: center;
        margin-bottom: 15px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 16px;
    }
    
    .diagram-controls {
        margin-bottom: 15px;
        text-align: right;
    }
    
    .diagram-controls .pf-c-button {
        margin-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="pf-l-grid pf-m-gutter">
    <div class="pf-l-grid__item pf-m-12-col">
        <div class="pf-c-card">
            <div class="pf-c-card__header">
                <div class="pf-c-card__header-main">
                    <div class="pf-c-card__title">
                        <h1 class="pf-c-title pf-m-lg">
                            <i class="fas fa-project-diagram pf-u-mr-sm"></i>
                            Network Diagram
                        </h1>
                    </div>
                </div>
                <div class="pf-c-card__actions">
                    <div class="diagram-controls">
                        <button class="pf-c-button pf-m-secondary" onclick="refreshDiagram()">
                            <i class="fas fa-sync pf-u-mr-sm"></i>Refresh
                        </button>
                        <button class="pf-c-button pf-m-secondary" onclick="exportSVG()">
                            <i class="fas fa-download pf-u-mr-sm"></i>Export SVG
                        </button>
                    </div>
                </div>
            </div>
            <div class="pf-c-card__body">
                <div class="banner">
                    🎨 Pure SVG Network Diagram (NO vis.js, NO physics, NO flickering)
                </div>
                
                <div id="network-canvas" class="network-canvas" style="height: 600px; position: relative;">
                    <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100%; font-size: 18px; color: #666;">
                        <div class="pf-c-spinner pf-m-lg" role="progressbar">
                            <span class="pf-c-spinner__clipper"></span>
                            <span class="pf-c-spinner__lead-ball"></span>
                            <span class="pf-c-spinner__tail-ball"></span>
                        </div>
                        <span class="pf-u-ml-md">Loading network diagram...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip"></div>
{% endblock %}

{% block scripts %}
<script>
    // Global state
    let networkData = null;
    let svgElement = null;
    let tooltip = null;
    
    // Device configuration
    const deviceConfig = {
        server: { icon: '🖥️', color: '#007bff' },
        router: { icon: '📡', color: '#fd7e14' },
        switch: { icon: '🔗', color: '#17a2b8' },
        workstation: { icon: '💻', color: '#28a745' },
        external: { icon: '🌐', color: '#dc3545' },
        unknown: { icon: '📟', color: '#6c757d' }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
    console.log("📝 JavaScript file loaded and executing");
        console.log('🎨 Pure SVG Network Diagram Loading - NO vis.js');
        tooltip = document.getElementById('tooltip');
        loadNetworkData();
    });
    
    // Load network data
    function loadNetworkData() {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) loadingEl.style.display = 'flex';
        
        fetch('/api/network_data')
            .then(response => response.json())
            .then(data => {
                console.log('📊 Network data loaded:', data);
                networkData = processData(data);
                renderDiagram();
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            })
            .catch(error => {
                console.error('❌ Error loading data:', error);
                showError(error.message);
            });
    }
    
    // Process raw network data
    function processData(rawData) {
        return {
            nodes: rawData.nodes.map(node => ({
                id: node.id,
                label: node.label || node.name || `Node ${node.id}`,
                ip: node.ip,
                type: classifyNodeType(node),
                status: node.status || 'unknown'
            })),
            edges: rawData.edges.map(edge => ({
                from: edge.from,
                to: edge.to,
                label: edge.label || '',
                type: classifyEdgeType(edge)
            }))
        };
    }
    
    // Classify node type based on properties
    function classifyNodeType(node) {
        if (node.id && node.id.toString().startsWith('ext_')) return 'external';
        if (node.group === 'external') return 'external';
        if (node.label && node.label.toLowerCase().includes('router')) return 'router';
        if (node.label && node.label.toLowerCase().includes('switch')) return 'switch';
        return 'server';
    }
    
    // Classify edge type
    function classifyEdgeType(edge) {
        if (edge.to && edge.to.toString().startsWith('ext_')) return 'external';
        if (edge.dashes) return 'external';
        return 'internal';
    }
    
    // Render the SVG diagram
    function renderDiagram() {
        console.log('🎨 Rendering SVG diagram...');
        
        const container = document.getElementById('network-canvas');
        const rect = container.getBoundingClientRect();
        
        // Clear container
        container.innerHTML = '';
        
        // Create SVG
        svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svgElement.setAttribute('width', '100%');
        svgElement.setAttribute('height', '100%');
        svgElement.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        
        // Layout nodes
        layoutNodes(rect.width, rect.height);
        
        // Draw connections first (behind nodes)
        drawConnections();
        
        // Draw nodes on top
        drawNodes();
        
        // Add to container
        container.appendChild(svgElement);
        
        console.log(`✅ Rendered ${networkData.nodes.length} nodes and ${networkData.edges.length} connections`);
    }
    
    // Layout nodes in a clean grid
    function layoutNodes(width, height) {
        const margin = 60;
        const nodeSpacing = 140;
        
        // Separate internal and external nodes
        const internalNodes = networkData.nodes.filter(n => n.type !== 'external');
        const externalNodes = networkData.nodes.filter(n => n.type === 'external');
        
        // Layout internal nodes in the center
        const cols = Math.ceil(Math.sqrt(internalNodes.length));
        const rows = Math.ceil(internalNodes.length / cols);
        
        const centerX = width / 2;
        const centerY = height / 2;
        const startX = centerX - (cols * nodeSpacing) / 2;
        const startY = centerY - (rows * nodeSpacing) / 2;
        
        internalNodes.forEach((node, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            node.x = startX + (col * nodeSpacing);
            node.y = startY + (row * nodeSpacing);
        });
        
        // Layout external nodes around the perimeter
        externalNodes.forEach((node, i) => {
            const angle = (i / externalNodes.length) * 2 * Math.PI;
            const radius = Math.min(width, height) * 0.35;
            node.x = centerX + Math.cos(angle) * radius;
            node.y = centerY + Math.sin(angle) * radius;
        });
    }
    
    // Draw connection lines
    function drawConnections() {
        const nodeMap = new Map(networkData.nodes.map(n => [n.id, n]));
        
        networkData.edges.forEach(edge => {
            const fromNode = nodeMap.get(edge.from);
            const toNode = nodeMap.get(edge.to);
            
            if (!fromNode || !toNode) return;
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', fromNode.x);
            line.setAttribute('y1', fromNode.y);
            line.setAttribute('x2', toNode.x);
            line.setAttribute('y2', toNode.y);
            line.setAttribute('class', `connection-line ${edge.type}`);
            
            svgElement.appendChild(line);
        });
    }
    
    // Draw device nodes
    function drawNodes() {
        networkData.nodes.forEach(node => {
            const config = deviceConfig[node.type] || deviceConfig.unknown;
            
            // Create group
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('class', 'device-icon');
            
            // Background circle
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', node.x);
            circle.setAttribute('cy', node.y);
            circle.setAttribute('r', 30);
            circle.setAttribute('fill', 'white');
            circle.setAttribute('stroke', config.color);
            circle.setAttribute('stroke-width', 3);
            group.appendChild(circle);
            
            // Device icon
            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            icon.setAttribute('x', node.x);
            icon.setAttribute('y', node.y + 8);
            icon.setAttribute('text-anchor', 'middle');
            icon.setAttribute('font-size', '24');
            icon.textContent = config.icon;
            group.appendChild(icon);
            
            // Label
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', node.x);
            label.setAttribute('y', node.y + 50);
            label.setAttribute('class', 'device-label');
            label.textContent = node.label.length > 12 ? node.label.substring(0, 12) + '...' : node.label;
            group.appendChild(label);
            
            // Status indicator
            const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            status.setAttribute('cx', node.x + 20);
            status.setAttribute('cy', node.y - 20);
            status.setAttribute('r', 6);
            status.setAttribute('fill', getStatusColor(node.status));
            group.appendChild(status);
            
            // Event handlers - NO movement, stable tooltips
            group.addEventListener('mouseenter', (e) => showTooltip(e, node));
            group.addEventListener('mouseleave', hideTooltip);
            group.addEventListener('click', () => selectNode(node));
            
            svgElement.appendChild(group);
        });
    }
    
    // Get status color
    function getStatusColor(status) {
        switch (status) {
            case 'online': return '#28a745';
            case 'offline': return '#dc3545';  
            case 'warning': return '#ffc107';
            default: return '#6c757d';
        }
    }
    
    // Show tooltip - stable, no flicker
    function showTooltip(event, node) {
        tooltip.innerHTML = `
            <strong>${node.label}</strong><br>
            IP: ${node.ip || 'Unknown'}<br>
            Type: ${node.type}<br>
            Status: ${node.status}
        `;
        tooltip.style.display = 'block';
        tooltip.style.left = event.pageX + 15 + 'px';
        tooltip.style.top = event.pageY + 15 + 'px';
    }
    
    // Hide tooltip
    function hideTooltip() {
        tooltip.style.display = 'none';
    }
    
    // Select node
    function selectNode(node) {
        console.log('Selected node:', node);
    }
    
    // Refresh diagram
    function refreshDiagram() {
        console.log('🔄 Refreshing diagram...');
        loadNetworkData();
    }
    
    // Export SVG
    function exportSVG() {
        if (!svgElement) {
            alert('No diagram to export');
            return;
        }
        
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `network-diagram-${new Date().toISOString().slice(0, 10)}.svg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    // Show error
    function showError(message) {
        document.getElementById('network-canvas').innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #dc3545;">
                <div style="text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>Error Loading Diagram</h3>
                    <p>${message}</p>
                    <button class="pf-c-button pf-m-primary" onclick="refreshDiagram()">
                        <i class="fas fa-sync pf-u-mr-sm"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
</script>
{% endblock %}
