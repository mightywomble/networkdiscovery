{% extends "base.html" %}

{% block title %}Enhanced Network Topology - Network Map{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-sitemap me-2"></i>Enhanced Network Topology</h1>
        <p class="text-muted">Comprehensive network analysis with device roles, segments, and interconnections</p>
    </div>
</div>

<!-- Analysis Controls -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Analysis Controls</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <button class="btn btn-primary me-2" onclick="refreshTopologyAnalysis()">
                            <i class="fas fa-sync me-1"></i>Refresh Analysis
                        </button>
                        <button class="btn btn-secondary me-2" onclick="exportTopologyData()">
                            <i class="fas fa-download me-1"></i>Export Data
                        </button>
                        <div class="btn-group me-2">
                            <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-eye me-1"></i>View Mode
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setViewMode('roles')">Device Roles</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setViewMode('segments')">Network Segments</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setViewMode('security')">Security Zones</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setViewMode('performance')">Performance</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="d-flex justify-content-end align-items-center">
                            <span class="me-2">Analysis Status:</span>
                            <span id="analysis-status" class="badge bg-secondary">Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Enhanced Network Visualization -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Network Topology Visualization</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="fitNetwork()" title="Fit to screen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="togglePhysics()" title="Toggle physics" id="physics-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetView()" title="Reset view">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="enhanced-network-container" style="height: 700px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Panels -->
    <div class="col-lg-3">
        <!-- Selected Node Details -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Selected Node</h6>
            </div>
            <div class="card-body">
                <div id="selected-node-info">
                    <div class="text-center text-muted">
                        <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                        <p>Click on a node to view detailed analysis</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Network Insights -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Network Insights</h6>
            </div>
            <div class="card-body">
                <div id="network-insights">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Analyzing network...</span>
                </div>
            </div>
        </div>
        
        <!-- Device Role Legend -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-list me-2"></i>Device Roles</h6>
            </div>
            <div class="card-body">
                <div id="role-legend">
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #dc3545; border-radius: 50%;"></div>
                        <span class="small">Router/Gateway</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #28a745; border-radius: 50%;"></div>
                        <span class="small">Server</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #007bff; border-radius: 50%;"></div>
                        <span class="small">Workstation</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #fd7e14; border-radius: 50%;"></div>
                        <span class="small">Network Device</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #6c757d; border-radius: 50%;"></div>
                        <span class="small">Unknown</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Security Analysis -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Security Analysis</h6>
            </div>
            <div class="card-body">
                <div id="security-analysis">
                    <div class="small text-muted">
                        Security analysis will be displayed here
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Details Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Network Analysis Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="segments-tab" data-bs-toggle="tab" data-bs-target="#segments" type="button">Network Segments</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button">Device Roles</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="infrastructure-tab" data-bs-toggle="tab" data-bs-target="#infrastructure" type="button">Infrastructure</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button">Security Zones</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">Performance</button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="analysisTabContent">
                    <div class="tab-pane fade show active" id="segments" role="tabpanel">
                        <div id="segments-content"></div>
                    </div>
                    <div class="tab-pane fade" id="devices" role="tabpanel">
                        <div id="devices-content"></div>
                    </div>
                    <div class="tab-pane fade" id="infrastructure" role="tabpanel">
                        <div id="infrastructure-content"></div>
                    </div>
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div id="security-content"></div>
                    </div>
                    <div class="tab-pane fade" id="performance" role="tabpanel">
                        <div id="performance-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for enhanced topology
let enhancedNetwork = null;
let enhancedNodes = null;
let enhancedEdges = null;
let currentViewMode = 'roles';
let topologyAnalysis = null;
let physicsEnabled = true;

// Initialize enhanced network visualization
function initializeEnhancedNetwork() {
    const container = document.getElementById('enhanced-network-container');
    
    const options = {
        nodes: {
            borderWidth: 3,
            size: 25,
            font: {
                size: 14,
                face: 'Arial',
                color: '#333'
            },
            shadow: {
                enabled: true,
                size: 10,
                x: 2,
                y: 2
            },
            chosen: {
                node: function(values, id, selected, hovering) {
                    values.shadow = true;
                    values.shadowSize = 15;
                }
            }
        },
        edges: {
            width: 3,
            shadow: true,
            arrows: {
                to: { enabled: true, scaleFactor: 1.2 }
            },
            smooth: {
                enabled: true,
                type: 'continuous',
                roundness: 0.5
            },
            chosen: {
                edge: function(values, id, selected, hovering) {
                    values.width = 5;
                }
            }
        },
        physics: {
            enabled: true,
            stabilization: { iterations: 150 },
            barnesHut: {
                gravitationalConstant: -8000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04,
                damping: 0.09
            }
        },
        interaction: {
            tooltipDelay: 200,
            hideEdgesOnDrag: false,
            hideNodesOnDrag: false,
            selectConnectedEdges: true
        },
        layout: {
            improvedLayout: true
        }
    };
    
    enhancedNodes = new vis.DataSet([]);
    enhancedEdges = new vis.DataSet([]);
    enhancedNetwork = new vis.Network(container, { nodes: enhancedNodes, edges: enhancedEdges }, options);
    
    // Event handlers
    enhancedNetwork.on('click', handleNetworkClick);
    enhancedNetwork.on('hoverNode', handleNodeHover);
    
    // Load initial data
    loadEnhancedNetworkData();
    loadTopologyAnalysis();
}

// Load enhanced network data
function loadEnhancedNetworkData() {
    fetch('/api/enhanced_network_data')
    .then(response => response.json())
    .then(data => {
        updateEnhancedVisualization(data);
    })
    .catch(error => {
        console.error('Error loading enhanced network data:', error);
        showError('Failed to load network data');
    });
}

// Load topology analysis
function loadTopologyAnalysis() {
    document.getElementById('analysis-status').textContent = 'Analyzing...';
    document.getElementById('analysis-status').className = 'badge bg-warning';
    
    fetch('/api/topology_analysis')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            topologyAnalysis = data.analysis;
            updateNetworkInsights();
            updateSecurityAnalysis();
            document.getElementById('analysis-status').textContent = 'Complete';
            document.getElementById('analysis-status').className = 'badge bg-success';
        } else {
            throw new Error(data.error);
        }
    })
    .catch(error => {
        console.error('Error loading topology analysis:', error);
        document.getElementById('analysis-status').textContent = 'Error';
        document.getElementById('analysis-status').className = 'badge bg-danger';
    });
}

// Update enhanced visualization
function updateEnhancedVisualization(data) {
    const processedNodes = data.nodes.map(node => {
        const nodeColor = getEnhancedNodeColor(node, currentViewMode);
        const nodeSize = getNodeSize(node);
        
        return {
            id: node.id,
            label: `${node.label}\n${node.ip}`,
            title: createNodeTooltip(node),
            color: nodeColor,
            size: nodeSize,
            font: {
                size: nodeSize > 30 ? 16 : 14,
                color: getTextColor(nodeColor.background)
            },
            roles: node.roles || [],
            primary_role: node.primary_role || 'unknown',
            confidence: node.confidence || {},
            status: node.status
        };
    });
    
    const processedEdges = data.edges.map(edge => {
        const width = Math.max(2, Math.min(8, (edge.count || 1) / 5));
        return {
            id: `${edge.from}-${edge.to}-${edge.port}`,
            from: edge.from,
            to: edge.to,
            label: edge.port ? `:${edge.port}` : '',
            title: createEdgeTooltip(edge),
            width: width,
            color: getEdgeColor(edge.protocol)
        };
    });
    
    enhancedNodes.clear();
    enhancedEdges.clear();
    enhancedNodes.add(processedNodes);
    enhancedEdges.add(processedEdges);
    
    setTimeout(() => {
        if (enhancedNetwork && processedNodes.length > 0) {
            enhancedNetwork.fit();
        }
    }, 500);
}

// Get enhanced node color based on view mode
function getEnhancedNodeColor(node, viewMode) {
    switch (viewMode) {
        case 'roles':
            return getRoleBasedColor(node.primary_role);
        case 'segments':
            return getSegmentBasedColor(node.ip);
        case 'security':
            return getSecurityBasedColor(node.ip);
        case 'performance':
            return getPerformanceBasedColor(node);
        default:
            return getRoleBasedColor(node.primary_role);
    }
}

// Get role-based colors
function getRoleBasedColor(role) {
    const colors = {
        'router': { background: '#dc3545', border: '#a71e2a' },
        'dhcp_server': { background: '#28a745', border: '#1e7e34' },
        'dns_server': { background: '#17a2b8', border: '#117a8b' },
        'web_server': { background: '#007bff', border: '#0056b3' },
        'firewall': { background: '#6f42c1', border: '#59359a' },
        'wireless_access_point': { background: '#fd7e14', border: '#e55100' },
        'bridge_switch': { background: '#20c997', border: '#17a2b8' },
        'ssh_server': { background: '#6c757d', border: '#5a6268' },
        'unknown': { background: '#e9ecef', border: '#ced4da' }
    };
    
    return colors[role] || colors['unknown'];
}

// Get segment-based colors
function getSegmentBasedColor(ip) {
    if (ip.startsWith('192.168.')) {
        return { background: '#007bff', border: '#0056b3' };
    } else if (ip.startsWith('10.')) {
        return { background: '#28a745', border: '#1e7e34' };
    } else if (ip.startsWith('172.')) {
        return { background: '#6f42c1', border: '#59359a' };
    } else {
        return { background: '#fd7e14', border: '#e55100' };
    }
}

// Get security-based colors
function getSecurityBasedColor(ip) {
    if (ip.startsWith('192.168.')) {
        return { background: '#28a745', border: '#1e7e34' }; // Internal
    } else if (ip.startsWith('10.')) {
        return { background: '#ffc107', border: '#d39e00' }; // Management
    } else if (ip.startsWith('172.')) {
        return { background: '#17a2b8', border: '#117a8b' }; // Private
    } else {
        return { background: '#dc3545', border: '#a71e2a' }; // DMZ/External
    }
}

// Get performance-based colors
function getPerformanceBasedColor(node) {
    // This would use performance data if available
    return { background: '#007bff', border: '#0056b3' };
}

// Get node size based on importance/role
function getNodeSize(node) {
    const criticalRoles = ['router', 'dhcp_server', 'dns_server', 'firewall'];
    const serverRoles = ['web_server', 'mail_server', 'ssh_server'];
    
    if (criticalRoles.includes(node.primary_role)) {
        return 35;
    } else if (serverRoles.includes(node.primary_role)) {
        return 30;
    } else {
        return 25;
    }
}

// Get text color that contrasts with background
function getTextColor(backgroundColor) {
    // Simple contrast calculation
    if (backgroundColor === '#e9ecef' || backgroundColor === '#ffc107') {
        return '#333';
    }
    return '#fff';
}

// Get edge color based on protocol
function getEdgeColor(protocol) {
    const colors = {
        'tcp': '#007bff',
        'udp': '#28a745',
        'icmp': '#ffc107',
        'http': '#17a2b8',
        'https': '#6f42c1'
    };
    
    return colors[protocol?.toLowerCase()] || '#6c757d';
}

// Create node tooltip
function createNodeTooltip(node) {
    let tooltip = `<strong>${node.label}</strong><br>`;
    tooltip += `IP: ${node.ip}<br>`;
    tooltip += `Status: ${node.status}<br>`;
    tooltip += `Primary Role: ${node.primary_role}<br>`;
    
    if (node.roles && node.roles.length > 0) {
        tooltip += `All Roles: ${node.roles.join(', ')}<br>`;
    }
    
    if (node.confidence && Object.keys(node.confidence).length > 0) {
        tooltip += 'Confidence:<br>';
        for (const [role, conf] of Object.entries(node.confidence)) {
            tooltip += `  ${role}: ${(conf * 100).toFixed(0)}%<br>`;
        }
    }
    
    return tooltip;
}

// Create edge tooltip
function createEdgeTooltip(edge) {
    let tooltip = `Connection<br>`;
    tooltip += `Port: ${edge.port}<br>`;
    tooltip += `Protocol: ${edge.protocol}<br>`;
    tooltip += `Count: ${edge.count}<br>`;
    tooltip += `Last Seen: ${edge.last_seen}`;
    
    return tooltip;
}

// Handle network click events
function handleNetworkClick(params) {
    if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        showEnhancedNodeDetails(nodeId);
    } else {
        clearSelectedNodeInfo();
    }
}

// Handle node hover
function handleNodeHover(params) {
    // Optional: highlight connected nodes
}

// Show enhanced node details
function showEnhancedNodeDetails(nodeId) {
    const node = enhancedNodes.get(nodeId);
    if (!node) return;
    
    const infoPanel = document.getElementById('selected-node-info');
    infoPanel.innerHTML = `
        <div class="border-start border-primary border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-server me-2"></i>${node.label.split('\\n')[0]}
            </h6>
            <div class="mb-3">
                <span class="badge bg-primary me-1">${node.primary_role}</span>
                <span class="badge bg-outline-secondary">${node.status}</span>
            </div>
            
            <div class="small mb-2">
                <strong>IP Address:</strong> <code>${node.label.split('\\n')[1]}</code><br>
                <strong>All Roles:</strong> ${node.roles.join(', ') || 'None'}<br>
            </div>
            
            <div class="mb-3">
                <strong class="small">Role Confidence:</strong>
                <div class="mt-1">
                    ${Object.entries(node.confidence).map(([role, conf]) => 
                        `<div class="d-flex justify-content-between small">
                            <span>${role}:</span>
                            <span class="fw-bold">${(conf * 100).toFixed(0)}%</span>
                        </div>`
                    ).join('')}
                </div>
            </div>
            
            <div class="d-grid gap-1">
                <button class="btn btn-sm btn-outline-primary" onclick="focusNode(${nodeId})">
                    <i class="fas fa-crosshairs me-1"></i>Focus
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="showFullHostDetails(${nodeId})">
                    <i class="fas fa-info-circle me-1"></i>Full Details
                </button>
            </div>
        </div>
    `;
}

// Clear selected node info
function clearSelectedNodeInfo() {
    const infoPanel = document.getElementById('selected-node-info');
    infoPanel.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
            <p>Click on a node to view detailed analysis</p>
        </div>
    `;
}

// Update network insights
function updateNetworkInsights() {
    if (!topologyAnalysis) return;
    
    const insights = document.getElementById('network-insights');
    const deviceRoles = topologyAnalysis.device_roles || {};
    const networkSegments = topologyAnalysis.network_segments || {};
    
    // Count devices by role
    const roleCounts = {};
    Object.values(deviceRoles).forEach(device => {
        const role = device.primary_role || 'unknown';
        roleCounts[role] = (roleCounts[role] || 0) + 1;
    });
    
    let insightsHtml = '<div class="small">';
    insightsHtml += '<strong>Network Summary:</strong><br>';
    insightsHtml += `• ${Object.keys(networkSegments).length} network segments<br>`;
    insightsHtml += `• ${Object.keys(deviceRoles).length} analyzed devices<br><br>`;
    
    insightsHtml += '<strong>Device Distribution:</strong><br>';
    Object.entries(roleCounts).forEach(([role, count]) => {
        insightsHtml += `• ${role.replace('_', ' ')}: ${count}<br>`;
    });
    
    insightsHtml += '</div>';
    insights.innerHTML = insightsHtml;
}

// Update security analysis
function updateSecurityAnalysis() {
    if (!topologyAnalysis) return;
    
    const securityPanel = document.getElementById('security-analysis');
    const securityZones = topologyAnalysis.security_zones || {};
    const trustBoundaries = securityZones.trust_boundaries || [];
    
    let securityHtml = '<div class="small">';
    securityHtml += '<strong>Security Zones:</strong><br>';
    securityHtml += `• Internal: ${(securityZones.internal_hosts || []).length}<br>`;
    securityHtml += `• Management: ${(securityZones.management_hosts || []).length}<br>`;
    securityHtml += `• DMZ: ${(securityZones.dmz_hosts || []).length}<br>`;
    securityHtml += `• Trust Boundaries: ${trustBoundaries.length}<br>`;
    securityHtml += '</div>';
    
    securityPanel.innerHTML = securityHtml;
}

// Control functions
function refreshTopologyAnalysis() {
    loadTopologyAnalysis();
    loadEnhancedNetworkData();
}

function setViewMode(mode) {
    currentViewMode = mode;
    loadEnhancedNetworkData();
}

function fitNetwork() {
    if (enhancedNetwork) {
        enhancedNetwork.fit();
    }
}

function togglePhysics() {
    physicsEnabled = !physicsEnabled;
    const btn = document.getElementById('physics-btn');
    
    if (enhancedNetwork) {
        enhancedNetwork.setOptions({ physics: { enabled: physicsEnabled } });
        btn.innerHTML = physicsEnabled ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    }
}

function resetView() {
    if (enhancedNetwork) {
        enhancedNetwork.fit();
        enhancedNetwork.setOptions({ physics: { enabled: true } });
        physicsEnabled = true;
        document.getElementById('physics-btn').innerHTML = '<i class="fas fa-pause"></i>';
    }
}

function focusNode(nodeId) {
    if (enhancedNetwork) {
        enhancedNetwork.focus(nodeId, {
            scale: 1.5,
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

function showFullHostDetails(nodeId) {
    // This would open the host details modal
    showHostDetails(nodeId);
}

function exportTopologyData() {
    if (topologyAnalysis) {
        const dataStr = JSON.stringify(topologyAnalysis, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `network-topology-analysis-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    }
}

function showError(message) {
    const insights = document.getElementById('network-insights');
    insights.innerHTML = `<div class="alert alert-danger small">${message}</div>`;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedNetwork();
    
    // Auto-refresh every 2 minutes
    setInterval(() => {
        loadEnhancedNetworkData();
    }, 120000);
});

// Handle window resize
window.addEventListener('resize', function() {
    if (enhancedNetwork) {
        enhancedNetwork.redraw();
    }
});
</script>
{% endblock %}
