{% extends "base.html" %}

{% block title %}Enhanced Network Topology - Complete Network Visualization{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-project-diagram me-2"></i>Enhanced Network Topology</h1>
        <p class="text-muted">Comprehensive visualization of server interconnections, protocols, and internet services</p>
    </div>
</div>

<div class="row mb-3">
    <!-- Main Topology Visualization -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Network Infrastructure Map</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" onclick="refreshTopology()" title="Refresh Data" id="refresh-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="fitNetwork()" title="Fit to Screen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportTopology()" title="Export Topology">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="togglePhysics()" title="Toggle Physics" id="physics-btn">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showLegend()" title="Show Legend">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Layout Control Bar -->
                <div class="border-bottom p-2 bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Layout:</label>
                            <select class="form-select form-select-sm" id="layout-select" onchange="changeLayout()">
                                <option value="hierarchical">Hierarchical</option>
                                <option value="force">Force-Directed</option>
                                <option value="circular">Circular</option>
                                <option value="grid">Grid</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Group By:</label>
                            <select class="form-select form-select-sm" id="grouping-select" onchange="applyGrouping()">
                                <option value="subnet">Subnet</option>
                                <option value="role">Device Role</option>
                                <option value="protocol">Primary Protocol</option>
                                <option value="services">Service Type</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Edge Style:</label>
                            <select class="form-select form-select-sm" id="edge-style" onchange="updateEdgeStyle()">
                                <option value="protocol">By Protocol</option>
                                <option value="bandwidth">By Bandwidth</option>
                                <option value="frequency">By Frequency</option>
                                <option value="security">By Security Level</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-check-inline mt-4">
                                <input class="form-check-input" type="checkbox" id="show-labels" checked onchange="toggleLabels()">
                                <label class="form-check-label small" for="show-labels">Node Labels</label>
                            </div>
                            <div class="form-check form-check-inline mt-4">
                                <input class="form-check-input" type="checkbox" id="show-edge-labels" checked onchange="toggleEdgeLabels()">
                                <label class="form-check-label small" for="show-edge-labels">Edge Labels</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Network Visualization Container -->
                <div id="network-container" style="height: 650px; position: relative;">
                    <div class="loading-overlay" id="loading-overlay" style="display: none;">
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <div class="text-primary">Loading network topology...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel and Information -->
    <div class="col-lg-3">
        <!-- Advanced Filters -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Advanced Filters</h6>
            </div>
            <div class="card-body">
                <!-- Node Type Filters -->
                <div class="mb-3">
                    <label class="form-label small">Device Types:</label>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-servers" checked>
                        <label class="form-check-label small" for="filter-servers">
                            <i class="fas fa-server text-primary"></i> Servers
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-workstations" checked>
                        <label class="form-check-label small" for="filter-workstations">
                            <i class="fas fa-desktop text-success"></i> Workstations
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-routers" checked>
                        <label class="form-check-label small" for="filter-routers">
                            <i class="fas fa-route text-warning"></i> Routers/Gateways
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-internet" checked>
                        <label class="form-check-label small" for="filter-internet">
                            <i class="fas fa-globe text-info"></i> Internet Services
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-cloud" checked>
                        <label class="form-check-label small" for="filter-cloud">
                            <i class="fas fa-cloud text-secondary"></i> Cloud Services
                        </label>
                    </div>
                </div>

                <!-- Protocol Filters -->
                <div class="mb-3">
                    <label class="form-label small">Protocols:</label>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="protocol-http" checked>
                        <label class="form-check-label small" for="protocol-http">HTTP/HTTPS</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="protocol-ssh" checked>
                        <label class="form-check-label small" for="protocol-ssh">SSH</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="protocol-db" checked>
                        <label class="form-check-label small" for="protocol-db">Database</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="protocol-dns" checked>
                        <label class="form-check-label small" for="protocol-dns">DNS</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="protocol-mail" checked>
                        <label class="form-check-label small" for="protocol-mail">Email</label>
                    </div>
                </div>

                <!-- Connection Filters -->
                <div class="mb-3">
                    <label class="form-label small">Connection Types:</label>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="conn-internal" checked>
                        <label class="form-check-label small" for="conn-internal">Internal</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="conn-external" checked>
                        <label class="form-check-label small" for="conn-external">External</label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="conn-vpn" checked>
                        <label class="form-check-label small" for="conn-vpn">VPN</label>
                    </div>
                </div>

                <!-- Time Range -->
                <div class="mb-3">
                    <label for="time-range" class="form-label small">Time Range:</label>
                    <select class="form-select form-select-sm" id="time-range">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last Week</option>
                        <option value="720">Last Month</option>
                        <option value="0">All Time</option>
                    </select>
                </div>

                <!-- Connection Threshold -->
                <div class="mb-3">
                    <label for="connection-threshold" class="form-label small">Min Connections:</label>
                    <input type="range" class="form-range" id="connection-threshold" min="1" max="100" value="1" oninput="updateConnectionThreshold(this.value)">
                    <small class="text-muted">Threshold: <span id="threshold-value">1</span></small>
                </div>

                <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="resetFilters()">
                    <i class="fas fa-undo me-1"></i>Reset
                </button>
            </div>
        </div>

        <!-- Selected Node Information -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Node Information</h6>
            </div>
            <div class="card-body" id="node-info">
                <div class="text-center text-muted">
                    <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                    <p class="small">Click on a node or connection to view details</p>
                </div>
            </div>
        </div>

        <!-- Network Statistics -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Network Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-primary" id="total-nodes">0</div>
                            <div class="small text-muted">Nodes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-success" id="total-connections">0</div>
                            <div class="small text-muted">Connections</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-info" id="total-protocols">0</div>
                            <div class="small text-muted">Protocols</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-warning" id="internet-services">0</div>
                            <div class="small text-muted">Internet</div>
                        </div>
                    </div>
                </div>
                
                <!-- Protocol Breakdown -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between small">
                        <span>HTTP/HTTPS:</span>
                        <span id="stat-http" class="text-primary">0</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>SSH:</span>
                        <span id="stat-ssh" class="text-success">0</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Database:</span>
                        <span id="stat-db" class="text-warning">0</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>DNS:</span>
                        <span id="stat-dns" class="text-info">0</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Other:</span>
                        <span id="stat-other" class="text-secondary">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="highlightInternetConnections()">
                    <i class="fas fa-globe me-1"></i>Highlight Internet
                </button>
                <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="highlightSecurityConnections()">
                    <i class="fas fa-shield-alt me-1"></i>Security Focus
                </button>
                <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="highlightHighTraffic()">
                    <i class="fas fa-tachometer-alt me-1"></i>High Traffic
                </button>
                <button class="btn btn-outline-info btn-sm w-100" onclick="analyzeNetworkPaths()">
                    <i class="fas fa-route me-1"></i>Path Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Legend Modal -->
<div class="modal fade" id="legendModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enhanced Network Topology Legend</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Node Types -->
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-circle me-2"></i>Node Types</h6>
                        <div class="legend-item mb-2">
                            <div class="legend-node server-node"></div>
                            <span>Servers (Physical/Virtual)</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-node workstation-node"></div>
                            <span>Workstations/Clients</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-node router-node"></div>
                            <span>Routers/Gateways</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-node internet-node"></div>
                            <span>Internet Services</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-node cloud-node"></div>
                            <span>Cloud Services</span>
                        </div>
                    </div>

                    <!-- Connection Types -->
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-exchange-alt me-2"></i>Connection Types</h6>
                        <div class="legend-item mb-2">
                            <div class="legend-edge http-edge"></div>
                            <span>HTTP/HTTPS</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-edge ssh-edge"></div>
                            <span>SSH/Secure Shell</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-edge db-edge"></div>
                            <span>Database Connections</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-edge vpn-edge"></div>
                            <span>VPN Tunnels</span>
                        </div>
                        <div class="legend-item mb-2">
                            <div class="legend-edge insecure-edge"></div>
                            <span>Insecure Protocols</span>
                        </div>
                    </div>
                </div>

                <!-- Status Indicators -->
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-heartbeat me-2"></i>Status Indicators</h6>
                        <div class="legend-item mb-1">
                            <div class="status-indicator online"></div>
                            <span>Online/Active</span>
                        </div>
                        <div class="legend-item mb-1">
                            <div class="status-indicator warning"></div>
                            <span>Warning/Degraded</span>
                        </div>
                        <div class="legend-item mb-1">
                            <div class="status-indicator offline"></div>
                            <span>Offline/Unreachable</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-eye me-2"></i>Visual Cues</h6>
                        <p class="small mb-1">• Node size indicates connection count</p>
                        <p class="small mb-1">• Edge thickness shows traffic volume</p>
                        <p class="small mb-1">• Dashed lines indicate intermittent connections</p>
                        <p class="small mb-1">• Arrows show connection direction</p>
                        <p class="small mb-1">• Colors group by protocol/service type</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Path Analysis Modal -->
<div class="modal fade" id="pathAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Network Path Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="path-analysis-content">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    z-index: 1000;
}

/* Legend styles */
.legend-node {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 10px;
    border: 2px solid;
}

.server-node {
    background-color: #007bff;
    border-color: #0056b3;
}

.workstation-node {
    background-color: #28a745;
    border-color: #1e7e34;
}

.router-node {
    background-color: #ffc107;
    border-color: #d39e00;
}

.internet-node {
    background-color: #17a2b8;
    border-color: #117a8b;
}

.cloud-node {
    background-color: #6c757d;
    border-color: #495057;
}

.legend-edge {
    width: 30px;
    height: 3px;
    display: inline-block;
    margin-right: 10px;
    position: relative;
    top: -2px;
}

.http-edge {
    background-color: #007bff;
}

.ssh-edge {
    background-color: #28a745;
}

.db-edge {
    background-color: #dc3545;
}

.vpn-edge {
    background-color: #6f42c1;
    background-image: linear-gradient(45deg, transparent 25%, rgba(255,255,255,.5) 25%, rgba(255,255,255,.5) 75%, transparent 75%, transparent);
    background-size: 4px 4px;
}

.insecure-edge {
    background-color: #fd7e14;
    border: 1px dashed #e55a00;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 10px;
}

.status-indicator.online {
    background-color: #28a745;
}

.status-indicator.warning {
    background-color: #ffc107;
}

.status-indicator.offline {
    background-color: #dc3545;
}

.legend-item {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
}

/* Network container enhancements */
#network-container .vis-network {
    outline: none;
}

/* Custom scrollbars for better UI */
.card-body::-webkit-scrollbar {
    width: 6px;
}

.card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
// Global variables for enhanced topology
let network = null;
let nodes = null;
let edges = null;
let allTopologyData = null;
let filteredData = null;
let physicsEnabled = false;
let currentLayout = 'hierarchical';

// Network configuration
const networkOptions = {
    nodes: {
        borderWidth: 2,
        size: 25,
        font: {
            size: 12,
            face: 'Arial',
            color: '#333'
        },
        shadow: {
            enabled: true,
            color: 'rgba(0,0,0,0.3)',
            size: 10,
            x: 2,
            y: 2
        },
        fixed: false,  // Allow manual positioning
        chosen: true   // Show selection feedback
    },
    edges: {
        width: 2,
        shadow: true,
        smooth: {
            enabled: true,
            type: 'continuous',
            roundness: 0.2
        },
        arrows: {
            to: {
                enabled: true,
                scaleFactor: 0.8
            }
        }
    },
    physics: {
        enabled: false,  // Disable physics completely
        stabilization: false
    },
    layout: {
        hierarchical: {
            enabled: true,
            levelSeparation: 300,  // Much larger spacing
            nodeSpacing: 200,      // Much larger spacing
            treeSpacing: 400,      // Much larger spacing
            blockShifting: true,
            edgeMinimization: true,
            parentCentralization: true,
            direction: 'UD',
            sortMethod: 'directed'
        }
    },
    interaction: {
        tooltipDelay: 200,
        hideEdgesOnDrag: false,
        hideNodesOnDrag: false,
        selectConnectedEdges: false,
        dragNodes: true,        // Enable node dragging
        dragView: true,         // Enable canvas dragging
        zoomView: true,         // Enable zooming
        selectConnectedEdges: false
    }
};

// Initialize the enhanced topology
function initializeEnhancedTopology() {
    console.log('Initializing Enhanced Network Topology...');
    
    const container = document.getElementById('network-container');
    if (!container) {
        console.error('Network container not found');
        return;
    }

    // Initialize empty datasets
    nodes = new vis.DataSet([]);
    edges = new vis.DataSet([]);
    
    // Create network
    network = new vis.Network(container, {
        nodes: nodes,
        edges: edges
    }, networkOptions);

    // Event handlers
    network.on('click', handleNetworkClick);
    network.on('hoverNode', handleNodeHover);
    network.on('hoverEdge', handleEdgeHover);
    network.on('selectNode', handleNodeSelect);
    network.on('selectEdge', handleEdgeSelect);
    network.on('deselectAll', clearSelection);

    // Load initial topology data
    refreshTopology();
}

// Load comprehensive topology data
function refreshTopology() {
    const refreshBtn = document.getElementById('refresh-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Show loading state
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }

    // Fetch enhanced network data
    fetch('/api/enhanced_network_data')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.topology) {
                allTopologyData = data.topology;
                processTopologyData();
                updateNetworkVisualization();
                updateStatistics();
            } else {
                throw new Error(data.error || 'Failed to load topology data');
            }
        })
        .catch(error => {
            console.error('Error loading topology:', error);
            showErrorMessage('Failed to load network topology: ' + error.message);
            // Fallback to basic network data
            loadBasicNetworkData();
        })
        .finally(() => {
            // Hide loading state
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync"></i>';
            }
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        });
}

// Fallback to basic network data
function loadBasicNetworkData() {
    fetch('/api/network_data')
        .then(response => response.json())
        .then(data => {
            // Convert basic data to enhanced format
            allTopologyData = convertBasicToEnhanced(data);
            processTopologyData();
            updateNetworkVisualization();
            updateStatistics();
        })
        .catch(error => {
            console.error('Error loading basic network data:', error);
            showErrorMessage('Failed to load any network data');
        });
}

// DEBUG: Direct visualization bypass (for testing)
function debugDirectVisualization() {
    console.log('DEBUG: Attempting direct visualization bypass...');
    
    fetch('/api/enhanced_network_data')
        .then(response => response.json())
        .then(data => {
            console.log('DEBUG: Raw API response:', data);
            
            if (data.success && data.topology) {
                const rawData = data.topology;
                console.log('DEBUG: Raw topology data:', rawData);
                
                // Use raw data directly without any filtering or processing
                const directNodes = rawData.nodes.map((node, index) => ({
                    id: node.id || index,
                    label: node.label || node.ip || 'Node',
                    color: { background: '#97C2FC', border: '#2B7CE9' },
                    size: 25,
                    shape: 'dot'
                }));
                
                const directEdges = rawData.edges.map((edge, index) => ({
                    id: edge.id || `${edge.from}-${edge.to}`,
                    from: edge.from,
                    to: edge.to,
                    color: '#848484',
                    width: 2,
                    arrows: { to: { enabled: true } }
                }));
                
                console.log('DEBUG: Direct vis data prepared:', {
                    nodes: directNodes.length,
                    edges: directEdges.length
                });
                
                // Clear and add directly to vis.js
                if (network && nodes && edges) {
                    nodes.clear();
                    edges.clear();
                    nodes.add(directNodes);
                    edges.add(directEdges);
                    
                    console.log('DEBUG: Data added directly to vis.js');
                    
                    // Fit view
                    setTimeout(() => {
                        network.fit();
                        console.log('DEBUG: Network fitted');
                    }, 500);
                } else {
                    console.error('DEBUG: Network or datasets not initialized');
                }
            }
        })
        .catch(error => {
            console.error('DEBUG: Error in direct visualization:', error);
        });
}

// Convert basic network data to enhanced format
function convertBasicToEnhanced(data) {
    const enhancedTopology = {
        nodes: [],
        edges: [],
        statistics: {}
    };

    // Convert nodes
    data.nodes?.forEach(node => {
        enhancedTopology.nodes.push({
            id: node.id,
            label: node.label || node.ip,
            ip: node.ip,
            type: 'server', // Default type
            subtype: 'unknown',
            status: node.status || 'unknown',
            group: node.group || 'local',
            protocols: [],
            services: [],
            connections: 0,
            metadata: {
                last_seen: node.last_seen
            }
        });
    });

    // Convert edges
    data.edges?.forEach(edge => {
        enhancedTopology.edges.push({
            id: `${edge.from}-${edge.to}`,
            from: edge.from,
            to: edge.to,
            type: 'tcp',
            protocol: edge.protocol || 'tcp',
            port: edge.port,
            label: edge.port ? `:${edge.port}` : '',
            weight: edge.count || 1,
            bandwidth: 'unknown',
            security_level: 'medium',
            metadata: {
                count: edge.count,
                last_seen: edge.last_seen
            }
        });
    });

    return enhancedTopology;
}

// Process and enrich topology data
function processTopologyData() {
    console.log('processTopologyData() called');
    if (!allTopologyData) {
        console.error('No allTopologyData!');
        return;
    }

    console.log('Original topology data:', {
        nodes: allTopologyData.nodes?.length || 0,
        edges: allTopologyData.edges?.length || 0
    });

    // Add computed properties
    allTopologyData.nodes?.forEach(node => {
        // Calculate node size based on connections
        const connections = allTopologyData.edges?.filter(e => 
            e.from === node.id || e.to === node.id
        ).length || 0;
        
        node.size = Math.max(20, Math.min(60, 20 + (connections * 3)));
        node.connections = connections;

        // Determine node shape based on type
        node.shape = getNodeShape(node.type, node.subtype);
        
        // Set node color based on type and status
        node.color = getEnhancedNodeColor(node);
    });

    // Process edges
    allTopologyData.edges?.forEach(edge => {
        // Set edge properties
        edge.color = getProtocolColor(edge.protocol);
        edge.width = Math.max(1, Math.min(8, edge.weight || 1));
        edge.dashes = isInsecureProtocol(edge.protocol);
        
        // Add security indicators
        if (edge.security_level === 'low') {
            edge.color = '#dc3545';
            edge.dashes = true;
        }
    });

    // Apply current filters
    filteredData = applyCurrentFilters(allTopologyData);
    console.log('Filtered data result:', {
        nodes: filteredData?.nodes?.length || 0,
        edges: filteredData?.edges?.length || 0
    });
    
    // Show sample server nodes
    if (filteredData?.nodes) {
        const servers = filteredData.nodes.filter(n => n.type === 'server');
        console.log('Server nodes after filtering:', servers.map(n => `${n.label} (${n.type})`));
    }
}

// Get node shape based on type
function getNodeShape(type, subtype) {
    switch (type) {
        case 'server':
            return subtype === 'database' ? 'database' : 'box';
        case 'workstation':
            return 'dot';
        case 'router':
        case 'gateway':
            return 'diamond';
        case 'internet':
            return 'star';
        case 'cloud':
            return 'ellipse';
        default:
            return 'dot';
    }
}

// Get enhanced node colors
function getEnhancedNodeColor(node) {
    let baseColor, borderColor;

    // Base color by type
    switch (node.type) {
        case 'server':
            baseColor = '#cce5ff';
            borderColor = '#007bff';
            break;
        case 'workstation':
            baseColor = '#d1ecf1';
            borderColor = '#28a745';
            break;
        case 'router':
        case 'gateway':
            baseColor = '#fff3cd';
            borderColor = '#ffc107';
            break;
        case 'internet':
            baseColor = '#d1ecf1';
            borderColor = '#17a2b8';
            break;
        case 'cloud':
            baseColor = '#e9ecef';
            borderColor = '#6c757d';
            break;
        default:
            baseColor = '#f8f9fa';
            borderColor = '#6c757d';
    }

    // Status overlay
    switch (node.status) {
        case 'online':
            borderColor = '#28a745';
            break;
        case 'offline':
            borderColor = '#dc3545';
            baseColor = '#f8d7da';
            break;
        case 'warning':
            borderColor = '#ffc107';
            baseColor = '#fff3cd';
            break;
    }

    return {
        background: baseColor,
        border: borderColor,
        highlight: {
            background: lightenColor(baseColor, 20),
            border: borderColor
        }
    };
}

// Get protocol-specific colors
function getProtocolColor(protocol) {
    const protocolColors = {
        'http': '#007bff',
        'https': '#0056b3',
        'ssh': '#28a745',
        'ftp': '#fd7e14',
        'telnet': '#dc3545',
        'smtp': '#6f42c1',
        'dns': '#17a2b8',
        'mysql': '#e83e8c',
        'postgresql': '#20c997',
        'redis': '#dc3545',
        'mongodb': '#198754',
        'vpn': '#6f42c1',
        'rdp': '#0d6efd',
        'vnc': '#198754'
    };

    return protocolColors[protocol?.toLowerCase()] || '#6c757d';
}

// Check if protocol is insecure
function isInsecureProtocol(protocol) {
    const insecureProtocols = ['telnet', 'ftp', 'http', 'rsh', 'rlogin'];
    return insecureProtocols.includes(protocol?.toLowerCase());
}

// Update network visualization with current data
function updateNetworkVisualization() {
    console.log('updateNetworkVisualization() called');
    console.log('network exists:', !!network);
    console.log('filteredData exists:', !!filteredData);
    
    if (!network) {
        console.error('Network not initialized!');
        return;
    }
    
    if (!filteredData) {
        console.error('No filteredData!');
        return;
    }

    console.log('About to process nodes and edges for vis.js');
    console.log('filteredData.nodes:', filteredData.nodes?.length || 0);
    console.log('filteredData.edges:', filteredData.edges?.length || 0);

    // Prepare nodes for vis.js
    const visNodes = filteredData.nodes.map(node => ({
        id: node.id,
        label: document.getElementById('show-labels')?.checked !== false ? 
               `${node.label}\n${node.ip}` : '',
        title: createNodeTooltip(node),
        shape: node.shape || 'dot',  // Fallback shape
        size: node.size || 25,       // Fallback size
        color: node.color || { background: '#97C2FC', border: '#2B7CE9' },  // Fallback color
        font: {
            size: 11,
            color: '#333'
        }
    }));

    // Prepare edges for vis.js
    const visEdges = filteredData.edges.map(edge => ({
        id: edge.id,
        from: edge.from,
        to: edge.to,
        label: document.getElementById('show-edge-labels')?.checked !== false ? 
               edge.label : '',
        title: createEdgeTooltip(edge),
        color: edge.color || '#848484',
        width: edge.width || 2,
        dashes: edge.dashes || false,
        arrows: { to: { enabled: true } }
    }));

    console.log('Prepared vis data:', {
        visNodes: visNodes.length,
        visEdges: visEdges.length,
        sampleNode: visNodes[0] || 'none',
        sampleEdge: visEdges[0] || 'none'
    });

    // Update datasets - ensure no duplicates
    try {
        // Clear existing data
        nodes.clear();
        edges.clear();
        
        console.log('Cleared existing datasets');
        
        // Check for duplicate IDs before adding
        const nodeIds = new Set();
        const uniqueVisNodes = visNodes.filter(node => {
            if (nodeIds.has(node.id)) {
                console.warn('Duplicate node ID found:', node.id);
                return false;
            }
            nodeIds.add(node.id);
            return true;
        });
        
        const edgeIds = new Set();
        const uniqueVisEdges = visEdges.filter(edge => {
            if (edgeIds.has(edge.id)) {
                console.warn('Duplicate edge ID found:', edge.id);
                return false;
            }
            edgeIds.add(edge.id);
            return true;
        });
        
        console.log('Adding unique data:', {
            nodes: uniqueVisNodes.length,
            edges: uniqueVisEdges.length
        });
        
        // Add unique data
        nodes.add(uniqueVisNodes);
        edges.add(uniqueVisEdges);
        
        console.log('Successfully added nodes and edges to vis.js datasets');
    } catch (error) {
        console.error('Error adding data to vis.js:', error);
        console.error('Error details:', error.message);
        return;
    }

    // Fit network after update
    setTimeout(() => {
        if (network && visNodes.length > 0) {
            console.log('Fitting network to view');
            network.fit({
                animation: {
                    duration: 1000,
                    easingFunction: 'easeInOutQuad'
                }
            });
        } else {
            console.log('Cannot fit network - no nodes or network missing');
        }
    }, 500);
}

// Create detailed node tooltip
function createNodeTooltip(node) {
    const protocols = node.protocols?.join(', ') || 'Unknown';
    const services = node.services?.join(', ') || 'None';
    
    return `${node.label}
IP: ${node.ip}
Type: ${node.type}/${node.subtype}
Status: ${node.status}
Connections: ${node.connections}
Protocols: ${protocols}
Services: ${services}`;
}

// Create detailed edge tooltip
function createEdgeTooltip(edge) {
    return `Connection
Protocol: ${edge.protocol}
Port: ${edge.port}
Weight: ${edge.weight}
Security: ${edge.security_level}
Bandwidth: ${edge.bandwidth}`;
}

// Apply current filter settings
function applyCurrentFilters(topologyData) {
    if (!topologyData) return null;

    let filteredNodes = [...topologyData.nodes];
    let filteredEdges = [...topologyData.edges];

    // Device type filters
    if (!document.getElementById('filter-servers')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'server');
    }
    if (!document.getElementById('filter-workstations')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'workstation');
    }
    if (!document.getElementById('filter-routers')?.checked) {
        filteredNodes = filteredNodes.filter(n => !['router', 'gateway'].includes(n.type));
    }
    if (!document.getElementById('filter-internet')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'internet');
    }
    if (!document.getElementById('filter-cloud')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'cloud');
    }

    // Protocol filters
    const protocolFilters = {
        'http': document.getElementById('protocol-http')?.checked,
        'ssh': document.getElementById('protocol-ssh')?.checked,
        'db': document.getElementById('protocol-db')?.checked,
        'dns': document.getElementById('protocol-dns')?.checked,
        'mail': document.getElementById('protocol-mail')?.checked
    };

    filteredEdges = filteredEdges.filter(edge => {
        const protocol = edge.protocol?.toLowerCase();
        if (protocol?.includes('http') && !protocolFilters.http) return false;
        if (protocol === 'ssh' && !protocolFilters.ssh) return false;
        if (['mysql', 'postgresql', 'mongodb', 'redis'].includes(protocol) && !protocolFilters.db) return false;
        if (protocol === 'dns' && !protocolFilters.dns) return false;
        if (['smtp', 'pop3', 'imap'].includes(protocol) && !protocolFilters.mail) return false;
        return true;
    });

    // Filter edges based on remaining nodes
    const nodeIds = new Set(filteredNodes.map(n => n.id));
    filteredEdges = filteredEdges.filter(edge => 
        nodeIds.has(edge.from) && nodeIds.has(edge.to)
    );

    // Connection threshold filter
    const threshold = parseInt(document.getElementById('connection-threshold')?.value || 1);
    filteredEdges = filteredEdges.filter(edge => (edge.weight || 1) >= threshold);

    return {
        nodes: filteredNodes,
        edges: filteredEdges,
        statistics: topologyData.statistics
    };
}

// Event handlers
function handleNetworkClick(params) {
    if (params.nodes.length > 0) {
        showNodeDetails(params.nodes[0]);
    } else if (params.edges.length > 0) {
        showEdgeDetails(params.edges[0]);
    } else {
        clearInfoPanel();
    }
}

function handleNodeHover(params) {
    // Optional: Could add hover effects
}

function handleEdgeHover(params) {
    // Optional: Could add hover effects
}

function handleNodeSelect(params) {
    if (params.nodes.length > 0) {
        highlightConnectedNodes(params.nodes[0]);
    }
}

function handleEdgeSelect(params) {
    // Could highlight edge path
}

function clearSelection() {
    // Remove any highlights
    updateNetworkVisualization();
}

// Show detailed node information
function showNodeDetails(nodeId) {
    const node = filteredData?.nodes.find(n => n.id === nodeId);
    if (!node) return;

    const connectedEdges = filteredData?.edges.filter(e => 
        e.from === nodeId || e.to === nodeId
    ) || [];

    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;

    infoPanel.innerHTML = `
        <div class="border-start border-primary border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-${getNodeIcon(node.type)} me-2"></i>${node.label}
            </h6>
            <div class="small mb-3">
                <div class="mb-1">
                    <strong>IP:</strong> <code>${node.ip}</code>
                </div>
                <div class="mb-1">
                    <strong>Type:</strong> ${node.type}/${node.subtype}
                </div>
                <div class="mb-1">
                    <strong>Status:</strong> 
                    <span class="badge bg-${getStatusColor(node.status)}">${node.status}</span>
                </div>
                <div class="mb-1">
                    <strong>Connections:</strong> ${connectedEdges.length}
                </div>
                <div class="mb-1">
                    <strong>Protocols:</strong> ${(node.protocols || []).join(', ') || 'None'}
                </div>
                <div class="mb-1">
                    <strong>Services:</strong> ${(node.services || []).join(', ') || 'None'}
                </div>
            </div>
            
            <div class="mb-3">
                <strong class="small">Connected To:</strong>
                <div class="mt-1 small">
                    ${connectedEdges.slice(0, 5).map(edge => {
                        const connectedNode = filteredData?.nodes.find(n => 
                            n.id === (edge.from === nodeId ? edge.to : edge.from)
                        );
                        return `<div class="text-muted">• ${connectedNode?.label || 'Unknown'} (${edge.protocol}:${edge.port})</div>`;
                    }).join('')}
                    ${connectedEdges.length > 5 ? `<div class="text-muted small">... and ${connectedEdges.length - 5} more</div>` : ''}
                </div>
            </div>
            
            <div class="btn-group btn-group-sm w-100">
                <button class="btn btn-outline-primary" onclick="focusOnNode('${nodeId}')">
                    <i class="fas fa-crosshairs"></i> Focus
                </button>
                <button class="btn btn-outline-secondary" onclick="showNodeConnections('${nodeId}')">
                    <i class="fas fa-share-alt"></i> Connections
                </button>
            </div>
        </div>
    `;
}

// Show detailed edge information
function showEdgeDetails(edgeId) {
    const edge = filteredData?.edges.find(e => e.id === edgeId);
    if (!edge) return;

    const fromNode = filteredData?.nodes.find(n => n.id === edge.from);
    const toNode = filteredData?.nodes.find(n => n.id === edge.to);

    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;

    infoPanel.innerHTML = `
        <div class="border-start border-info border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-exchange-alt me-2"></i>Connection Details
            </h6>
            <div class="small mb-3">
                <div class="mb-2">
                    <strong>From:</strong> ${fromNode?.label || 'Unknown'}
                    <br><small class="text-muted">${fromNode?.ip}</small>
                </div>
                <div class="mb-2">
                    <strong>To:</strong> ${toNode?.label || 'Unknown'}
                    <br><small class="text-muted">${toNode?.ip}</small>
                </div>
                <div class="mb-1">
                    <strong>Protocol:</strong> 
                    <span class="badge" style="background-color: ${edge.color}">${edge.protocol}</span>
                </div>
                <div class="mb-1">
                    <strong>Port:</strong> ${edge.port}
                </div>
                <div class="mb-1">
                    <strong>Weight:</strong> ${edge.weight}
                </div>
                <div class="mb-1">
                    <strong>Security Level:</strong> 
                    <span class="badge bg-${getSecurityColor(edge.security_level)}">${edge.security_level}</span>
                </div>
                <div class="mb-1">
                    <strong>Bandwidth:</strong> ${edge.bandwidth}
                </div>
            </div>
            
            <div class="btn-group btn-group-sm w-100">
                <button class="btn btn-outline-primary" onclick="highlightConnection('${edgeId}')">
                    <i class="fas fa-eye"></i> Highlight
                </button>
                <button class="btn btn-outline-secondary" onclick="traceRoute('${edge.from}', '${edge.to}')">
                    <i class="fas fa-route"></i> Trace
                </button>
            </div>
        </div>
    `;
}

// Clear information panel
function clearInfoPanel() {
    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;

    infoPanel.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
            <p class="small">Click on a node or connection to view details</p>
        </div>
    `;
}

// Update network statistics
function updateStatistics() {
    if (!filteredData) return;

    const stats = {
        nodes: filteredData.nodes.length,
        connections: filteredData.edges.length,
        protocols: new Set(filteredData.edges.map(e => e.protocol)).size,
        internetServices: filteredData.nodes.filter(n => n.type === 'internet').length
    };

    // Protocol breakdown
    const protocolCounts = {};
    filteredData.edges.forEach(edge => {
        const protocol = edge.protocol?.toLowerCase();
        if (protocol?.includes('http')) protocolCounts.http = (protocolCounts.http || 0) + 1;
        else if (protocol === 'ssh') protocolCounts.ssh = (protocolCounts.ssh || 0) + 1;
        else if (['mysql', 'postgresql', 'mongodb', 'redis'].includes(protocol)) protocolCounts.db = (protocolCounts.db || 0) + 1;
        else if (protocol === 'dns') protocolCounts.dns = (protocolCounts.dns || 0) + 1;
        else protocolCounts.other = (protocolCounts.other || 0) + 1;
    });

    // Update UI
    document.getElementById('total-nodes').textContent = stats.nodes;
    document.getElementById('total-connections').textContent = stats.connections;
    document.getElementById('total-protocols').textContent = stats.protocols;
    document.getElementById('internet-services').textContent = stats.internetServices;
    
    document.getElementById('stat-http').textContent = protocolCounts.http || 0;
    document.getElementById('stat-ssh').textContent = protocolCounts.ssh || 0;
    document.getElementById('stat-db').textContent = protocolCounts.db || 0;
    document.getElementById('stat-dns').textContent = protocolCounts.dns || 0;
    document.getElementById('stat-other').textContent = protocolCounts.other || 0;
}

// Control functions
function fitNetwork() {
    if (network) {
        network.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

function togglePhysics() {
    physicsEnabled = !physicsEnabled;
    const btn = document.getElementById('physics-btn');
    
    if (network) {
        network.setOptions({ physics: { enabled: physicsEnabled } });
        if (btn) {
            btn.innerHTML = physicsEnabled ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            btn.title = physicsEnabled ? 'Disable Physics' : 'Enable Physics';
        }
    }
}

function changeLayout() {
    const layoutSelect = document.getElementById('layout-select');
    if (!layoutSelect || !network) return;

    currentLayout = layoutSelect.value;
    let layoutOptions = {};

    switch (currentLayout) {
        case 'hierarchical':
            layoutOptions = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        levelSeparation: 150,
                        nodeSpacing: 100,
                        treeSpacing: 200,
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: true,
                        direction: 'UD',
                        sortMethod: 'directed'
                    }
                }
            };
            break;
        case 'force':
            layoutOptions = {
                layout: { hierarchical: { enabled: false } },
                physics: {
                    enabled: true,
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 120
                    }
                }
            };
            break;
        case 'circular':
            layoutOptions = {
                layout: { hierarchical: { enabled: false } },
                physics: { enabled: false }
            };
            // Custom circular positioning would need to be implemented
            break;
        case 'grid':
            layoutOptions = {
                layout: { hierarchical: { enabled: false } },
                physics: { enabled: false }
            };
            // Custom grid positioning would need to be implemented
            break;
    }

    network.setOptions(layoutOptions);
}

function applyFilters() {
    if (!allTopologyData) return;
    
    filteredData = applyCurrentFilters(allTopologyData);
    updateNetworkVisualization();
    updateStatistics();
}

function resetFilters() {
    // Reset all filter controls
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    document.getElementById('time-range').value = '24';
    document.getElementById('connection-threshold').value = '1';
    document.getElementById('threshold-value').textContent = '1';
    
    applyFilters();
}

function updateConnectionThreshold(value) {
    document.getElementById('threshold-value').textContent = value;
}

function toggleLabels() {
    updateNetworkVisualization();
}

function toggleEdgeLabels() {
    updateNetworkVisualization();
}

function showLegend() {
    const modal = new bootstrap.Modal(document.getElementById('legendModal'));
    modal.show();
}

function exportTopology() {
    if (!allTopologyData) return;
    
    const dataStr = JSON.stringify(allTopologyData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `network-topology-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
}

// Quick action functions
function highlightInternetConnections() {
    // Highlight all internet-bound connections
    // Implementation would modify edge colors/styles
}

function highlightSecurityConnections() {
    // Highlight insecure connections
    // Implementation would identify and highlight insecure protocols
}

function highlightHighTraffic() {
    // Highlight high-traffic connections
    // Implementation would highlight edges with high weight
}

function analyzeNetworkPaths() {
    // Open network path analysis modal
    const modal = new bootstrap.Modal(document.getElementById('pathAnalysisModal'));
    modal.show();
    
    // Populate with path analysis data
    // Implementation would analyze network paths and security
}

// Utility functions
function getNodeIcon(type) {
    const icons = {
        'server': 'server',
        'workstation': 'desktop',
        'router': 'route',
        'gateway': 'door-open',
        'internet': 'globe',
        'cloud': 'cloud'
    };
    return icons[type] || 'circle';
}

function getStatusColor(status) {
    const colors = {
        'online': 'success',
        'offline': 'danger',
        'warning': 'warning',
        'unknown': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getSecurityColor(level) {
    const colors = {
        'high': 'success',
        'medium': 'warning',
        'low': 'danger'
    };
    return colors[level] || 'secondary';
}

function lightenColor(color, percent) {
    // Simple color lightening function
    // Implementation would lighten hex color by percentage
    return color;
}

function showErrorMessage(message) {
    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;
    
    infoPanel.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedTopology();
    
    // Auto-refresh every 60 seconds
    setInterval(refreshTopology, 60000);
});

// Handle window resize
window.addEventListener('resize', function() {
    if (network) {
        network.redraw();
        setTimeout(() => network.fit(), 100);
    }
});
</script>
{% endblock %}
