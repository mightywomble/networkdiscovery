{% extends "base_patternfly.html" %}

{% block title %}Host Management - Home Lab{% endblock %}

{% block breadcrumb %}
<li class="pf-c-breadcrumb__item">
    <a href="{{ url_for('index') }}" class="pf-c-breadcrumb__link">Home</a>
</li>
<li class="pf-c-breadcrumb__item pf-m-current" aria-current="page">
    <span class="pf-c-breadcrumb__item-divider">
        <i class="fas fa-angle-right" aria-hidden="true"></i>
    </span>
    Host Management
</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="pf-c-page__main-section pf-m-light nm-page-header">
    <div class="pf-c-content">
        <h1>
            <i class="fas fa-server pf-u-mr-sm"></i>
            Host Management
        </h1>
        <p>Add and configure hosts for comprehensive network monitoring and analysis</p>
    </div>
</section>

<section class="pf-c-page__main-section">
    {% if hosts %}
    <!-- Statistics Overview -->
    {% include "unified_stats_cards.html" %}
    
    <!-- Configured Hosts Section -->
    <div class="pf-c-card nm-hosts-list-card">
        <div class="pf-c-card__header">
            <div class="pf-c-card__header-main">
                <h2 class="pf-c-card__title">
                    <i class="fas fa-list pf-u-mr-sm"></i>
                    Configured Hosts ({{ hosts|length }})
                </h2>
            </div>
            <div class="pf-c-card__actions">
                <div class="pf-c-button-group" role="group">
                    <button class="pf-c-button pf-m-primary pf-m-small" onclick="showAddHostModal()">
                        <i class="fas fa-plus pf-u-mr-sm"></i>Add Host
                    </button>
                    {% if hosts %}
                    <button class="pf-c-button pf-m-secondary pf-m-small" onclick="testAllHosts()">
                        <i class="fas fa-heartbeat pf-u-mr-sm"></i>Test All
                    </button>
                    <button class="pf-c-button pf-m-secondary pf-m-small" onclick="backupHosts()">
                        <i class="fas fa-download pf-u-mr-sm"></i>Backup
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="pf-c-card__body">
            {% if hosts %}
                <!-- Host Cards Grid -->
                <div class="pf-l-gallery pf-m-gutter" id="hosts-grid">
                    {% for host in hosts %}
                    <div class="pf-c-card nm-host-card" id="host-card-{{ host.id }}" data-host-id="{{ host.id }}">
                        <div class="pf-c-card__header">
                            <div class="pf-c-card__header-main">
                                <div class="pf-u-display-flex pf-u-align-items-center">
                                    <div class="nm-host-icon pf-u-mr-sm">
                                        <i class="fas fa-server pf-u-primary-color-100"></i>
                                    </div>
                                    <div>
                                        <h3 class="pf-c-card__title pf-u-font-size-lg pf-u-mb-0">{{ host.name }}</h3>
                                        <div class="pf-u-font-size-sm pf-u-color-200">
                                            <code class="pf-c-code pf-m-inline">{{ host.ip_address }}</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pf-c-card__actions">
                                <span class="pf-c-label nm-status-label status-{{ host.status or 'unknown' }}" id="status-label-{{ host.id }}">
                                    <span class="pf-c-label__content" id="status-{{ host.id }}">
                                        {% if host.status == 'online' %}
                                            <i class="fas fa-check-circle pf-u-mr-xs"></i>Online
                                        {% elif host.status == 'offline' %}
                                            <i class="fas fa-times-circle pf-u-mr-xs"></i>Offline
                                        {% elif host.status == 'ping_only' %}
                                            <i class="fas fa-exclamation-circle pf-u-mr-xs"></i>Ping Only
                                        {% else %}
                                            <i class="fas fa-question-circle pf-u-mr-xs"></i>Unknown
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="pf-c-card__body">
                            {% if host.description %}
                            <div class="pf-u-mb-sm">
                                <div class="pf-u-font-size-sm pf-u-color-200">{{ host.description }}</div>
                            </div>
                            {% endif %}
                            
                            <div class="pf-l-grid pf-m-all-6-col-on-md pf-m-gutter">
                                <div class="pf-l-grid__item">
                                    <div class="pf-u-font-size-sm pf-u-mb-xs">
                                        <i class="fas fa-user pf-u-mr-xs pf-u-color-200"></i>
                                        <strong>SSH:</strong> {{ host.username }}:{{ host.ssh_port }}
                                    </div>
                                    <div class="pf-u-font-size-sm pf-u-mb-xs">
                                        <i class="fas fa-clock pf-u-mr-xs pf-u-color-200"></i>
                                        <strong>Last seen:</strong> 
                                        {% if host.last_seen %}
                                            {{ host.last_seen.strftime('%m/%d %H:%M') }}
                                        {% else %}
                                            <span class="pf-u-color-200">Never</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="pf-l-grid__item">
                                    <div class="pf-u-font-size-sm pf-u-mb-xs">
                                        <i class="fas fa-calendar pf-u-mr-xs pf-u-color-200"></i>
                                        <strong>Added:</strong> 
                                        {% if host.created_at %}
                                            {% if host.created_at %}{{ (host.created_at|string)[:10] }}{% else %}Unknown{% endif %}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pf-c-card__footer">
                            <div class="pf-c-button-group" role="group">
                                <button class="pf-c-button pf-m-secondary pf-m-small" onclick="testHost({{ host.id }})" 
                                        title="Test Connection" id="test-btn-{{ host.id }}">
                                    <i class="fas fa-heartbeat pf-u-mr-xs"></i>Test
                                </button>
                                <button class="pf-c-button pf-m-primary pf-m-small" onclick="openHostEditModal({{ host.id }})" 
                                        title="Edit Host">
                                    <i class="fas fa-cog pf-u-mr-xs"></i>Edit
                                </button>
                                <button class="pf-c-button pf-m-danger pf-m-small" onclick="showRemoveHostCard({{ host.id }}, '{{ host.name }}')" 
                                        title="Remove Host">
                                    <i class="fas fa-trash pf-u-mr-xs"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="pf-c-empty-state pf-m-lg">
                    <div class="pf-c-empty-state__content">
                        <i class="fas fa-server pf-c-empty-state__icon" aria-hidden="true"></i>
                        <h2 class="pf-c-title pf-m-lg">No hosts configured</h2>
                        <div class="pf-c-empty-state__body">
                            Add your first host to start monitoring your network infrastructure. Hosts can be servers, routers, switches, or any device with SSH access.
                        </div>
                        <button class="pf-c-button pf-m-primary" onclick="showAddHostModal()">
                            <i class="fas fa-plus pf-u-mr-sm"></i>
                            Add Your First Host
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    {% endif %}
</section>

<!-- Add Host Modal -->
<div class="pf-c-backdrop" id="addHostModal" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="add-host-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeAddHostModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="add-host-title">
                    <i class="fas fa-plus pf-u-mr-sm"></i>
                    Add New Host
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <form id="addHostForm" class="pf-c-form">
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="modal-name">
                                <span class="pf-c-form__label-text">Host Name</span>
                                <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="modal-name" name="name" 
                                   placeholder="e.g., Web Server 1" required>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">A friendly name for this host</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="modal-ip_address">
                                <span class="pf-c-form__label-text">IP Address</span>
                                <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="modal-ip_address" name="ip_address" 
                                   placeholder="192.168.1.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">IPv4 address of the host</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="modal-username">
                                <span class="pf-c-form__label-text">SSH Username</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="modal-username" name="username" 
                                   value="root" placeholder="root">
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">Username for SSH connections</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="modal-ssh_port">
                                <span class="pf-c-form__label-text">SSH Port</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="number" id="modal-ssh_port" name="ssh_port" 
                                   value="22" min="1" max="65535">
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">SSH port (default: 22)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="modal-description">
                                <span class="pf-c-form__label-text">Description</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <textarea class="pf-c-form-control" id="modal-description" name="description" rows="3"
                                      placeholder="Optional description of this host"></textarea>
                        </div>
                    </div>
                    
                    <div class="pf-c-divider pf-u-my-md"></div>
                    
                    <div class="pf-c-alert pf-m-info pf-m-inline" aria-label="Info alert">
                        <div class="pf-c-alert__icon">
                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                        </div>
                        <div class="pf-c-alert__title">Prerequisites</div>
                        <div class="pf-c-alert__description">
                            <ul class="pf-c-list pf-m-plain pf-u-mb-0">
                                <li>SSH access must be configured</li>
                                <li>Passwordless authentication (keys) required</li>
                                <li>Host must be reachable from this server</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-primary" type="button" onclick="submitAddHostForm()">
                    <i class="fas fa-plus pf-u-mr-sm"></i>
                    Add Host
                </button>
                <button class="pf-c-button pf-m-link" type="button" onclick="closeAddHostModal()">Cancel</button>
            </footer>
        </div>
    </div>
</div>

<!-- Remove Host Options Modal -->
<div class="pf-c-backdrop" id="removeHostOptionsModal" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="remove-options-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeRemoveHostOptionsModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="remove-options-title">
                    <i class="fas fa-trash pf-u-mr-sm"></i>
                    Remove Hosts
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-c-alert pf-m-warning pf-m-inline" aria-label="Warning alert">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    </div>
                    <div class="pf-c-alert__title">Choose hosts to remove</div>
                    <div class="pf-c-alert__description">
                        Select one or more hosts to remove from your network monitoring. This will permanently delete all associated data.
                    </div>
                </div>
                
                <div class="pf-u-mt-md">
                    <div class="pf-l-gallery pf-m-gutter" id="removeHostsList">
                        <!-- Host cards will be populated here by JavaScript -->
                    </div>
                </div>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-danger" type="button" onclick="confirmRemoveSelectedHosts()" id="removeSelectedBtn" disabled>
                    <i class="fas fa-trash pf-u-mr-sm"></i>
                    Remove Selected Hosts
                </button>
                <button class="pf-c-button pf-m-link" type="button" onclick="closeRemoveHostOptionsModal()">Cancel</button>
            </footer>
        </div>
    </div>
</div>

<!-- Remove Host Confirmation Modal -->
<div class="pf-c-backdrop" id="removeHostModal" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-sm" role="dialog" aria-modal="true" aria-labelledby="remove-host-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeRemoveHostModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="remove-host-title">
                    <i class="fas fa-trash pf-u-mr-sm pf-u-danger-color-100"></i>
                    Remove Host
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-c-alert pf-m-warning pf-m-inline" aria-label="Warning alert">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    </div>
                    <div class="pf-c-alert__title">Warning:</div>
                    <div class="pf-c-alert__description">
                        This will permanently remove the host and all associated data including:
                    </div>
                </div>
                <ul class="pf-c-list pf-u-mt-md">
                    <li>Network scan history</li>
                    <li>Traffic statistics</li>
                    <li>Connection data</li>
                    <li>System information</li>
                </ul>
                <p class="pf-u-mt-md">Are you sure you want to remove <strong id="removeHostName"></strong>?</p>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-link" type="button" onclick="closeRemoveHostModal()">Cancel</button>
                <form method="POST" id="removeHostForm" style="display: inline;">
                    <button type="submit" class="pf-c-button pf-m-danger">
                        <i class="fas fa-trash pf-u-mr-sm"></i>Remove Host
                    </button>
                </form>
            </footer>
        </div>
    </div>
</div>


<!-- Host Import Modal -->
<div class="pf-c-backdrop" id="importHostsModal" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="import-hosts-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeImportHostsModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="import-hosts-title">
                    <i class="fas fa-upload pf-u-mr-sm pf-u-info-color-100"></i>
                    Import Hosts
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-c-alert pf-m-info pf-m-inline" aria-label="Info alert">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                    </div>
                    <div class="pf-c-alert__title">Import hosts from a backup file</div>
                    <div class="pf-c-alert__description">
                        Upload a JSON file previously exported from Home Lab to restore your host configurations.
                    </div>
                </div>
                
                <form id="importHostsForm" enctype="multipart/form-data" class="pf-c-form">
                    <div class="pf-c-form__group pf-u-mt-md">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="importFile">
                                <span class="pf-c-form__label-text">Backup File (JSON)</span>
                                <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="file" id="importFile" accept=".json" required>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">Select a previously exported JSON backup file</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label">
                                <span class="pf-c-form__label-text">Import Mode</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <div class="pf-c-radio">
                                <input class="pf-c-radio__input" type="radio" name="importMode" id="importModeMerge" value="merge" checked>
                                <label class="pf-c-radio__label" for="importModeMerge">
                                    <strong>Merge</strong> - Add new hosts and update existing ones
                                </label>
                            </div>
                            <div class="pf-c-radio">
                                <input class="pf-c-radio__input" type="radio" name="importMode" id="importModeReplace" value="replace">
                                <label class="pf-c-radio__label" for="importModeReplace">
                                    <strong>Replace</strong> - Remove all existing hosts and import new ones
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div id="importValidationResults" style="display: none;">
                    <div class="pf-c-divider pf-u-my-md"></div>
                    <h6 class="pf-u-mb-md"><i class="fas fa-check-circle pf-u-mr-sm"></i>Validation Results</h6>
                    <div id="validationContent">
                        <!-- Validation results will be displayed here -->
                    </div>
                </div>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-link" type="button" onclick="closeImportHostsModal()">Cancel</button>
                <button class="pf-c-button pf-m-secondary" id="validateImportBtn" onclick="validateImportFile()">
                    <i class="fas fa-check pf-u-mr-sm"></i>Validate
                </button>
                <button class="pf-c-button pf-m-primary" id="importHostsBtn" onclick="importHosts()" disabled>
                    <i class="fas fa-upload pf-u-mr-sm"></i>Import Hosts
                </button>
            </footer>
        </div>
    </div>
</div>

<!-- Host Edit Modal -->
<div class="pf-c-backdrop" id="hostEditModal" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="edit-host-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeHostEditModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="edit-host-title">
                    <i class="fas fa-edit pf-u-mr-sm pf-u-primary-color-100"></i>
                    Edit Host
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <form id="hostEditForm" class="pf-c-form">
                    <input type="hidden" id="editHostId" value="">
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostName">
                                <span class="pf-c-form__label-text">Host Name</span>
                                <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="editHostName" placeholder="Enter host name" required>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">A friendly name for this host</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostIpAddress">
                                <span class="pf-c-form__label-text">IP Address</span>
                                <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="editHostIpAddress" placeholder="192.168.1.100" required>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">IPv4 address of the host</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostDeviceType">
                                <span class="pf-c-form__label-text">Device Type</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <select class="pf-c-form-control" id="editHostDeviceType">
                                <option value="server">üñ•Ô∏è Server - Physical and virtual servers</option>
                                <option value="router">üì° Router - Network routing devices</option>
                                <option value="switch">üîó Switch - Network switching devices</option>
                                <option value="cloud">‚òÅÔ∏è Cloud - Cloud services and external resources</option>
                                <option value="vpn">üõ°Ô∏è VPN - VPN endpoints and tunnels</option>
                                <option value="workstation">üíª Workstation - Client computers</option>
                                <option value="firewall">üî• Firewall - Network security devices</option>
                                <option value="gateway">üö™ Gateway - Network gateway devices</option>
                            </select>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">This determines the icon shown in network diagrams</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostUsername">
                                <span class="pf-c-form__label-text">SSH Username</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="text" id="editHostUsername" placeholder="root">
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">Username for SSH connections</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostSshPort">
                                <span class="pf-c-form__label-text">SSH Port</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input class="pf-c-form-control" type="number" id="editHostSshPort" min="1" max="65535" value="22">
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">SSH port (default: 22)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label">
                            <label class="pf-c-form__label" for="editHostDescription">
                                <span class="pf-c-form__label-text">Description</span>
                            </label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <textarea class="pf-c-form-control" id="editHostDescription" rows="3" placeholder="Optional description of this host..."></textarea>
                            <div class="pf-c-form__helper-text">
                                <div class="pf-c-helper-text">
                                    <div class="pf-c-helper-text__item pf-m-dynamic">
                                        <span class="pf-c-helper-text__item-text">Optional notes about this host</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-link" type="button" onclick="closeHostEditModal()">Cancel</button>
                <button class="pf-c-button pf-m-primary" type="button" onclick="saveHostChanges()">Save Changes</button>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Host Management Card Aesthetics */
.nm-action-card {
    border: 1px solid var(--pf-global--BorderColor--100);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
    min-height: 200px;
}

.nm-action-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.nm-remove-card {
    border-left: 4px solid var(--pf-global--danger-color--100);
}

.nm-remove-card:hover {
    border-left-color: var(--pf-global--danger-color--200);
}

.nm-import-card {
    border-left: 4px solid var(--pf-global--info-color--100);
}

.nm-import-card:hover {
    border-left-color: var(--pf-global--info-color--200);
}

.nm-action-card .pf-c-card__title {
    color: var(--pf-global--Color--100);
}

.nm-remove-card .pf-c-card__title i {
    color: var(--pf-global--danger-color--100);
}

.nm-import-card .pf-c-card__title i {
    color: var(--pf-global--info-color--100);
}

/* Modal Enhancements */
.pf-c-modal-box {
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

/* Remove host selection cards */
.nm-remove-host-selection-card {
    border: 2px solid var(--pf-global--BorderColor--100);
    cursor: pointer;
    transition: all 0.2s ease;
}

.nm-remove-host-selection-card:hover {
    border-color: var(--pf-global--danger-color--100);
    box-shadow: 0 2px 8px rgba(201, 25, 11, 0.2);
}

.nm-remove-host-selection-card.selected {
    border-color: var(--pf-global--danger-color--100);
    background-color: var(--pf-global--danger-color--100);
    color: var(--pf-global--Color--light-100);
    box-shadow: 0 2px 8px rgba(201, 25, 11, 0.3);
}

.nm-remove-host-selection-card.selected .pf-c-card__title,
.nm-remove-host-selection-card.selected .pf-u-color-200 {
    color: var(--pf-global--Color--light-100) !important;
}

/* Host Management Card Aesthetics */
.nm-host-form-card {
    border-left: 4px solid var(--pf-global--primary-color--100);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.nm-host-form-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.nm-hosts-list-card {
    border-left: 4px solid var(--pf-global--info-color--100);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.nm-hosts-list-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.nm-stats-card {
    border-left: 4px solid var(--pf-global--warning-color--100);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.nm-stats-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

/* Individual Host Cards */
.nm-host-card {
    border: 1px solid var(--pf-global--BorderColor--100);
    border-left: 4px solid var(--pf-global--primary-color--100);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
    min-height: 280px;
    position: relative;
}

.nm-host-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
    border-left-color: var(--pf-global--primary-color--200);
}

.nm-host-card .nm-host-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--pf-global--BackgroundColor--200);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

/* Status Labels */
.nm-status-label.status-online {
    --pf-c-label--BackgroundColor: var(--pf-global--success-color--100);
    --pf-c-label__content--Color: var(--pf-global--Color--light-100);
}

.nm-status-label.status-offline {
    --pf-c-label--BackgroundColor: var(--pf-global--danger-color--100);
    --pf-c-label__content--Color: var(--pf-global--Color--light-100);
}

.nm-status-label.status-ping_only {
    --pf-c-label--BackgroundColor: var(--pf-global--warning-color--100);
    --pf-c-label__content--Color: var(--pf-global--Color--dark-100);
}

.nm-status-label.status-unknown {
    --pf-c-label--BackgroundColor: var(--pf-global--Color--200);
    --pf-c-label__content--Color: var(--pf-global--Color--dark-100);
}

/* Statistics Cards */
.nm-stat-card {
    border: 1px solid var(--pf-global--BorderColor--100);
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    transition: all 0.2s ease;
    min-height: 120px;
}

.nm-stat-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    transform: translateY(-1px);
}

/* Form Enhancements */
.pf-c-form-control:focus {
    border-color: var(--pf-global--primary-color--100);
    box-shadow: 0 0 0 0.125rem rgba(6, 102, 204, 0.25);
}

/* Button Hover Effects */
.pf-c-button.pf-m-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(6, 102, 204, 0.3);
}

.pf-c-button.pf-m-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.pf-c-button.pf-m-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(201, 25, 11, 0.3);
}

/* Gallery Grid Enhancements */
.pf-l-gallery {
    --pf-l-gallery--GridTemplateColumns--min: 300px;
}

/* Host Card Footer Styling */
.nm-host-card .pf-c-card__footer {
    background-color: var(--pf-global--BackgroundColor--200);
    border-top: 1px solid var(--pf-global--BorderColor--100);
    padding: var(--pf-global--spacer--sm) var(--pf-global--spacer--md);
}

/* Empty State Enhancements */
.pf-c-empty-state__icon {
    color: var(--pf-global--Color--200);
    font-size: 4rem;
    margin-bottom: var(--pf-global--spacer--lg);
}

/* Alert Enhancements */
.pf-c-alert.pf-m-inline {
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    border-radius: var(--pf-global--BorderRadius--sm);
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .nm-host-card {
        min-height: auto;
    }
    
    .pf-l-gallery {
        --pf-l-gallery--GridTemplateColumns--min: 280px;
    }
    
    .nm-host-form-card,
    .nm-hosts-list-card,
    .nm-stats-card {
        margin-bottom: var(--pf-global--spacer--md);
    }
}

/* Card Header Icon Styling */
.pf-c-card__title i {
    color: var(--pf-global--primary-color--100);
}

/* Form Group Spacing */
.pf-c-form__group {
    margin-bottom: var(--pf-global--spacer--md);
}

/* Button Group Spacing */
.pf-c-button-group .pf-c-button:not(:last-child) {
    margin-right: var(--pf-global--spacer--xs);
}

/* Progress Animation for Loading States */
@keyframes nm-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.nm-loading {
    animation: nm-pulse 1.5s ease-in-out infinite;
}

/* Code Block Styling */
.pf-c-code.pf-m-inline {
    background-color: var(--pf-global--BackgroundColor--300);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function testHost(hostId) {
    const testBtn = document.getElementById(`test-btn-${hostId}`);
    const statusElement = document.getElementById(`status-${hostId}`);
    
    // Show loading state
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    
    // Call the API to test connectivity
    fetch(`/api/test_host/${hostId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-heartbeat"></i>';
        
        if (data.success) {
            // Update status based on test results
            let statusHtml = '';
            let statusClass = '';
            
            switch (data.status) {
                case 'online':
                    statusHtml = '<i class="fas fa-check-circle text-success"></i> Online';
                    statusClass = 'status-online';
                    break;
                case 'ping_only':
                    statusHtml = '<i class="fas fa-exclamation-triangle text-warning"></i> Ping Only';
                    statusClass = 'status-ping_only';
                    break;
                case 'offline':
                    statusHtml = '<i class="fas fa-times-circle text-danger"></i> Offline';
                    statusClass = 'status-offline';
                    break;
                default:
                    statusHtml = '<i class="fas fa-question-circle text-secondary"></i> Unknown';
                    statusClass = 'status-unknown';
            }
            
            statusElement.innerHTML = statusHtml;
            statusElement.className = statusClass;
            
            // Show detailed results in console for debugging
            console.log(`Host ${data.host_name} (${data.ip_address}):`, {
                status: data.status,
                ping: data.ping_success,
                ssh: data.ssh_success
            });
            
            // Optional: Show a brief success message
            if (data.status === 'online') {
                console.log(`‚úÖ ${data.host_name}: Both ping and SSH successful`);
            } else if (data.status === 'ping_only') {
                console.log(`‚ö†Ô∏è ${data.host_name}: Ping successful, SSH failed`);
            } else {
                console.log(`‚ùå ${data.host_name}: Both ping and SSH failed`);
            }
        } else {
            // Handle API error
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Test Failed';
            console.error('Host test failed:', data.error);
        }
    })
    .catch(error => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-heartbeat"></i>';
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Error';
        console.error('Error testing host connectivity:', error);
    });
}

function testAllHosts() {
    const hosts = {{ hosts|map(attribute='id')|list }};
    
    hosts.forEach(hostId => {
        setTimeout(() => testHost(hostId), Math.random() * 1000);
    });
}

function confirmRemoveHost(hostId, hostName) {
    const modal = document.getElementById('removeHostModal');
    const form = document.getElementById('removeHostForm');
    const nameElement = document.getElementById('removeHostName');
    
    nameElement.textContent = hostName;
    form.action = `/remove_host/${hostId}`;
    
    modal.hidden = false;
}

function closeRemoveHostModal() {
    const modal = document.getElementById('removeHostModal');
    modal.hidden = true;
}


// Form validation
document.getElementById('ip_address').addEventListener('input', function(e) {
    const value = e.target.value;
    const isValid = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(value);
    
    if (value && !isValid) {
        e.target.setCustomValidity('Please enter a valid IPv4 address');
    } else {
        e.target.setCustomValidity('');
    }
});

// Auto-focus first input when not in modal
if (document.getElementById('name')) {
    document.getElementById('name').focus();
}

// ====================================================
// ADD HOST MODAL FUNCTIONALITY
// ====================================================

// Show add host modal
function showAddHostModal() {
    const modal = document.getElementById('addHostModal');
    modal.hidden = false;
    
    // Reset form
    document.getElementById('addHostForm').reset();
    document.getElementById('modal-username').value = 'root';
    document.getElementById('modal-ssh_port').value = '22';
    
    // Focus first input
    setTimeout(() => {
        document.getElementById('modal-name').focus();
    }, 100);
}

// Close add host modal
function closeAddHostModal() {
    const modal = document.getElementById('addHostModal');
    modal.hidden = true;
}

// Submit add host form
function submitAddHostForm() {
    const form = document.getElementById('addHostForm');
    const formData = new FormData(form);
    
    // Create a hidden form to submit
    const submitForm = document.createElement('form');
    submitForm.method = 'POST';
    submitForm.action = '{{ url_for("add_host") }}';
    submitForm.style.display = 'none';
    
    // Add form data to hidden form
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        submitForm.appendChild(input);
    }
    
    document.body.appendChild(submitForm);
    submitForm.submit();
}

// Form validation for modal
document.getElementById('modal-ip_address').addEventListener('input', function(e) {
    const value = e.target.value;
    const isValid = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(value);
    
    if (value && !isValid) {
        e.target.setCustomValidity('Please enter a valid IPv4 address');
    } else {
        e.target.setCustomValidity('');
    }
});

// ====================================================
// REMOVE HOST OPTIONS FUNCTIONALITY
// ====================================================

let selectedHostsForRemoval = new Set();

// Show remove host options modal
function showRemoveHostOptions() {
    const modal = document.getElementById('removeHostOptionsModal');
    const hostsList = document.getElementById('removeHostsList');
    
    // Clear previous selections
    selectedHostsForRemoval.clear();
    
    // Get all hosts
    const hosts = {{ hosts|tojson }};
    
    // Generate host selection cards
    let cardsHtml = '';
    hosts.forEach(host => {
        cardsHtml += `
            <div class="pf-c-card nm-remove-host-selection-card pf-m-compact" 
                 onclick="toggleHostSelection(${host.id}, '${host.name}')"
                 id="remove-card-${host.id}">
                <div class="pf-c-card__body pf-u-p-sm">
                    <div class="pf-u-display-flex pf-u-align-items-center pf-u-justify-content-space-between">
                        <div>
                            <h4 class="pf-c-card__title pf-u-font-size-md pf-u-mb-xs">${host.name}</h4>
                            <div class="pf-u-font-size-sm pf-u-color-200">
                                <code class="pf-c-code pf-m-inline">${host.ip_address}</code>
                            </div>
                        </div>
                        <div class="pf-u-font-size-lg">
                            <i class="fas fa-square-check" style="display: none;" id="check-${host.id}"></i>
                            <i class="far fa-square" id="uncheck-${host.id}"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    hostsList.innerHTML = cardsHtml;
    modal.hidden = false;
    updateRemoveButton();
}

// Close remove host options modal
function closeRemoveHostOptionsModal() {
    const modal = document.getElementById('removeHostOptionsModal');
    modal.hidden = true;
    selectedHostsForRemoval.clear();
}

// Toggle host selection for removal
function toggleHostSelection(hostId, hostName) {
    const card = document.getElementById(`remove-card-${hostId}`);
    const checkIcon = document.getElementById(`check-${hostId}`);
    const uncheckIcon = document.getElementById(`uncheck-${hostId}`);
    
    if (selectedHostsForRemoval.has(hostId)) {
        // Deselect
        selectedHostsForRemoval.delete(hostId);
        card.classList.remove('selected');
        checkIcon.style.display = 'none';
        uncheckIcon.style.display = 'inline';
    } else {
        // Select
        selectedHostsForRemoval.add(hostId);
        card.classList.add('selected');
        checkIcon.style.display = 'inline';
        uncheckIcon.style.display = 'none';
    }
    
    updateRemoveButton();
}

// Update remove button state
function updateRemoveButton() {
    const button = document.getElementById('removeSelectedBtn');
    const count = selectedHostsForRemoval.size;
    
    if (count > 0) {
        button.disabled = false;
        button.innerHTML = `<i class="fas fa-trash pf-u-mr-sm"></i>Remove ${count} Host${count > 1 ? 's' : ''}`;
    } else {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-trash pf-u-mr-sm"></i>Remove Selected Hosts';
    }
}

// Confirm removal of selected hosts
function confirmRemoveSelectedHosts() {
    const count = selectedHostsForRemoval.size;
    if (count === 0) return;
    
    const hostIds = Array.from(selectedHostsForRemoval);
    const confirmMessage = `Are you sure you want to remove ${count} host${count > 1 ? 's' : ''}? This will permanently delete all associated data including scan history, traffic statistics, and configuration data.`;
    
    if (confirm(confirmMessage)) {
        // Remove hosts one by one
        hostIds.forEach(hostId => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/remove_host/${hostId}`;
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
        });
        
        closeRemoveHostOptionsModal();
    }
}

// Show remove host card (for individual host removal)
function showRemoveHostCard(hostId, hostName) {
    confirmRemoveHost(hostId, hostName);
}

// ====================================================
// HOST EDIT FUNCTIONALITY
// ====================================================

// Open host edit modal
function openHostEditModal(hostId) {
    // Fetch host details to populate the edit modal
    fetch(`/api/host_stats/${hostId}`)
    .then(response => response.json())
    .then(data => {
        const host = data.host;
        
        // Get device metadata to get device type
        return fetch(`/api/device_metadata/${host.ip_address}`)
        .then(metaResponse => {
            let deviceType = 'server'; // default
            if (metaResponse.ok) {
                return metaResponse.json().then(metaData => {
                    if (metaData.success) {
                        deviceType = metaData.device.device_type || 'server';
                    }
                    return { host, deviceType };
                });
            }
            return { host, deviceType };
        });
    })
    .then(({ host, deviceType }) => {
        // Populate modal fields
        document.getElementById('editHostId').value = host.id;
        document.getElementById('editHostName').value = host.name || '';
        document.getElementById('editHostIpAddress').value = host.ip_address || '';
        document.getElementById('editHostDeviceType').value = deviceType || 'server';
        document.getElementById('editHostUsername').value = host.username || 'root';
        document.getElementById('editHostSshPort').value = host.ssh_port || 22;
        document.getElementById('editHostDescription').value = host.description || '';
        
        // Show modal
        const modal = document.getElementById('hostEditModal');
        modal.hidden = false;
    })
    .catch(error => {
        console.error('Error loading host details:', error);
        showMessage('Failed to load host details for editing', 'error');
    });
}

// Save host changes
function saveHostChanges() {
    const hostId = document.getElementById('editHostId').value;
    const hostName = document.getElementById('editHostName').value.trim();
    const hostIpAddress = document.getElementById('editHostIpAddress').value.trim();
    const deviceType = document.getElementById('editHostDeviceType').value;
    const username = document.getElementById('editHostUsername').value.trim();
    const sshPort = parseInt(document.getElementById('editHostSshPort').value);
    const description = document.getElementById('editHostDescription').value.trim();
    
    // Validation
    if (!hostId) {
        showMessage('Host ID is missing!', 'error');
        return;
    }
    
    if (!hostName) {
        showMessage('Host name is required!', 'warning');
        return;
    }
    
    if (!hostIpAddress) {
        showMessage('IP address is required!', 'warning');
        return;
    }
    
    // Validate IP address format
    const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
    if (!ipRegex.test(hostIpAddress)) {
        showMessage('Please enter a valid IPv4 address!', 'warning');
        return;
    }
    
    if (!username) {
        showMessage('SSH username is required!', 'warning');
        return;
    }
    
    if (!sshPort || sshPort < 1 || sshPort > 65535) {
        showMessage('SSH port must be between 1 and 65535!', 'warning');
        return;
    }
    
    // Prepare update data
    const updateData = {
        host_id: hostId,
        name: hostName,
        ip_address: hostIpAddress,
        username: username,
        ssh_port: sshPort,
        description: description
    };
    
    // Save host changes to server
    fetch('/api/update_host', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Also save device metadata for device type
            const deviceUpdateData = {
                device_id: hostIpAddress, // Use IP as device ID
                label: hostName,
                device_type: deviceType,
                notes: description,
                ip: hostIpAddress
            };
            
            return fetch('/api/update_device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(deviceUpdateData)
            })
            .then(response => response.json())
            .then(deviceData => {
                if (deviceData.success) {
                    console.log('Device metadata updated successfully');
                } else {
                    console.warn('Host updated but device metadata update failed:', deviceData.error);
                }
                
                // Hide modal
                closeHostEditModal();
                
                showMessage('Host updated successfully!', 'success');
                
                // Refresh the page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
                return data;
            });
        } else {
            throw new Error(data.error || 'Failed to update host');
        }
    })
    .catch(error => {
        console.error('Error updating host:', error);
        showMessage(`Failed to update host: ${error.message}`, 'error');
    });
}

// Utility function to show messages
function showMessage(message, type = 'info') {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'info' ? 'primary' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show position-fixed`;
    messageDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    document.body.appendChild(messageDiv);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 4000);
}

// Format bytes utility function
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ====================================================
// BACKUP AND IMPORT FUNCTIONALITY
// ====================================================

// Backup all hosts to JSON file
function backupHosts() {
    showMessage('Preparing hosts backup...', 'info');
    
    // Download the backup file
    const link = document.createElement('a');
    link.href = '/api/backup_hosts';
    link.download = `networkmap_hosts_backup_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_')}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage('Hosts backup downloaded successfully!', 'success');
}

// Show import modal
function showImportModal() {
    // Reset form and validation results
    document.getElementById('importHostsForm').reset();
    document.getElementById('importValidationResults').style.display = 'none';
    document.getElementById('importHostsBtn').disabled = true;
    
    const modal = document.getElementById('importHostsModal');
    modal.hidden = false;
}

function closeImportHostsModal() {
    const modal = document.getElementById('importHostsModal');
    modal.hidden = true;
}


function closeHostEditModal() {
    const modal = document.getElementById('hostEditModal');
    modal.hidden = true;
}

// Validate import file before importing
function validateImportFile() {
    const fileInput = document.getElementById('importFile');
    const validateBtn = document.getElementById('validateImportBtn');
    const importBtn = document.getElementById('importHostsBtn');
    const validationResults = document.getElementById('importValidationResults');
    const validationContent = document.getElementById('validationContent');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('Please select a backup file first', 'warning');
        return;
    }
    
    const file = fileInput.files[0];
    
    // Show loading state
    validateBtn.disabled = true;
    validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating...';
    
    // Create FormData to send file
    const formData = new FormData();
    formData.append('file', file);
    
    // Validate the backup file
    fetch('/api/validate_backup', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Reset button state
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="fas fa-check me-1"></i>Validate';
        
        // Show validation results
        validationResults.style.display = 'block';
        
        if (data.valid) {
            validationContent.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Validation Successful!</strong> The backup file is valid and ready to import.
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Backup Information</h6>
                        <table class="table table-sm">
                            ${data.backup_info ? `
                                <tr><th>Created:</th><td>${data.backup_info.timestamp || 'Unknown'}</td></tr>
                                <tr><th>Application:</th><td>${data.backup_info.application || 'Unknown'}</td></tr>
                                <tr><th>Version:</th><td>${data.backup_info.version || 'Unknown'}</td></tr>
                            ` : ''}
                            <tr><th>Total Hosts:</th><td>${data.stats.total_hosts}</td></tr>
                            <tr><th>Valid Hosts:</th><td class="text-success">${data.stats.valid_hosts}</td></tr>
                            ${data.stats.invalid_hosts > 0 ? `<tr><th>Invalid Hosts:</th><td class="text-danger">${data.stats.invalid_hosts}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Import Preview</h6>
                        ${data.warnings.length > 0 ? `
                            <div class="alert alert-warning alert-sm">
                                <strong>Warnings:</strong>
                                <ul class="mb-0 mt-1">
                                    ${data.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <p class="small text-muted">The backup contains ${data.stats.total_hosts} host${data.stats.total_hosts !== 1 ? 's' : ''} ready for import.</p>
                    </div>
                </div>
            `;
            
            // Enable import button
            importBtn.disabled = false;
        } else {
            validationContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Validation Failed!</strong> The backup file contains errors that must be fixed before importing.
                </div>
                <div class="mb-3">
                    <h6>Issues Found:</h6>
                    <ul class="text-danger">
                        ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                </div>
                ${data.host_details && data.host_details.length > 0 ? `
                    <div>
                        <h6>Host Details:</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>IP Address</th>
                                        <th>Status</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.host_details.map(host => `
                                        <tr class="${host.valid ? 'table-success' : 'table-danger'}">
                                            <td>${host.index}</td>
                                            <td>${host.name}</td>
                                            <td><code>${host.ip_address}</code></td>
                                            <td>
                                                <i class="fas fa-${host.valid ? 'check-circle text-success' : 'times-circle text-danger'}"></i>
                                                ${host.valid ? 'Valid' : 'Invalid'}
                                            </td>
                                            <td>
                                                ${host.issues.length > 0 ? `
                                                    <ul class="mb-0">
                                                        ${host.issues.map(issue => `<li class="small">${issue}</li>`).join('')}
                                                    </ul>
                                                ` : 'None'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Keep import button disabled
            importBtn.disabled = true;
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
        
        // Reset button state
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="fas fa-check me-1"></i>Validate';
        
        validationResults.style.display = 'block';
        validationContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Validation Error!</strong> Could not validate the backup file.
                <br><small>${error.message}</small>
            </div>
        `;
        
        importBtn.disabled = true;
        showMessage(`Validation failed: ${error.message}`, 'error');
    });
}

// Import hosts from validated backup file
function importHosts() {
    const fileInput = document.getElementById('importFile');
    const importBtn = document.getElementById('importHostsBtn');
    const importMode = document.querySelector('input[name="importMode"]:checked').value;
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('Please select a backup file first', 'warning');
        return;
    }
    
    // Confirm import, especially for replace mode
    if (importMode === 'replace') {
        if (!confirm('Replace mode will DELETE ALL existing hosts and replace them with the imported ones. This cannot be undone. Are you sure?')) {
            return;
        }
    }
    
    const file = fileInput.files[0];
    
    // Show loading state
    importBtn.disabled = true;
    importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Importing...';
    
    showMessage('Importing hosts, please wait...', 'info');
    
    // Create FormData to send file
    const formData = new FormData();
    formData.append('file', file);
    
    // Import the hosts
    fetch(`/api/import_hosts?mode=${importMode}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is ok, but allow for multi-status responses
        if (response.ok || response.status === 207) {
            return response.json();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP ${response.status}`);
            });
        }
    })
    .then(data => {
        // Reset button state
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Import Hosts';
        
        if (data.success) {
            // Show success message with details
            const successMsg = `Import completed! ${data.results.imported} hosts added, ${data.results.updated} hosts updated${data.results.skipped > 0 ? `, ${data.results.skipped} skipped` : ''}.`;
            showMessage(successMsg, 'success');
            
            // Hide modal
            closeImportHostsModal();
            
            // Show detailed results in console
            console.log('Import completed:', data);
            if (data.results.details && data.results.details.length > 0) {
                console.log('Import details:', data.results.details);
            }
            if (data.results.errors && data.results.errors.length > 0) {
                console.log('Import errors:', data.results.errors);
            }
            
            // Refresh page to show updated hosts
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.error || 'Import failed');
        }
    })
    .catch(error => {
        console.error('Import error:', error);
        
        // Reset button state
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Import Hosts';
        
        showMessage(`Import failed: ${error.message}`, 'error');
    });
}

</script>
{% endblock %}
