{% extends "base.html" %}

{% block title %}Enhanced Topology - Interactive Network Visualization{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-project-diagram me-2"></i>Enhanced Topology</h1>
        <p class="text-muted">Interactive network visualization with full manual control and smooth interactions</p>
    </div>
</div>

<div class="row mb-3">
    <!-- Main Topology Visualization -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Network Infrastructure Map</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" onclick="refreshTopology()" title="Refresh Data" id="refresh-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetZoom()" title="Reset View">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="toggleSimulation()" title="Start Physics" id="physics-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportSVG()" title="Export SVG">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showLegend()" title="Show Legend">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Control Bar -->
                <div class="border-bottom p-2 bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Layout:</label>
                            <select class="form-select form-select-sm" id="layout-select" onchange="changeLayout()">
                                <option value="force">Force Layout</option>
                                <option value="hierarchical">Hierarchical</option>
                                <option value="circular" selected>Circular</option>
                                <option value="grid">Grid</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Node Size:</label>
                            <input type="range" class="form-range" id="node-size-slider" min="5" max="50" value="20" oninput="updateNodeSize(this.value)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Link Distance:</label>
                            <input type="range" class="form-range" id="link-distance-slider" min="50" max="300" value="100" oninput="updateLinkDistance(this.value)">
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="show-labels" checked onchange="toggleLabels()">
                                <label class="form-check-label small" for="show-labels">Show Labels</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- D3 Visualization Container -->
                <div id="d3-network-container" style="height: 650px; position: relative;">
                    <div class="loading-overlay" id="loading-overlay" style="display: none;">
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <div class="text-primary">Loading network topology...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="col-lg-3">
        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small">Device Types:</label>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-servers" checked onchange="applyFilters()">
                        <label class="form-check-label small" for="filter-servers">
                            <i class="fas fa-server text-primary"></i> Servers
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-workstations" checked onchange="applyFilters()">
                        <label class="form-check-label small" for="filter-workstations">
                            <i class="fas fa-desktop text-success"></i> Workstations
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-routers" checked onchange="applyFilters()">
                        <label class="form-check-label small" for="filter-routers">
                            <i class="fas fa-route text-warning"></i> Routers/Gateways
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="filter-internet" checked onchange="applyFilters()">
                        <label class="form-check-label small" for="filter-internet">
                            <i class="fas fa-globe text-info"></i> Internet Services
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="connection-threshold" class="form-label small">Min Connections:</label>
                    <input type="range" class="form-range" id="connection-threshold" min="1" max="20" value="1" oninput="updateConnectionThreshold(this.value)">
                    <small class="text-muted">Threshold: <span id="threshold-value">1</span></small>
                </div>

                <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="resetFilters()">
                    <i class="fas fa-undo me-1"></i>Reset
                </button>
            </div>
        </div>

        <!-- Selected Node Information -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Node Information</h6>
            </div>
            <div class="card-body" id="node-info">
                <div class="text-center text-muted">
                    <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                    <p class="small">Click on a node or connection to view details</p>
                </div>
            </div>
        </div>

        <!-- Network Statistics -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-primary" id="total-nodes">0</div>
                            <div class="small text-muted">Nodes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center border rounded p-2">
                            <div class="h5 mb-0 text-success" id="total-connections">0</div>
                            <div class="small text-muted">Connections</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Legend Modal -->
<div class="modal fade" id="legendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Network Legend</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6>Node Types</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-node server-node me-2"></div>
                            <span class="small">Servers (Blue)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-node workstation-node me-2"></div>
                            <span class="small">Workstations (Green)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-node router-node me-2"></div>
                            <span class="small">Routers (Orange)</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="legend-node internet-node me-2"></div>
                            <span class="small">Internet (Cyan)</span>
                        </div>
                    </div>
                    <div class="col-12">
                        <h6>Interactions</h6>
                        <p class="small mb-1">• Click and drag nodes to move them</p>
                        <p class="small mb-1">• Scroll to zoom in/out</p>
                        <p class="small mb-1">• Click nodes for details</p>
                        <p class="small mb-1">• Drag background to pan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    z-index: 1000;
}

/* D3 Network Styles */
#d3-network-container {
    overflow: hidden;
}

.d3-node {
    cursor: pointer;
    stroke-width: 2px;
}

.d3-node:hover {
    stroke-width: 3px;
}

.d3-node.selected {
    stroke-width: 4px;
    stroke: #ff6b6b;
}

.d3-link {
    stroke: #999;
    stroke-width: 1px;
    stroke-opacity: 0.6;
}

.d3-link.highlighted {
    stroke: #ff6b6b;
    stroke-width: 3px;
    stroke-opacity: 1;
}

.d3-label {
    font-family: Arial, sans-serif;
    font-size: 12px;
    font-weight: bold;
    text-anchor: middle;
    dominant-baseline: central;
    fill: #333;
    pointer-events: none;
    user-select: none;
}

.d3-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1000;
    max-width: 200px;
}

/* Legend styles */
.legend-node {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
}

.server-node {
    background-color: #007bff;
}

.workstation-node {
    background-color: #28a745;
}

.router-node {
    background-color: #fd7e14;
}

.internet-node {
    background-color: #17a2b8;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// D3 Network Topology Implementation
let svg, container, simulation;
let nodes = [], links = [];
let allData = null;
let width, height;
let simulationRunning = false;
let currentLayout = 'circular';

// Color schemes for different node types
const nodeColors = {
    server: '#007bff',
    workstation: '#28a745',
    router: '#fd7e14',
    gateway: '#fd7e14',
    internet: '#17a2b8',
    cloud: '#6c757d'
};

// Initialize D3 network
function initializeD3Network() {
    console.log('Initializing D3 Network...');
    
    const container = d3.select("#d3-network-container");
    const containerNode = container.node();
    
    if (!containerNode) {
        console.error('D3 container not found');
        return;
    }
    
    // Get container dimensions
    const rect = containerNode.getBoundingClientRect();
    width = rect.width;
    height = rect.height;
    
    // Create SVG
    svg = container.append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("background-color", "#f8f9fa");
    
    // Create container group for zooming/panning
    const g = svg.append("g");
    
    // Add zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });
    
    svg.call(zoom);
    
    // Create groups for links and nodes
    const linkGroup = g.append("g").attr("class", "links");
    const nodeGroup = g.append("g").attr("class", "nodes");
    const labelGroup = g.append("g").attr("class", "labels");
    
    // Create simulation with physics disabled by default for manual positioning
    simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(25))
        .alphaTarget(0)
        .alpha(0)
        .on("tick", tick)
        .stop(); // Start with physics stopped
    
    // Create tooltip
    const tooltip = d3.select("body").append("div")
        .attr("class", "d3-tooltip")
        .style("opacity", 0);
    
    // Store references globally
    window.d3Network = {
        svg,
        container: g,
        linkGroup,
        nodeGroup,
        labelGroup,
        simulation,
        tooltip,
        zoom
    };
    
    // Load initial data
    refreshTopology();
}

// Load topology data
function refreshTopology() {
    const refreshBtn = document.getElementById('refresh-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Show loading
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
    
    // Fetch network data
    fetch('/api/enhanced_network_data')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.topology) {
                allData = data.topology;
                processData();
                updateVisualization();
                updateStatistics();
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            // Fallback to basic data
            return fetch('/api/network_data');
        })
        .then(response => {
            if (response) {
                return response.json();
            }
            return null;
        })
        .then(data => {
            if (data) {
                allData = convertBasicToEnhanced(data);
                processData();
                updateVisualization();
                updateStatistics();
            }
        })
        .catch(error => {
            console.error('Error loading fallback data:', error);
            showError('Failed to load network data');
        })
        .finally(() => {
            // Hide loading
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync"></i>';
            }
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        });
}

// Convert basic data to enhanced format
function convertBasicToEnhanced(data) {
    const enhanced = {
        nodes: [],
        edges: []
    };
    
    // Convert nodes
    if (data.nodes) {
        enhanced.nodes = data.nodes.map(node => ({
            id: node.id,
            label: node.label || node.ip || 'Unknown',
            ip: node.ip,
            type: node.type || 'server',
            status: node.status || 'unknown',
            connections: 0
        }));
    }
    
    // Convert edges
    if (data.edges) {
        enhanced.edges = data.edges.map(edge => ({
            id: `${edge.from}-${edge.to}`,
            from: edge.from,
            to: edge.to,
            protocol: edge.protocol || 'tcp',
            port: edge.port,
            weight: edge.count || 1
        }));
    }
    
    return enhanced;
}

// Process data for visualization
function processData() {
    if (!allData) return;
    
    // Apply filters
    const filteredData = applyCurrentFilters();
    
    // Prepare nodes
    nodes = filteredData.nodes.map(node => ({
        ...node,
        x: Math.random() * width,
        y: Math.random() * height,
        fx: null, // Allow free movement
        fy: null
    }));
    
    // Prepare links
    links = filteredData.edges.map(edge => ({
        ...edge,
        source: edge.from,
        target: edge.to
    }));
    
    console.log(`Processed ${nodes.length} nodes and ${links.length} links`);
}

// Apply current filters
function applyCurrentFilters() {
    if (!allData) return { nodes: [], edges: [] };
    
    let filteredNodes = [...allData.nodes];
    let filteredEdges = [...allData.edges];
    
    // Device type filters
    if (!document.getElementById('filter-servers')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'server');
    }
    if (!document.getElementById('filter-workstations')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'workstation');
    }
    if (!document.getElementById('filter-routers')?.checked) {
        filteredNodes = filteredNodes.filter(n => !['router', 'gateway'].includes(n.type));
    }
    if (!document.getElementById('filter-internet')?.checked) {
        filteredNodes = filteredNodes.filter(n => n.type !== 'internet');
    }
    
    // Connection threshold
    const threshold = parseInt(document.getElementById('connection-threshold')?.value || 1);
    filteredEdges = filteredEdges.filter(edge => (edge.weight || 1) >= threshold);
    
    // Filter edges based on remaining nodes
    const nodeIds = new Set(filteredNodes.map(n => n.id));
    filteredEdges = filteredEdges.filter(edge => 
        nodeIds.has(edge.from) && nodeIds.has(edge.to)
    );
    
    return {
        nodes: filteredNodes,
        edges: filteredEdges
    };
}

// Update visualization
function updateVisualization() {
    if (!window.d3Network) return;
    
    const { linkGroup, nodeGroup, labelGroup, simulation, tooltip } = window.d3Network;
    
    // Update links
    const link = linkGroup.selectAll(".d3-link")
        .data(links, d => d.id);
    
    link.exit().remove();
    
    const linkEnter = link.enter().append("line")
        .attr("class", "d3-link")
        .attr("stroke", "#999")
        .attr("stroke-width", d => Math.max(1, d.weight || 1));
    
    const linkMerge = linkEnter.merge(link);
    
    // Update nodes
    const node = nodeGroup.selectAll(".d3-node")
        .data(nodes, d => d.id);
    
    node.exit().remove();
    
    const nodeEnter = node.enter().append("circle")
        .attr("class", "d3-node")
        .attr("r", d => Math.max(8, Math.min(30, (d.connections || 0) * 2 + 12)))
        .attr("fill", d => nodeColors[d.type] || '#6c757d')
        .attr("stroke", d => d3.rgb(nodeColors[d.type] || '#6c757d').darker(1))
        .call(d3.drag()
            .on("start", dragStarted)
            .on("drag", dragged)
            .on("end", dragEnded))
        .on("click", nodeClicked)
        .on("mouseover", (event, d) => showTooltip(event, d))
        .on("mouseout", hideTooltip);
    
    const nodeMerge = nodeEnter.merge(node);
    
    // Update labels
    const label = labelGroup.selectAll(".d3-label")
        .data(document.getElementById('show-labels')?.checked ? nodes : [], d => d.id);
    
    label.exit().remove();
    
    const labelEnter = label.enter().append("text")
        .attr("class", "d3-label")
        .text(d => d.label);
    
    const labelMerge = labelEnter.merge(label);
    
    // Update simulation
    simulation.nodes(nodes);
    simulation.force("link").links(links);
    simulation.alpha(1).restart();
    
    // Store references for tick function
    window.d3Network.linkSelection = linkMerge;
    window.d3Network.nodeSelection = nodeMerge;
    window.d3Network.labelSelection = labelMerge;
}

// Tick function for simulation
function tick() {
    if (!window.d3Network) return;
    
    const { linkSelection, nodeSelection, labelSelection } = window.d3Network;
    
    if (linkSelection) {
        linkSelection
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
    }
    
    if (nodeSelection) {
        nodeSelection
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
    }
    
    if (labelSelection) {
        labelSelection
            .attr("x", d => d.x)
            .attr("y", d => d.y + 4);
    }
}

// Drag functions - completely manual positioning
function dragStarted(event, d) {
    // Stop any simulation forces
    simulation.stop();
    
    // Set initial fixed positions
    d.fx = d.x;
    d.fy = d.y;
    
    // Add visual feedback
    d3.select(event.sourceEvent.target).style("cursor", "grabbing");
}

function dragged(event, d) {
    // Directly update both position and fixed position
    d.x = event.x;
    d.y = event.y;
    d.fx = event.x;
    d.fy = event.y;
    
    // Manually update the visual position immediately
    const nodeSelection = window.d3Network.nodeSelection;
    const labelSelection = window.d3Network.labelSelection;
    const linkSelection = window.d3Network.linkSelection;
    
    // Update this specific node
    nodeSelection.filter(node => node.id === d.id)
        .attr("cx", d.x)
        .attr("cy", d.y);
    
    // Update labels for this node
    labelSelection.filter(node => node.id === d.id)
        .attr("x", d.x)
        .attr("y", d.y + 4);
    
    // Update any connected links
    linkSelection
        .attr("x1", link => link.source.x)
        .attr("y1", link => link.source.y)
        .attr("x2", link => link.target.x)
        .attr("y2", link => link.target.y);
}

function dragEnded(event, d) {
    // Keep the node exactly where it was dropped
    d.fx = event.x;
    d.fy = event.y;
    d.x = event.x;
    d.y = event.y;
    
    // Reset cursor
    d3.select(event.sourceEvent.target).style("cursor", "grab");
    
    console.log(`Node ${d.id} positioned at (${d.x}, ${d.y})`);
}

// Node click handler
function nodeClicked(event, d) {
    // Clear previous selections
    d3.selectAll(".d3-node").classed("selected", false);
    d3.select(this).classed("selected", true);
    
    showNodeDetails(d);
}

// Show tooltip
function showTooltip(event, d) {
    const { tooltip } = window.d3Network;
    
    tooltip.transition().duration(200).style("opacity", 0.9);
    tooltip.html(`
        <strong>${d.label}</strong><br/>
        IP: ${d.ip}<br/>
        Type: ${d.type}<br/>
        Status: ${d.status}
    `)
    .style("left", (event.pageX + 10) + "px")
    .style("top", (event.pageY - 28) + "px");
}

// Hide tooltip
function hideTooltip() {
    const { tooltip } = window.d3Network;
    tooltip.transition().duration(500).style("opacity", 0);
}

// Show node details in panel
function showNodeDetails(node) {
    const connectedLinks = links.filter(l => 
        l.source.id === node.id || l.target.id === node.id
    );
    
    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;
    
    infoPanel.innerHTML = `
        <div class="border-start border-primary border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-${getNodeIcon(node.type)} me-2"></i>${node.label}
            </h6>
            <div class="small mb-3">
                <div class="mb-1"><strong>IP:</strong> <code>${node.ip}</code></div>
                <div class="mb-1"><strong>Type:</strong> ${node.type}</div>
                <div class="mb-1"><strong>Status:</strong> 
                    <span class="badge bg-${getStatusColor(node.status)}">${node.status}</span>
                </div>
                <div class="mb-1"><strong>Connections:</strong> ${connectedLinks.length}</div>
            </div>
            
            <div class="mb-3">
                <strong class="small">Connected To:</strong>
                <div class="mt-1 small">
                    ${connectedLinks.slice(0, 5).map(link => {
                        const connected = link.source.id === node.id ? link.target : link.source;
                        return `<div class="text-muted">• ${connected.label} (${link.protocol})</div>`;
                    }).join('')}
                    ${connectedLinks.length > 5 ? `<div class="text-muted small">... and ${connectedLinks.length - 5} more</div>` : ''}
                </div>
            </div>
            
            <button class="btn btn-outline-primary btn-sm" onclick="centerOnNode('${node.id}')">
                <i class="fas fa-crosshairs"></i> Center View
            </button>
        </div>
    `;
}

// Control functions
function toggleSimulation() {
    simulationRunning = !simulationRunning;
    const btn = document.getElementById('physics-btn');
    
    if (simulationRunning) {
        simulation.alpha(1).restart();
        btn.innerHTML = '<i class="fas fa-pause"></i>';
        btn.title = 'Pause Physics';
    } else {
        simulation.stop();
        btn.innerHTML = '<i class="fas fa-play"></i>';
        btn.title = 'Start Physics';
    }
}

function resetZoom() {
    if (!window.d3Network) return;
    
    const { svg, zoom } = window.d3Network;
    
    svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomIdentity.translate(0, 0).scale(1)
    );
}

function centerOnNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node || !window.d3Network) return;
    
    const { svg, zoom } = window.d3Network;
    
    svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomIdentity.translate(width / 2 - node.x, height / 2 - node.y).scale(1.5)
    );
}

function changeLayout() {
    const layoutSelect = document.getElementById('layout-select');
    if (!layoutSelect) return;
    
    currentLayout = layoutSelect.value;
    
    // Apply different layout forces
    switch (currentLayout) {
        case 'hierarchical':
            simulation.force("y", d3.forceY().strength(0.1));
            simulation.force("x", null);
            break;
        case 'circular':
            const radius = Math.min(width, height) / 3;
            nodes.forEach((node, i) => {
                const angle = (i / nodes.length) * 2 * Math.PI;
                node.fx = width / 2 + radius * Math.cos(angle);
                node.fy = height / 2 + radius * Math.sin(angle);
            });
            break;
        case 'grid':
            const cols = Math.ceil(Math.sqrt(nodes.length));
            nodes.forEach((node, i) => {
                node.fx = (i % cols) * (width / cols) + width / (cols * 2);
                node.fy = Math.floor(i / cols) * (height / Math.ceil(nodes.length / cols)) + 50;
            });
            break;
        default: // force
            nodes.forEach(node => {
                node.fx = null;
                node.fy = null;
            });
            simulation.force("x", null);
            simulation.force("y", null);
    }
    
    simulation.alpha(1).restart();
}

function updateNodeSize(value) {
    d3.selectAll(".d3-node")
        .attr("r", d => Math.max(5, Math.min(50, parseInt(value))));
}

function updateLinkDistance(value) {
    simulation.force("link").distance(parseInt(value));
    simulation.alpha(1).restart();
}

function updateConnectionThreshold(value) {
    document.getElementById('threshold-value').textContent = value;
}

function toggleLabels() {
    updateVisualization();
}

function applyFilters() {
    processData();
    updateVisualization();
    updateStatistics();
}

function resetFilters() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    document.getElementById('connection-threshold').value = '1';
    document.getElementById('threshold-value').textContent = '1';
    applyFilters();
}

function updateStatistics() {
    document.getElementById('total-nodes').textContent = nodes.length;
    document.getElementById('total-connections').textContent = links.length;
}

function exportSVG() {
    if (!svg) return;
    
    const svgData = new XMLSerializer().serializeToString(svg.node());
    const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const svgUrl = URL.createObjectURL(svgBlob);
    
    const link = document.createElement('a');
    link.href = svgUrl;
    link.download = `network-topology-${new Date().toISOString().split('T')[0]}.svg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(svgUrl);
}

function showLegend() {
    const modal = new bootstrap.Modal(document.getElementById('legendModal'));
    modal.show();
}

function showError(message) {
    const infoPanel = document.getElementById('node-info');
    if (!infoPanel) return;
    
    infoPanel.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Utility functions
function getNodeIcon(type) {
    const icons = {
        server: 'server',
        workstation: 'desktop',
        router: 'route',
        gateway: 'door-open',
        internet: 'globe',
        cloud: 'cloud'
    };
    return icons[type] || 'circle';
}

function getStatusColor(status) {
    const colors = {
        online: 'success',
        offline: 'danger',
        warning: 'warning',
        unknown: 'secondary'
    };
    return colors[status] || 'secondary';
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeD3Network();
    
    // Apply circular layout automatically after data loads
    setTimeout(() => {
        if (nodes.length > 0) {
            changeLayout();
        }
    }, 1000);
});

// Handle window resize
window.addEventListener('resize', function() {
    if (!window.d3Network) return;
    
    const container = d3.select("#d3-network-container");
    const rect = container.node().getBoundingClientRect();
    
    width = rect.width;
    height = rect.height;
    
    window.d3Network.svg
        .attr("width", width)
        .attr("height", height);
    
    simulation.force("center", d3.forceCenter(width / 2, height / 2));
    simulation.alpha(1).restart();
});
</script>
{% endblock %}
