{% extends "base.html" %}

{% block title %}Network Map - Network Visualization{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-project-diagram me-2"></i>Network Map</h1>
        <p class="text-muted">Interactive visualization of your network topology and connections</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-lg-8">
        <!-- Network Graph Controls -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Network Topology</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="fitNetwork()" title="Fit to screen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshNetwork()" title="Refresh data">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="togglePhysics()" title="Toggle physics" id="physics-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showLegend()" title="Show legend">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="network-container" style="height: 600px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Network Information Panel -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Network Information</h6>
            </div>
            <div class="card-body">
                <div id="node-info">
                    <div class="text-center text-muted">
                        <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                        <p>Click on a node or connection to view details</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Network Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h6>
            </div>
            <div class="card-body">
                <div id="network-stats">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Nodes:</span>
                        <span id="node-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Connections:</span>
                        <span id="edge-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Online Hosts:</span>
                        <span id="online-count" class="text-success">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Offline Hosts:</span>
                        <span id="offline-count" class="text-danger">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Show Status:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-online" checked>
                        <label class="form-check-label" for="show-online">
                            <i class="fas fa-check-circle text-success"></i> Online
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-offline" checked>
                        <label class="form-check-label" for="show-offline">
                            <i class="fas fa-times-circle text-danger"></i> Offline
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-unknown" checked>
                        <label class="form-check-label" for="show-unknown">
                            <i class="fas fa-question-circle text-secondary"></i> Unknown
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="time-filter" class="form-label">Connection Age:</label>
                    <select class="form-select form-select-sm" id="time-filter">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last Week</option>
                        <option value="0">All Time</option>
                    </select>
                </div>
                
                <button class="btn btn-sm btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Legend Modal -->
<div class="modal fade" id="legendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Network Map Legend</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Node Colors</h6>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 20px; height: 20px; background-color: #28a745; border-radius: 50%;"></div>
                            <span>Online Hosts</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 20px; height: 20px; background-color: #dc3545; border-radius: 50%;"></div>
                            <span>Offline Hosts</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 20px; height: 20px; background-color: #ffc107; border-radius: 50%;"></div>
                            <span>Ping Only</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 20px; height: 20px; background-color: #6c757d; border-radius: 50%;"></div>
                            <span>Unknown Status</span>
                        </div>
                    </div>
                </div>
                
                <h6>Network Groups</h6>
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #007bff; border-radius: 50%;"></div>
                        <span>Local Network (192.168.x.x)</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #17a2b8; border-radius: 50%;"></div>
                        <span>Corporate Network (10.x.x.x)</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #6f42c1; border-radius: 50%;"></div>
                        <span>Private Network (172.x.x.x)</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="me-2" style="width: 20px; height: 20px; background-color: #fd7e14; border-radius: 50%;"></div>
                        <span>Internet Hosts</span>
                    </div>
                </div>
                
                <h6>Connections</h6>
                <div class="mb-3">
                    <p class="small mb-1">Line thickness indicates connection frequency</p>
                    <p class="small mb-1">Hover over connections to see port and protocol details</p>
                    <p class="small mb-0">Arrows show the direction of initiated connections</p>
                </div>
                
                <h6>Interactions</h6>
                <div>
                    <p class="small mb-1">• Click nodes to view detailed information</p>
                    <p class="small mb-1">• Drag nodes to reposition them</p>
                    <p class="small mb-1">• Use mouse wheel to zoom in/out</p>
                    <p class="small mb-0">• Right-click for context menu (future feature)</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let network = null;
let nodes = null;
let edges = null;
let allNodes = [];
let allEdges = [];
let physicsEnabled = true;

// Initialize the network visualization
function initializeNetwork() {
    const container = document.getElementById('network-container');
    
    // Network options
    const options = {
        nodes: {
            borderWidth: 2,
            size: 20,
            font: {
                size: 12,
                face: 'Arial'
            },
            shadow: true
        },
        edges: {
            width: 2,
            shadow: true,
            arrows: {
                to: { enabled: true, scaleFactor: 1 }
            },
            smooth: {
                enabled: true,
                type: 'continuous'
            }
        },
        physics: {
            enabled: true,
            stabilization: { iterations: 100 },
            barnesHut: {
                gravitationalConstant: -8000,
                centralGravity: 0.3,
                springLength: 120,
                springConstant: 0.05,
                damping: 0.09
            }
        },
        interaction: {
            tooltipDelay: 200,
            hideEdgesOnDrag: false,
            hideNodesOnDrag: false
        }
    };
    
    // Initialize empty network
    nodes = new vis.DataSet([]);
    edges = new vis.DataSet([]);
    network = new vis.Network(container, { nodes: nodes, edges: edges }, options);
    
    // Event handlers
    network.on('click', function(params) {
        handleNetworkClick(params);
    });
    
    network.on('hoverNode', function(params) {
        handleNodeHover(params);
    });
    
    network.on('hoverEdge', function(params) {
        handleEdgeHover(params);
    });
    
    // Load network data
    refreshNetwork();
}

// Load network data from API
function refreshNetwork() {
    fetch('/api/network_data')
    .then(response => response.json())
    .then(data => {
        allNodes = data.nodes;
        allEdges = data.edges;
        
        updateNetworkVisualization();
        updateStatistics();
    })
    .catch(error => {
        console.error('Error loading network data:', error);
        showErrorMessage('Failed to load network data');
    });
}

// Update the network visualization
function updateNetworkVisualization() {
    // Process nodes
    const processedNodes = allNodes.map(node => {
        const color = getNodeColor(node.status, node.group);
        return {
            id: node.id,
            label: node.label + '\n' + node.ip,
            title: `${node.label}\nIP: ${node.ip}\nStatus: ${node.status}\nLast seen: ${node.last_seen || 'Never'}`,
            color: color,
            group: node.group
        };
    });
    
    // Process edges
    const processedEdges = allEdges.map(edge => {
        const width = Math.max(1, Math.min(10, edge.count / 10));
        return {
            id: `${edge.from}-${edge.to}-${edge.port}`,
            from: edge.from,
            to: edge.to,
            label: `:${edge.port}`,
            title: edge.title,
            width: width,
            color: getEdgeColor(edge.protocol)
        };
    });
    
    // Update the datasets
    nodes.clear();
    edges.clear();
    nodes.add(processedNodes);
    edges.add(processedEdges);
    
    // Fit network to container
    setTimeout(() => {
        if (network && processedNodes.length > 0) {
            network.fit();
        }
    }, 500);
}

// Get node color based on status and group
function getNodeColor(status, group) {
    let borderColor, backgroundColor;
    
    // Base color by group
    switch (group) {
        case 'local':
            backgroundColor = '#cce5ff';
            borderColor = '#007bff';
            break;
        case 'corporate':
            backgroundColor = '#b3ecf0';
            borderColor = '#17a2b8';
            break;
        case 'private':
            backgroundColor = '#e1d7f0';
            borderColor = '#6f42c1';
            break;
        case 'internet':
            backgroundColor = '#ffd6b3';
            borderColor = '#fd7e14';
            break;
        default:
            backgroundColor = '#e9ecef';
            borderColor = '#6c757d';
    }
    
    // Override based on status
    switch (status) {
        case 'online':
            borderColor = '#28a745';
            break;
        case 'offline':
            borderColor = '#dc3545';
            backgroundColor = '#f8d7da';
            break;
        case 'ping_only':
            borderColor = '#ffc107';
            backgroundColor = '#fff3cd';
            break;
    }
    
    return {
        background: backgroundColor,
        border: borderColor,
        highlight: {
            background: backgroundColor,
            border: borderColor
        }
    };
}

// Get edge color based on protocol
function getEdgeColor(protocol) {
    switch (protocol?.toLowerCase()) {
        case 'tcp':
            return '#007bff';
        case 'udp':
            return '#28a745';
        case 'icmp':
            return '#ffc107';
        default:
            return '#6c757d';
    }
}

// Handle network click events
function handleNetworkClick(params) {
    if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        showNodeDetails(nodeId);
    } else if (params.edges.length > 0) {
        const edgeId = params.edges[0];
        showEdgeDetails(edgeId);
    } else {
        clearInfoPanel();
    }
}

// Handle node hover
function handleNodeHover(params) {
    // Optional: Show quick info on hover
}

// Handle edge hover
function handleEdgeHover(params) {
    // Optional: Show connection details on hover
}

// Show detailed information for a node
function showNodeDetails(nodeId) {
    const node = allNodes.find(n => n.id === nodeId);
    if (!node) return;
    
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
        <div class="border-start border-primary border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-server me-2"></i>${node.label}
            </h6>
            <div class="small mb-2">
                <strong>IP Address:</strong> <code>${node.ip}</code><br>
                <strong>Status:</strong> <span class="status-${node.status}">${node.status}</span><br>
                <strong>Group:</strong> ${node.group}<br>
                <strong>Last Seen:</strong> ${node.last_seen || 'Never'}
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="fetchFullHostDetails(${nodeId})">
                    <i class="fas fa-info-circle me-1"></i>Full Details
                </button>
                <button class="btn btn-outline-secondary" onclick="focusNode(${nodeId})">
                    <i class="fas fa-crosshairs me-1"></i>Focus
                </button>
            </div>
        </div>
    `;
}

// Show detailed information for an edge
function showEdgeDetails(edgeId) {
    const edge = allEdges.find(e => `${e.from}-${e.to}-${e.port}` === edgeId);
    if (!edge) return;
    
    const sourceNode = allNodes.find(n => n.id === edge.from);
    const destNode = allNodes.find(n => n.id === edge.to);
    
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
        <div class="border-start border-info border-3 ps-3">
            <h6 class="mb-2">
                <i class="fas fa-network-wired me-2"></i>Connection
            </h6>
            <div class="small mb-2">
                <strong>From:</strong> ${sourceNode?.label || 'Unknown'}<br>
                <strong>To:</strong> ${destNode?.label || 'Unknown'}<br>
                <strong>Port:</strong> ${edge.port}<br>
                <strong>Protocol:</strong> ${edge.protocol}<br>
                <strong>Connections:</strong> ${edge.count}<br>
                <strong>Last Seen:</strong> ${edge.last_seen}
            </div>
        </div>
    `;
}

// Clear the information panel
function clearInfoPanel() {
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
            <p>Click on a node or connection to view details</p>
        </div>
    `;
}

// Update network statistics
function updateStatistics() {
    document.getElementById('node-count').textContent = allNodes.length;
    document.getElementById('edge-count').textContent = allEdges.length;
    document.getElementById('online-count').textContent = allNodes.filter(n => n.status === 'online').length;
    document.getElementById('offline-count').textContent = allNodes.filter(n => n.status === 'offline').length;
}

// Network control functions
function fitNetwork() {
    if (network) {
        network.fit();
    }
}

function togglePhysics() {
    physicsEnabled = !physicsEnabled;
    const btn = document.getElementById('physics-btn');
    
    if (network) {
        network.setOptions({ physics: { enabled: physicsEnabled } });
        btn.innerHTML = physicsEnabled ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        btn.title = physicsEnabled ? 'Disable physics' : 'Enable physics';
    }
}

function showLegend() {
    const modal = new bootstrap.Modal(document.getElementById('legendModal'));
    modal.show();
}

function focusNode(nodeId) {
    if (network) {
        network.focus(nodeId, {
            scale: 1.5,
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

function fetchFullHostDetails(hostId) {
    // This would open the same modal as in the dashboard
    showHostDetails(hostId);
}

function applyFilters() {
    // Get filter states
    const showOnline = document.getElementById('show-online').checked;
    const showOffline = document.getElementById('show-offline').checked;
    const showUnknown = document.getElementById('show-unknown').checked;
    const timeFilter = document.getElementById('time-filter').value;
    
    // Filter nodes
    let filteredNodes = allNodes.filter(node => {
        switch (node.status) {
            case 'online':
                return showOnline;
            case 'offline':
                return showOffline;
            default:
                return showUnknown;
        }
    });
    
    // Filter edges based on time (simplified - in reality you'd parse timestamps)
    let filteredEdges = allEdges;
    if (timeFilter !== '0') {
        // This would filter based on actual timestamps in a real implementation
        filteredEdges = allEdges;
    }
    
    // Update visualization
    const filteredNodeIds = new Set(filteredNodes.map(n => n.id));
    filteredEdges = filteredEdges.filter(edge => 
        filteredNodeIds.has(edge.from) && filteredNodeIds.has(edge.to)
    );
    
    // Update the display
    allNodes = filteredNodes;
    allEdges = filteredEdges;
    updateNetworkVisualization();
    updateStatistics();
}

function showErrorMessage(message) {
    const infoPanel = document.getElementById('node-info');
    infoPanel.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeNetwork();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshNetwork, 30000);
});

// Handle window resize
window.addEventListener('resize', function() {
    if (network) {
        network.redraw();
    }
});
</script>
{% endblock %}
