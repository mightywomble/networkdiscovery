{% extends "base_patternfly.html" %}

{% block title %}Settings - Home Lab{% endblock %}

{% block breadcrumb %}
<li class="pf-c-breadcrumb__item">
    <a href="{{ url_for('index') }}" class="pf-c-breadcrumb__link">Home</a>
</li>
<li class="pf-c-breadcrumb__item">
    <span class="pf-c-breadcrumb__item-divider">></span>
    <span class="pf-c-breadcrumb__link pf-m-current" aria-current="page">Settings</span>
</li>
{% endblock %}

{% block content %}
<!-- Page header -->
<section class="pf-c-page__main-section pf-m-light">
    <div class="pf-c-content">
        <h1>
            <i class="fas fa-cog pf-u-mr-sm"></i>System Settings
        </h1>
        <p class="pf-c-content">Manage AI integrations, network configuration, and system preferences.</p>
    </div>
</section>

<!-- Settings content -->
<section class="pf-c-page__main-section">
    <div class="pf-l-gallery pf-m-gutter">
        
        <!-- Cards for AI Settings -->
        <div class="pf-l-gallery__item">
            <div class="pf-c-card" style="min-height: 400px;">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__header-main">
                        <h2 class="pf-c-card__title">
                            <i class="fas fa-robot pf-u-mr-sm"></i>AI API Configuration
                        </h2>
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-color-200">Configure AI service integrations for enhanced network analysis and insights.</p>
                    
                    <div id="ai-settings-overview">
                        <!-- AI settings will be loaded here -->
                        <div class="pf-c-empty-state pf-m-sm">
                            <div class="pf-c-empty-state__content">
                                <div class="pf-c-spinner pf-m-lg" role="progressbar">
                                    <span class="pf-c-spinner__clipper"></span>
                                    <span class="pf-c-spinner__lead-ball"></span>
                                    <span class="pf-c-spinner__tail-ball"></span>
                                </div>
                                <h2 class="pf-c-title pf-m-lg">Loading AI settings...</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Gemini Settings Card -->
        <div class="pf-l-gallery__item">
            <div class="pf-c-card" style="min-height: 400px;">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__header-main">
                        <h2 class="pf-c-card__title">
                            <i class="fas fa-brain pf-u-mr-sm"></i>Google Gemini
                        </h2>
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-color-200">Configure the Google Gemini API for advanced AI capabilities.</p>
                    <p>Use Google's latest AI models including gemini-2.5-flash and gemini-2.5-pro for network analysis and insights.</p>
                    
                    <div id="gemini-status" class="pf-u-mt-md">
                        <!-- Gemini status will be loaded here -->
                        <div class="pf-c-skeleton pf-u-w-100 pf-u-h-sm"></div>
                    </div>
                </div>
                <div class="pf-c-card__footer">
                    <button class="pf-c-button pf-m-primary" type="button" onclick="openAIModal('gemini')">
                        <i class="fas fa-cog pf-u-mr-sm"></i>Configure Gemini
                    </button>
                </div>
            </div>
        </div>
        
        <!-- OpenAI ChatGPT Settings Card -->
        <div class="pf-l-gallery__item">
            <div class="pf-c-card" style="min-height: 400px;">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__header-main">
                        <h2 class="pf-c-card__title">
                            <i class="fas fa-comments pf-u-mr-sm"></i>OpenAI ChatGPT
                        </h2>
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-color-200">Configure the OpenAI ChatGPT API for AI-powered assistance.</p>
                    <p>Access OpenAI's powerful language models including GPT-4 and GPT-3.5 for enhanced network mapping capabilities.</p>
                    
                    <div id="chatgpt-status" class="pf-u-mt-md">
                        <!-- ChatGPT status will be loaded here -->
                        <div class="pf-c-skeleton pf-u-w-100 pf-u-h-sm"></div>
                    </div>
                </div>
                <div class="pf-c-card__footer">
                    <button class="pf-c-button pf-m-primary" type="button" onclick="openAIModal('chatgpt')">
                        <i class="fas fa-cog pf-u-mr-sm"></i>Configure ChatGPT
                    </button>
                </div>
            </div>
        </div>
        
        <!-- AI Chatbot Settings Card -->
        <div class="pf-l-gallery__item">
            <div class="pf-c-card" style="min-height: 400px;">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__header-main">
                        <h2 class="pf-c-card__title">
                            <i class="fas fa-robot pf-u-mr-sm"></i>AI Chatbot
                        </h2>
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-color-200">Configure AI Chatbot settings for script generation and execution.</p>
                    <p>Manage agent version requirements, prompts, and execution policies for the AI-powered chatbot.</p>
                    
                    <div id="chatbot-settings-status" class="pf-u-mt-md">
                        <!-- Chatbot settings status will be loaded here -->
                        <div class="pf-c-skeleton pf-u-w-100 pf-u-h-sm"></div>
                    </div>
                </div>
                <div class="pf-c-card__footer">
                    <button class="pf-c-button pf-m-primary" type="button" onclick="openChatbotSettingsModal()">
                        <i class="fas fa-cog pf-u-mr-sm"></i>Configure Chatbot
                    </button>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="pf-l-gallery__item" style="grid-column: 1 / -1;">
            <div class="pf-c-card">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__header-main">
                        <h2 class="pf-c-card__title">
                            <i class="fas fa-info-circle pf-u-mr-sm"></i>System Information
                        </h2>
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <div class="pf-l-grid pf-m-all-6-col-on-md pf-m-all-4-col-on-lg pf-m-gutter">
                        <div class="pf-l-grid__item">
                            <dl class="pf-c-description-list pf-m-horizontal">
                                <dt class="pf-c-description-list__term">
                                    <span class="pf-c-description-list__text">Application Version</span>
                                </dt>
                                <dd class="pf-c-description-list__description">
                                    <div class="pf-c-description-list__text">NetworkMap v1.4.0</div>
                                </dd>
                            </dl>
                        </div>
                        <div class="pf-l-grid__item">
                            <dl class="pf-c-description-list pf-m-horizontal">
                                <dt class="pf-c-description-list__term">
                                    <span class="pf-c-description-list__text">Database</span>
                                </dt>
                                <dd class="pf-c-description-list__description">
                                    <div class="pf-c-description-list__text">SQLite</div>
                                </dd>
                            </dl>
                        </div>
                        <div class="pf-l-grid__item">
                            <dl class="pf-c-description-list pf-m-horizontal">
                                <dt class="pf-c-description-list__term">
                                    <span class="pf-c-description-list__text">Server</span>
                                </dt>
                                <dd class="pf-c-description-list__description">
                                    <div class="pf-c-description-list__text">Flask Development Server</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAISettingsOverview();
    loadProviderStatus('gemini');
    loadProviderStatus('chatgpt');
    loadChatbotSettingsStatus();
});

function loadAISettingsOverview() {
    const overviewContainer = document.getElementById('ai-settings-overview');
    
    fetch('/api/ai_settings')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const settings = data.settings || [];
            let html = '';
            
            if (settings.length === 0) {
                html = `
                    <div class="pf-c-alert pf-m-info pf-m-inline" aria-label="Info alert">
                        <div class="pf-c-alert__icon">
                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                        </div>
                        <p class="pf-c-alert__title">
                            No AI services configured yet. Use the cards below to set up your AI integrations.
                        </p>
                    </div>
                `;
            } else {
                // Show summary of configured services
                const enabledCount = settings.filter(s => s.enabled).length;
                const totalCount = settings.length;
                const configuredServices = settings.map(s => s.provider === 'gemini' ? 'Google Gemini' : 'OpenAI ChatGPT').join(', ');
                
                html = `
                    <div class="pf-c-alert pf-m-success pf-m-inline" aria-label="Success alert">
                        <div class="pf-c-alert__icon">
                            <i class="fas fa-check-circle" aria-hidden="true"></i>
                        </div>
                        <p class="pf-c-alert__title">
                            ${enabledCount} of ${totalCount} AI services enabled: ${configuredServices}
                        </p>
                        <p class="pf-c-alert__description">
                            Use the configuration cards below to modify settings or enable/disable services.
                        </p>
                    </div>
                `;
            }
            
            overviewContainer.innerHTML = html;
        } else {
            overviewContainer.innerHTML = `
                <div class="pf-c-alert pf-m-danger pf-m-inline" aria-label="Danger alert">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                    </div>
                    <p class="pf-c-alert__title">
                        Error loading AI settings: ${data.error}
                    </p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading AI settings:', error);
        overviewContainer.innerHTML = `
            <div class="pf-c-alert pf-m-warning pf-m-inline" aria-label="Warning alert">
                <div class="pf-c-alert__icon">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <p class="pf-c-alert__title">
                    Unable to load AI settings status. Use the configuration cards below to set up your services.
                </p>
            </div>
        `;
    });
}

function loadProviderStatus(provider) {
    const statusContainer = document.getElementById(`${provider}-status`);
    
    fetch(`/api/ai_settings/${provider}`)
    .then(response => {
        if (response.ok) {
            return response.json();
        } else if (response.status === 404) {
            // No configuration found
            return { success: false, not_configured: true };
        } else {
            throw new Error('Failed to load settings');
        }
    })
    .then(data => {
        let html = '';
        
        if (data.success && data.settings) {
            const setting = data.settings;
            const statusColor = setting.enabled ? 'success' : 'warning';
            const statusText = setting.enabled ? 'Enabled' : 'Disabled';
            const statusIcon = setting.enabled ? 'check-circle' : 'exclamation-triangle';
            
            html = `
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Model</div>
                <div style="margin-bottom: 12px;">${setting.model_name || 'Not configured'}</div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Enabled/Disabled</div>
                <div style="margin-bottom: 12px;">
                    <span class="pf-c-label pf-m-${statusColor}">
                        <span class="pf-c-label__content">
                            <i class="fas fa-${statusIcon} pf-u-mr-xs"></i>${statusText}
                        </span>
                    </span>
                </div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">API Key</div>
                <div>${setting.api_key_masked || 'Not set'}</div>
            `;
        } else {
            // Not configured
            html = `
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Model</div>
                <div style="margin-bottom: 12px;">Not configured</div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Enabled/Disabled</div>
                <div style="margin-bottom: 12px;">
                    <span class="pf-c-label pf-m-grey">
                        <span class="pf-c-label__content">
                            <i class="fas fa-times pf-u-mr-xs"></i>Not configured
                        </span>
                    </span>
                </div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">API Key</div>
                <div>Not set</div>
            `;
        }
        
        statusContainer.innerHTML = html;
    })
    .catch(error => {
        console.error(`Error loading ${provider} status:`, error);
        statusContainer.innerHTML = `
            <div class="pf-c-alert pf-m-warning pf-m-inline pf-m-plain" aria-label="Warning alert">
                <div class="pf-c-alert__icon">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <p class="pf-c-alert__title">Unable to load status</p>
            </div>
        `;
    });
}

function loadChatbotSettingsStatus() {
    const statusContainer = document.getElementById('chatbot-settings-status');
    
    fetch('/api/chatbot_settings')
    .then(response => response.json())
    .then(data => {
        let html = '';
        
        if (data.success) {
            const settings = data.settings;
            const versionCheckColor = settings.require_version_check ? 'success' : 'warning';
            const versionCheckText = settings.require_version_check ? 'Enabled' : 'Disabled';
            const versionCheckIcon = settings.require_version_check ? 'check-circle' : 'exclamation-triangle';
            
            html = `
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Minimum Agent Version</div>
                <div style="margin-bottom: 12px;">${settings.minimum_agent_version}</div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Version Checking</div>
                <div style="margin-bottom: 12px;">
                    <span class="pf-c-label pf-m-${versionCheckColor}">
                        <span class="pf-c-label__content">
                            <i class="fas fa-${versionCheckIcon} pf-u-mr-xs"></i>${versionCheckText}
                        </span>
                    </span>
                </div>
                
                <div style="color: #000; font-weight: bold; margin-bottom: 8px;">Script Timeout</div>
                <div>${settings.script_timeout}s</div>
            `;
        } else {
            html = `
                <div class="pf-c-alert pf-m-warning pf-m-inline pf-m-plain" aria-label="Warning alert">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    </div>
                    <p class="pf-c-alert__title">Unable to load chatbot settings</p>
                </div>
            `;
        }
        
        statusContainer.innerHTML = html;
    })
    .catch(error => {
        console.error('Error loading chatbot settings:', error);
        statusContainer.innerHTML = `
            <div class="pf-c-alert pf-m-warning pf-m-inline pf-m-plain" aria-label="Warning alert">
                <div class="pf-c-alert__icon">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <p class="pf-c-alert__title">Unable to load status</p>
            </div>
        `;
    });
}

function openChatbotSettingsModal() {
    // Create modal HTML if it doesn't exist
    if (!document.getElementById('chatbotSettingsModal')) {
        const modalHtml = `
            <div class="pf-c-backdrop">
                <div class="pf-l-bullseye">
                    <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="chatbot-settings-modal-title" aria-describedby="chatbot-settings-modal-description" id="chatbotSettingsModal">
                        <div class="pf-c-modal-box__header">
                            <h1 class="pf-c-modal-box__title" id="chatbot-settings-modal-title">
                                <i class="fas fa-robot pf-u-mr-sm"></i>AI Chatbot Configuration
                            </h1>
                        </div>
                        <div class="pf-c-modal-box__body" id="chatbot-settings-modal-description">
                            <form id="chatbot-settings-form">
                                <div class="pf-l-grid pf-m-gutter">
                                    <div class="pf-l-grid__item pf-m-12-col">
                                        <div class="pf-c-form__group">
                                            <div class="pf-c-form__group-label">
                                                <label class="pf-c-form__label" for="minimum-agent-version">
                                                    <span class="pf-c-form__label-text">Minimum Agent Version</span>
                                                    <span class="pf-c-form__label-required" aria-hidden="true">*</span>
                                                </label>
                                            </div>
                                            <div class="pf-c-form__group-control">
                                                <select class="pf-c-form-control" id="minimum-agent-version" required>
                                                    <option value="1.5.0">1.5.0</option>
                                                    <option value="1.6.0" selected>1.6.0</option>
                                                    <option value="1.7.0">1.7.0</option>
                                                    <option value="2.0.0">2.0.0</option>
                                                </select>
                                                <div class="pf-c-form__helper-text">
                                                    <div class="pf-c-helper-text">
                                                        <div class="pf-c-helper-text__item">
                                                            <span class="pf-c-helper-text__item-text">Agents with versions below this will be blocked from executing AI-generated scripts.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pf-l-grid__item pf-m-12-col">
                                        <div class="pf-c-form__group">
                                            <div class="pf-c-form__group-control">
                                                <div class="pf-c-check">
                                                    <input class="pf-c-check__input" type="checkbox" id="require-version-check" checked>
                                                    <label class="pf-c-check__label" for="require-version-check">Enable version checking</label>
                                                </div>
                                                <div class="pf-c-form__helper-text">
                                                    <div class="pf-c-helper-text">
                                                        <div class="pf-c-helper-text__item">
                                                            <span class="pf-c-helper-text__item-text">When enabled, prevents script execution on agents with incompatible versions. Disable for testing or maintenance.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pf-l-grid__item pf-m-12-col">
                                        <div class="pf-c-form__group">
                                            <div class="pf-c-form__group-label">
                                                <label class="pf-c-form__label" for="script-timeout">
                                                    <span class="pf-c-form__label-text">Script Timeout (seconds)</span>
                                                </label>
                                            </div>
                                            <div class="pf-c-form__group-control">
                                                <input class="pf-c-form-control" type="number" id="script-timeout" min="30" max="3600" value="300">
                                                <div class="pf-c-form__helper-text">
                                                    <div class="pf-c-helper-text">
                                                        <div class="pf-c-helper-text__item">
                                                            <span class="pf-c-helper-text__item-text">Maximum time to wait for script execution before timing out.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pf-l-grid__item pf-m-12-col">
                                        <div class="pf-c-form__group">
                                            <div class="pf-c-form__group-label">
                                                <label class="pf-c-form__label" for="max-concurrent">
                                                    <span class="pf-c-form__label-text">Max Concurrent Executions</span>
                                                </label>
                                            </div>
                                            <div class="pf-c-form__group-control">
                                                <input class="pf-c-form-control" type="number" id="max-concurrent" min="1" max="20" value="5">
                                                <div class="pf-c-form__helper-text">
                                                    <div class="pf-c-helper-text">
                                                        <div class="pf-c-helper-text__item">
                                                            <span class="pf-c-helper-text__item-text">Maximum number of scripts that can run simultaneously.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pf-l-grid__item pf-m-12-col">
                                        <div class="pf-c-form__group">
                                            <div class="pf-c-form__group-label">
                                                <label class="pf-c-form__label" for="system-prompt">
                                                    <span class="pf-c-form__label-text">System Prompt</span>
                                                </label>
                                            </div>
                                            <div class="pf-c-form__group-control">
                                                <textarea class="pf-c-form-control" id="system-prompt" rows="6" placeholder="Enter the system prompt for the AI chatbot..."></textarea>
                                                <div class="pf-c-form__helper-text">
                                                    <div class="pf-c-helper-text">
                                                        <div class="pf-c-helper-text__item">
                                                            <span class="pf-c-helper-text__item-text">The system prompt that guides the AI's behavior when generating scripts.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="pf-c-modal-box__footer">
                            <button class="pf-c-button pf-m-primary" type="button" onclick="saveChatbotSettings()">
                                <i class="fas fa-save pf-u-mr-sm"></i>Save Settings
                            </button>
                            <button class="pf-c-button pf-m-link" type="button" onclick="closeChatbotSettingsModal()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Load current settings into the form
    loadChatbotSettingsIntoForm();
    
    // Show the modal
    document.getElementById('chatbotSettingsModal').style.display = 'block';
}

function loadChatbotSettingsIntoForm() {
    fetch('/api/chatbot_settings')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const settings = data.settings;
            
            document.getElementById('minimum-agent-version').value = settings.minimum_agent_version || '1.6.0';
            document.getElementById('require-version-check').checked = settings.require_version_check !== false;
            document.getElementById('script-timeout').value = settings.script_timeout || 300;
            document.getElementById('max-concurrent').value = settings.max_concurrent_executions || 5;
            document.getElementById('system-prompt').value = settings.system_prompt || '';
        }
    })
    .catch(error => {
        console.error('Error loading chatbot settings into form:', error);
    });
}

function saveChatbotSettings() {
    const formData = {
        minimum_agent_version: document.getElementById('minimum-agent-version').value,
        require_version_check: document.getElementById('require-version-check').checked,
        script_timeout: parseInt(document.getElementById('script-timeout').value),
        max_concurrent_executions: parseInt(document.getElementById('max-concurrent').value),
        system_prompt: document.getElementById('system-prompt').value
    };
    
    // Show saving indicator
    const saveButton = document.querySelector('#chatbotSettingsModal .pf-m-primary');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>Saving...';
    saveButton.disabled = true;
    
    fetch('/api/chatbot_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success notification
            showNotification('Chatbot settings saved successfully', 'success');
            closeChatbotSettingsModal();
            loadChatbotSettingsStatus();
        } else {
            showNotification('Error saving settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving chatbot settings:', error);
        showNotification('Error saving chatbot settings', 'danger');
    })
    .finally(() => {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}

function closeChatbotSettingsModal() {
    const modal = document.getElementById('chatbotSettingsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function showNotification(message, type) {
    // Simple notification function - you can enhance this
    const alert = document.createElement('div');
    alert.className = `pf-c-alert pf-m-${type} pf-m-inline`;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <div class="pf-c-alert__icon">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" aria-hidden="true"></i>
        </div>
        <p class="pf-c-alert__title">${message}</p>
    `;
    
    document.body.appendChild(alert);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (alert && alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// Refresh the overview and provider status when modals are closed
document.addEventListener('hidden.bs.modal', function (event) {
    if (event.target.id === 'geminiModal' || event.target.id === 'chatgptModal') {
        loadAISettingsOverview();
        loadProviderStatus('gemini');
        loadProviderStatus('chatgpt');
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('chatbotSettingsModal');
    if (modal && event.target === modal) {
        closeChatbotSettingsModal();
    }
});
</script>
{% endblock %}
