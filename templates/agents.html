{% extends "base.html" %}

{% block title %}Agent Management - Network Map{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-robot"></i> Agent Management</h1>
        <p class="text-muted">Deploy and manage network monitoring agents via SSH</p>
    </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-left-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-primary">Total Hosts</h6>
                        <h3 class="mb-0" id="total-hosts">-</h3>
                    </div>
                    <i class="fas fa-server fa-2x text-primary opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-success">Agents Deployed</h6>
                        <h3 class="mb-0" id="deployed-agents">-</h3>
                    </div>
                    <i class="fas fa-robot fa-2x text-success opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-info">Online Agents</h6>
                        <h3 class="mb-0" id="online-agents">-</h3>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-info opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-warning">Pending</h6>
                        <h3 class="mb-0" id="pending-agents">-</h3>
                    </div>
                    <i class="fas fa-clock fa-2x text-warning opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col">
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button type="button" class="btn btn-success" onclick="deploySelectedAgents()">
                <i class="fas fa-rocket"></i> Deploy Selected
            </button>
        </div>
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="selectAllHosts()" id="select-all-btn">
                <i class="fas fa-check-square"></i> Select All
            </button>
            <button type="button" class="btn btn-outline-info" onclick="showAgentLogs()">
                <i class="fas fa-file-alt"></i> View Logs
            </button>
            <button type="button" class="btn btn-outline-warning" onclick="showAgentCleanupTools()">
                <i class="fas fa-broom"></i> Cleanup Tools
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-info" onclick="showVersionSummary()">
                <i class="fas fa-code-branch"></i> Version Summary
            </button>
            <button type="button" class="btn btn-warning" onclick="updateSelectedAgents()">
                <i class="fas fa-arrow-up"></i> Update Selected
            </button>
            <button type="button" class="btn btn-danger" onclick="updateAllAgents()">
                <i class="fas fa-sync-alt"></i> Update All
            </button>
        </div>
    </div>
</div>

<!-- Hosts and Agents List -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server"></i> Hosts & Agent Status
                </h5>
            </div>
            <div class="card-body">
                <div id="hosts-container">
                    <!-- Hosts will be loaded here -->
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading hosts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Deployment Progress Modal -->
<div class="modal fade" id="deploymentProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-rocket"></i> Agent Deployment Progress</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="deployment-progress" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="deployment-status">Starting deployment...</small>
                </div>
                <div class="deployment-logs" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.875rem;" id="deployment-logs">
                    <!-- Deployment logs will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-deployment-btn" disabled>Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Agent Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <select class="form-select" id="log-agent-select">
                            <option value="">All Agents</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="log-hours-select">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="loadAgentLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="log-viewer" style="background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 0.875rem; border-radius: 0.375rem; max-height: 400px; overflow-y: auto; padding: 1rem;" id="logs-container">
                    <div class="text-center text-muted p-4">
                        Select an agent and click refresh to view logs
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Agent Status Dashboard Modal -->
<div class="modal fade" id="agentStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-heartbeat"></i> Agent Health Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Host:</strong> <span id="status-host-name"></span> (<span id="status-host-ip"></span>)
                </div>
                
                <!-- Status Overview Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center p-3">
                                <div class="status-indicator mb-2" id="service-status-indicator">
                                    <i class="fas fa-circle text-secondary fa-2x"></i>
                                </div>
                                <h6 class="card-title mb-1">Service Status</h6>
                                <small class="text-muted" id="service-status-text">Checking...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center p-3">
                                <div class="status-indicator mb-2" id="heartbeat-status-indicator">
                                    <i class="fas fa-heart text-secondary fa-2x"></i>
                                </div>
                                <h6 class="card-title mb-1">Heartbeat</h6>
                                <small class="text-muted" id="heartbeat-status-text">Checking...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center p-3">
                                <div class="status-indicator mb-2" id="scanning-status-indicator">
                                    <i class="fas fa-search text-secondary fa-2x"></i>
                                </div>
                                <h6 class="card-title mb-1">Scanning</h6>
                                <small class="text-muted" id="scanning-status-text">Checking...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center p-3">
                                <div class="status-indicator mb-2" id="logs-status-indicator">
                                    <i class="fas fa-file-alt text-secondary fa-2x"></i>
                                </div>
                                <h6 class="card-title mb-1">Log Collection</h6>
                                <small class="text-muted" id="logs-status-text">Checking...</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Status Information -->
                <div class="accordion" id="statusAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="systemInfoHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#systemInfoCollapse">
                                <i class="fas fa-server me-2"></i> System Information
                            </button>
                        </h2>
                        <div id="systemInfoCollapse" class="accordion-collapse collapse" data-bs-parent="#statusAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Agent Version:</small><br>
                                        <strong id="agent-version">-</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Platform:</small><br>
                                        <strong id="agent-platform">-</strong>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">Last Heartbeat:</small><br>
                                        <strong id="last-heartbeat">-</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Last Scan:</small><br>
                                        <strong id="last-scan">-</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="serviceDetailsHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#serviceDetailsCollapse">
                                <i class="fas fa-cogs me-2"></i> Service Details
                            </button>
                        </h2>
                        <div id="serviceDetailsCollapse" class="accordion-collapse collapse" data-bs-parent="#statusAccordion">
                            <div class="accordion-body">
                                <div class="service-output" style="background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto;" id="service-details-output">
                                    <div class="text-center text-muted">Click "Refresh Status" to load service details</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="refreshAgentStatus()" id="refresh-status-btn">
                    <i class="fas fa-sync-alt"></i> Refresh Status
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Configuration Editor Modal -->
<div class="modal fade" id="agentConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog"></i> Agent Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Host:</strong> <span id="config-host-name"></span> (<span id="config-host-ip"></span>)
                </div>
                
                <form id="agentConfigForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Scan Interval (seconds)</label>
                            <input type="number" class="form-control" id="scan-interval" min="60" max="86400" required>
                            <div class="form-text">How often to perform network scans (60-86400 seconds)</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Heartbeat Interval (seconds)</label>
                            <input type="number" class="form-control" id="heartbeat-interval" min="30" max="300" required>
                            <div class="form-text">How often to send heartbeats (30-300 seconds)</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="scan-enabled">
                                <label class="form-check-label" for="scan-enabled">
                                    Enable Network Scanning
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="log-collection-enabled">
                                <label class="form-check-label" for="log-collection-enabled">
                                    Enable Log Collection
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Log Paths</label>
                        <textarea class="form-control" id="log-paths" rows="3" placeholder="/var/log,/var/log/syslog,/var/log/auth.log"></textarea>
                        <div class="form-text">Comma-separated list of log paths to monitor</div>
                    </div>
                    
                    <!-- Test Configuration Section -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Network Test Configuration</label>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadDefaultTestConfiguration()" id="load-default-tests-btn">
                                <i class="fas fa-refresh"></i> Load Defaults
                            </button>
                        </div>
                        <div class="form-text mb-3">Select which network tests this agent should perform. Tests are grouped by category.</div>
                        
                        <!-- Test Categories Container -->
                        <div id="test-configuration-container" class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted py-3" id="test-config-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading test configuration...
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Configuration changes will be applied to the agent immediately and may take up to the heartbeat interval to take effect.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveAgentConfig()" id="save-config-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Cleanup Tools Modal -->
<div class="modal fade" id="agentCleanupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-broom"></i> Agent Database Cleanup Tools</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> These tools permanently remove agent records from the database. Use with caution!
                </div>
                
                <!-- Cleanup Options -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-copy"></i> Remove Duplicates</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Remove duplicate agent entries (keeps the most recent one for each host).</p>
                                <button class="btn btn-warning" onclick="cleanupDuplicateAgents()" id="cleanup-duplicates-btn">
                                    <i class="fas fa-broom"></i> Remove Duplicates
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="fas fa-clock"></i> Remove Stale Agents</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Remove agents that haven't sent heartbeats recently.</p>
                                <div class="input-group mb-2">
                                    <input type="number" class="form-control" id="stale-hours" value="24" min="1" max="168">
                                    <span class="input-group-text">hours</span>
                                </div>
                                <button class="btn btn-danger" onclick="cleanupStaleAgents()" id="cleanup-stale-btn">
                                    <i class="fas fa-trash-alt"></i> Remove Stale Agents
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Targeted Removal -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-crosshairs"></i> Remove Specific Agent</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Remove a specific agent by hostname or IP address (useful after uninstalling agents).</p>
                                <form class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Hostname</label>
                                        <input type="text" class="form-control" id="remove-hostname" placeholder="e.g., server01">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">IP Address</label>
                                        <input type="text" class="form-control" id="remove-ip" placeholder="e.g., 192.168.1.100">
                                    </div>
                                    <div class="col-12">
                                        <div class="form-text">You can specify either hostname or IP address (or both for more precise matching).</div>
                                    </div>
                                </form>
                                <button class="btn btn-info mt-3" onclick="removeAgentsByHost()" id="remove-by-host-btn">
                                    <i class="fas fa-minus-circle"></i> Remove Agent(s)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Current Agent Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Current Agent Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="border-end">
                                    <h5 class="text-primary mb-1" id="stats-total-agents">-</h5>
                                    <small class="text-muted">Total Agents</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border-end">
                                    <h5 class="text-success mb-1" id="stats-online-agents">-</h5>
                                    <small class="text-muted">Online</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border-end">
                                    <h5 class="text-danger mb-1" id="stats-offline-agents">-</h5>
                                    <small class="text-muted">Offline</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <h5 class="text-warning mb-1" id="stats-stale-agents">-</h5>
                                <small class="text-muted">Stale (24h+)</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshCleanupStats()">
                                <i class="fas fa-sync-alt"></i> Refresh Stats
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Cleanup Results -->
                <div class="mt-4" id="cleanup-results" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Cleanup Results</h6>
                        </div>
                        <div class="card-body">
                            <div class="cleanup-output" id="cleanup-output" style="background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                                <!-- Results will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Version Summary Modal -->
<div class="modal fade" id="versionSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-code-branch"></i> Agent Version Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Version Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 bg-light text-center">
                            <div class="card-body p-3">
                                <h5 class="text-primary mb-1" id="version-stats-total">-</h5>
                                <small class="text-muted">Total Agents</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light text-center">
                            <div class="card-body p-3">
                                <h5 class="text-success mb-1" id="version-stats-latest">-</h5>
                                <small class="text-muted">Latest Version</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light text-center">
                            <div class="card-body p-3">
                                <h5 class="text-warning mb-1" id="version-stats-outdated">-</h5>
                                <small class="text-muted">Need Updates</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light text-center">
                            <div class="card-body p-3">
                                <h5 class="text-info mb-1" id="version-stats-unique">-</h5>
                                <small class="text-muted">Unique Versions</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Agent Script Version -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><i class="fas fa-server"></i> Server Script Version:</strong>
                            <span id="server-agent-version">Loading...</span>
                        </div>
                        <div>
                            <strong><i class="fas fa-calendar-alt"></i> Build Date:</strong>
                            <span id="server-build-date">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Version List -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-list"></i> Agent Versions by Host</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 30px;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="version-select-all" onchange="toggleAllVersionSelections()">
                                            </div>
                                        </th>
                                        <th>Host</th>
                                        <th>Agent Version</th>
                                        <th>Build Date</th>
                                        <th>Status</th>
                                        <th>Last Update</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="version-table-body">
                                    <!-- Version data will be loaded here -->
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin"></i> Loading version information...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-warning" onclick="updateSelectedFromVersionModal()" id="update-selected-version-btn">
                    <i class="fas fa-arrow-up"></i> Update Selected
                </button>
                <button type="button" class="btn btn-warning" onclick="updateOutdatedAgents()" id="update-outdated-btn">
                    <i class="fas fa-sync-alt"></i> Update All Outdated
                </button>
                <button type="button" class="btn btn-primary" onclick="refreshVersionData()" id="refresh-version-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Update Progress Modal -->
<div class="modal fade" id="updateProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-arrow-up"></i> Agent Update Progress</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="update-progress" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="update-status">Starting updates...</small>
                </div>
                <div class="update-logs" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.875rem;" id="update-logs">
                    <!-- Update logs will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-update-btn" disabled>Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Control Modal -->
<div class="modal fade" id="agentControlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog"></i> Agent Control</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Host:</strong> <span id="control-host-name"></span>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="controlAgent('start')" id="start-agent-btn">
                        <i class="fas fa-play"></i> Start Agent
                    </button>
                    <button class="btn btn-warning" onclick="controlAgent('restart')" id="restart-agent-btn">
                        <i class="fas fa-redo"></i> Restart Agent
                    </button>
                    <button class="btn btn-danger" onclick="controlAgent('stop')" id="stop-agent-btn">
                        <i class="fas fa-stop"></i> Stop Agent
                    </button>
                    <hr>
                    <button class="btn btn-info" onclick="showEnhancedAgentStatus()" id="status-agent-btn">
                        <i class="fas fa-heartbeat"></i> Health Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="showEditableAgentConfig()" id="config-agent-btn">
                        <i class="fas fa-edit"></i> Edit Configuration
                    </button>
                </div>
                <div class="mt-3" id="agent-status-output" style="font-family: monospace; font-size: 0.875rem; background: #f8f9fa; padding: 0.5rem; border-radius: 0.375rem; display: none;">
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary { border-left: 4px solid #007bff; }
.border-left-success { border-left: 4px solid #28a745; }
.border-left-info { border-left: 4px solid #17a2b8; }
.border-left-warning { border-left: 4px solid #ffc107; }

.host-card {
    transition: all 0.3s ease;
}

.host-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.agent-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.deployment-logs {
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Modal z-index layering */
.modal {
    z-index: 1050;
}

#agentStatusModal {
    z-index: 1060 !important;
}

#agentConfigModal {
    z-index: 1060 !important;
}

#agentControlModal {
    z-index: 1055 !important;
}

/* Ensure modal backdrops don't interfere */
.modal-backdrop {
    z-index: 1040;
}

#agentStatusModal ~ .modal-backdrop {
    z-index: 1059 !important;
}

#agentConfigModal ~ .modal-backdrop {
    z-index: 1059 !important;
}

#agentControlModal ~ .modal-backdrop {
    z-index: 1054 !important;
}</style>
</style>

{% endblock %}

{% block scripts %}
<script>
let hosts = [];
let agents = [];
let selectedHosts = new Set();
let deploymentInProgress = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    setInterval(refreshData, 30000); // Auto-refresh every 30 seconds
});

async function refreshData() {
    try {
        // Load hosts and agents data
        const [hostsResponse, agentsResponse] = await Promise.all([
            fetch('/api/hosts'),
            fetch('/api/agents')
        ]);
        
        const hostsData = await hostsResponse.json();
        const agentsData = await agentsResponse.json();
        
        if (hostsData.success) {
            hosts = hostsData.hosts || [];
        }
        
        if (agentsData.success) {
            agents = agentsData.agents || [];
        }
        
        renderHosts();
        updateStats();
        updateLogAgentSelect();
        
    } catch (error) {
        console.error('Error refreshing data:', error);
        document.getElementById('hosts-container').innerHTML = 
            '<div class="alert alert-danger">Error loading data: ' + error.message + '</div>';
    }
}

function renderHosts() {
    const container = document.getElementById('hosts-container');
    
    if (hosts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-server fa-3x mb-3"></i>
                <h5>No Hosts Configured</h5>
                <p>Add hosts first to deploy agents</p>
                <a href="/hosts" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Hosts
                </a>
            </div>
        `;
        return;
    }

    const html = hosts.map(host => {
        const agent = agents.find(a => a.ip_address === host.ip_address || a.hostname === host.name);
        const isSelected = selectedHosts.has(host.id);
        
        let agentStatus = 'Not Deployed';
        let agentStatusClass = 'secondary';
        let agentStatusIcon = 'fas fa-minus-circle';
        
        if (agent) {
            switch (agent.heartbeat_status) {
                case 'online':
                    agentStatus = 'Online';
                    agentStatusClass = 'success';
                    agentStatusIcon = 'fas fa-check-circle';
                    break;
                case 'warning':
                    agentStatus = 'Warning';
                    agentStatusClass = 'warning';
                    agentStatusIcon = 'fas fa-exclamation-triangle';
                    break;
                case 'offline':
                    agentStatus = 'Offline';
                    agentStatusClass = 'danger';
                    agentStatusIcon = 'fas fa-times-circle';
                    break;
                default:
                    agentStatus = 'Unknown';
                    agentStatusClass = 'secondary';
                    agentStatusIcon = 'fas fa-question-circle';
            }
        }
        
        return `
            <div class="host-card card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="host-${host.id}" 
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleHostSelection(${host.id})">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6 class="mb-1">
                                <i class="fas fa-server"></i> ${host.name}
                            </h6>
                            <small class="text-muted">${host.ip_address}</small>
                            ${host.description ? `<br><small class="text-muted">${host.description}</small>` : ''}
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">SSH User:</small><br>
                            <strong>${host.username}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Host Status:</small><br>
                            <span class="badge bg-${host.status === 'online' ? 'success' : host.status === 'offline' ? 'danger' : 'warning'}">
                                ${host.status || 'Unknown'}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Agent Status:</small><br>
                            <span class="agent-status-badge badge bg-${agentStatusClass}">
                                <i class="${agentStatusIcon}"></i> ${agentStatus}
                            </span>
                        </div>
                        <div class="col-md-2 text-end">
                            ${agent ? `
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showAgentControl('${host.name}', '${host.ip_address}')" title="Control Agent">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewHostAgentLogs('${agent.agent_id}')" title="View Logs">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="uninstallAgent('${host.name}', '${host.ip_address}')" title="Uninstall">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : `
                                <button class="btn btn-sm btn-success" onclick="deploySingleAgent(${host.id})" title="Deploy Agent">
                                    <i class="fas fa-rocket"></i> Deploy
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function updateStats() {
    const totalHosts = hosts.length;
    const deployedAgents = agents.length;
    const onlineAgents = agents.filter(a => a.heartbeat_status === 'online').length;
    const pendingAgents = selectedHosts.size;
    
    document.getElementById('total-hosts').textContent = totalHosts;
    document.getElementById('deployed-agents').textContent = deployedAgents;
    document.getElementById('online-agents').textContent = onlineAgents;
    document.getElementById('pending-agents').textContent = pendingAgents;
}

function toggleHostSelection(hostId) {
    if (selectedHosts.has(hostId)) {
        selectedHosts.delete(hostId);
    } else {
        selectedHosts.add(hostId);
    }
    updateStats();
    updateSelectAllButton();
}

function selectAllHosts() {
    if (selectedHosts.size === hosts.length) {
        // Unselect all
        selectedHosts.clear();
    } else {
        // Select all hosts
        selectedHosts.clear();
        hosts.forEach(host => selectedHosts.add(host.id));
    }
    
    renderHosts();
    updateStats();
    updateSelectAllButton();
}

function updateSelectAllButton() {
    const btn = document.getElementById('select-all-btn');
    
    if (selectedHosts.size === 0) {
        btn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
    } else if (selectedHosts.size === hosts.length) {
        btn.innerHTML = '<i class="fas fa-square"></i> Unselect All';
    } else {
        btn.innerHTML = '<i class="fas fa-minus-square"></i> Select All';
    }
}

async function deploySelectedAgents() {
    if (selectedHosts.size === 0) {
        alert('Please select hosts to deploy agents to');
        return;
    }
    
    if (deploymentInProgress) {
        alert('Deployment already in progress');
        return;
    }
    
    const selectedHostsArray = Array.from(selectedHosts).map(id => 
        hosts.find(h => h.id === id)
    ).filter(h => h);
    
    if (selectedHostsArray.length === 0) {
        alert('No valid hosts selected');
        return;
    }
    
    deploymentInProgress = true;
    const modal = new bootstrap.Modal(document.getElementById('deploymentProgressModal'));
    modal.show();
    
    const progressBar = document.getElementById('deployment-progress');
    const statusElement = document.getElementById('deployment-status');
    const logsElement = document.getElementById('deployment-logs');
    const closeBtn = document.getElementById('close-deployment-btn');
    
    progressBar.style.width = '0%';
    statusElement.textContent = 'Starting deployment...';
    logsElement.textContent = '';
    closeBtn.disabled = true;
    
    try {
        for (let i = 0; i < selectedHostsArray.length; i++) {
            const host = selectedHostsArray[i];
            const progress = ((i + 1) / selectedHostsArray.length) * 100;
            
            progressBar.style.width = progress + '%';
            statusElement.textContent = `Deploying to ${host.name} (${i + 1}/${selectedHostsArray.length})`;
            
            logsElement.textContent += `\n[${new Date().toLocaleTimeString()}] Starting deployment to ${host.name} (${host.ip_address})\n`;
            logsElement.scrollTop = logsElement.scrollHeight;
            
            try {
                await deployAgentToHost(host);
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Successfully deployed to ${host.name}\n`;
            } catch (error) {
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Failed to deploy to ${host.name}: ${error.message}\n`;
            }
            
            logsElement.scrollTop = logsElement.scrollHeight;
        }
        
        statusElement.textContent = 'Deployment completed';
        selectedHosts.clear();
        
        // Refresh data to show new agents
        setTimeout(() => {
            refreshData();
        }, 2000);
        
    } catch (error) {
        statusElement.textContent = 'Deployment failed: ' + error.message;
    } finally {
        deploymentInProgress = false;
        closeBtn.disabled = false;
    }
}

async function deploySingleAgent(hostId) {
    const host = hosts.find(h => h.id === hostId);
    if (!host) return;
    
    selectedHosts.clear();
    selectedHosts.add(hostId);
    await deploySelectedAgents();
}

async function deployAgentToHost(host) {
    try {
        const response = await fetch('/api/deploy_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                host_id: host.id,
                server_url: window.location.origin
            })
        });
        
        // Check if response is ok before trying to parse JSON
        if (!response.ok) {
            // Try to get text response for better error info
            let errorText;
            try {
                errorText = await response.text();
                // Try to parse as JSON first
                const errorData = JSON.parse(errorText);
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            } catch (jsonError) {
                // If not JSON, show the raw text
                throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Deployment failed');
        }
        
        return data;
        
    } catch (error) {
        // Re-throw with more context if it's a network error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error(`Network error: Cannot connect to server. ${error.message}`);
        }
        throw error;
    }
}

function showAgentControl(hostname, ipAddress) {
    document.getElementById('control-host-name').textContent = `${hostname} (${ipAddress})`;
    const modal = new bootstrap.Modal(document.getElementById('agentControlModal'));
    modal.show();
    
    // Store current host for control operations
    window.currentControlHost = { hostname, ipAddress };
}

async function controlAgent(action) {
    if (!window.currentControlHost) return;
    
    const { hostname, ipAddress } = window.currentControlHost;
    const outputElement = document.getElementById('agent-status-output');
    
    outputElement.style.display = 'block';
    outputElement.textContent = `Executing ${action} on ${hostname}...`;
    
    try {
        const response = await fetch('/api/control_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            outputElement.textContent = data.output || `${action} completed successfully`;
            
            // Refresh data to update status
            setTimeout(refreshData, 1000);
        } else {
            outputElement.textContent = `Error: ${data.error}`;
        }
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function checkAgentStatus() {
    await controlAgent('status');
}

async function viewAgentConfig() {
    await controlAgent('config');
}

async function uninstallAgent(hostname, ipAddress) {
    if (!confirm(`Are you sure you want to uninstall the agent from ${hostname}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/uninstall_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Agent uninstalled successfully');
            refreshData();
        } else {
            alert('Failed to uninstall agent: ' + data.error);
        }
    } catch (error) {
        alert('Error uninstalling agent: ' + error.message);
    }
}

function showAgentLogs() {
    const modal = new bootstrap.Modal(document.getElementById('logsModal'));
    modal.show();
}

function viewHostAgentLogs(agentId) {
    document.getElementById('log-agent-select').value = agentId;
    showAgentLogs();
    loadAgentLogs();
}

function updateLogAgentSelect() {
    const select = document.getElementById('log-agent-select');
    select.innerHTML = '<option value="">All Agents</option>' +
        agents.map(agent => `<option value="${agent.agent_id}">${agent.hostname} (${agent.ip_address})</option>`).join('');
}

async function loadAgentLogs() {
    const agentId = document.getElementById('log-agent-select').value;
    const hours = document.getElementById('log-hours-select').value;
    const container = document.getElementById('logs-container');
    
    container.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading logs...</div>';
    
    try {
        const url = `/api/agent/logs?${agentId ? `agent_id=${agentId}&` : ''}hours=${hours}&limit=1000`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            if (data.logs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">No logs found for the selected criteria</div>';
                return;
            }
            
            const logsHtml = data.logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const level = log.level || 'info';
                const levelColor = level === 'error' ? 'text-danger' : level === 'warning' ? 'text-warning' : 'text-info';
                
                return `<div class="mb-1">
                    <span class="text-muted">[${timestamp}]</span>
                    <span class="${levelColor}">[${level.toUpperCase()}]</span>
                    ${log.source ? `<span class="text-success">[${log.source}]</span>` : ''}
                    <span>${log.message}</span>
                </div>`;
            }).join('');
            
            container.innerHTML = logsHtml;
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = '<div class="alert alert-danger">Failed to load logs: ' + data.error + '</div>';
        }
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Error loading logs: ' + error.message + '</div>';
    }
}

// Enhanced Agent Status Dashboard Functions
function showEnhancedAgentStatus() {
    if (!window.currentControlHost) return;
    
    const { hostname, ipAddress } = window.currentControlHost;
    
    // Set host info
    document.getElementById('status-host-name').textContent = hostname;
    document.getElementById('status-host-ip').textContent = ipAddress;
    
    // Reset status indicators
    resetStatusIndicators();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('agentStatusModal'));
    modal.show();
    
    // Find agent data
    const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
    if (agent) {
        updateStatusIndicators(agent);
    }
}

function resetStatusIndicators() {
    // Reset all status indicators to checking state
    const indicators = [
        { id: 'service-status', icon: 'fas fa-circle', color: 'text-secondary', text: 'Checking...' },
        { id: 'heartbeat-status', icon: 'fas fa-heart', color: 'text-secondary', text: 'Checking...' },
        { id: 'scanning-status', icon: 'fas fa-search', color: 'text-secondary', text: 'Checking...' },
        { id: 'logs-status', icon: 'fas fa-file-alt', color: 'text-secondary', text: 'Checking...' }
    ];
    
    indicators.forEach(indicator => {
        const iconElement = document.querySelector(`#${indicator.id}-indicator i`);
        const textElement = document.getElementById(`${indicator.id}-text`);
        
        if (iconElement) {
            iconElement.className = `${indicator.icon} ${indicator.color} fa-2x`;
        }
        if (textElement) {
            textElement.textContent = indicator.text;
        }
    });
    
    // Reset system info
    document.getElementById('agent-version').textContent = '-';
    document.getElementById('agent-platform').textContent = '-';
    document.getElementById('last-heartbeat').textContent = '-';
    document.getElementById('last-scan').textContent = '-';
}

function updateStatusIndicators(agent) {
    // Update service status
    updateStatusIndicator(
        'service-status',
        agent.heartbeat_status === 'online' ? 'success' : agent.heartbeat_status === 'warning' ? 'warning' : 'danger',
        agent.heartbeat_status === 'online' ? 'Active' : agent.heartbeat_status === 'warning' ? 'Warning' : 'Inactive',
        'fas fa-circle'
    );
    
    // Update heartbeat status
    const minutesSince = agent.minutes_since_heartbeat;
    updateStatusIndicator(
        'heartbeat-status',
        minutesSince <= 2 ? 'success' : minutesSince <= 5 ? 'warning' : 'danger',
        minutesSince !== null ? `${minutesSince}m ago` : 'Never',
        'fas fa-heart'
    );
    
    // Update scanning status (assume enabled if heartbeat is good)
    updateStatusIndicator(
        'scanning-status',
        agent.heartbeat_status === 'online' ? 'success' : 'secondary',
        agent.heartbeat_status === 'online' ? 'Active' : 'Unknown',
        'fas fa-search'
    );
    
    // Update log collection status
    updateStatusIndicator(
        'logs-status',
        agent.heartbeat_status === 'online' ? 'success' : 'secondary',
        agent.heartbeat_status === 'online' ? 'Collecting' : 'Inactive',
        'fas fa-file-alt'
    );
    
    // Update system info
    document.getElementById('agent-version').textContent = agent.agent_version || '-';
    document.getElementById('agent-platform').textContent = agent.platform || '-';
    document.getElementById('last-heartbeat').textContent = 
        agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : '-';
    document.getElementById('last-scan').textContent = 
        agent.last_scan ? new Date(agent.last_scan).toLocaleString() : '-';
}

function updateStatusIndicator(statusId, status, text, icon) {
    const iconElement = document.querySelector(`#${statusId}-indicator i`);
    const textElement = document.getElementById(`${statusId}-text`);
    
    let colorClass = 'text-secondary';
    switch (status) {
        case 'success':
            colorClass = 'text-success';
            break;
        case 'warning':
            colorClass = 'text-warning';
            break;
        case 'danger':
            colorClass = 'text-danger';
            break;
    }
    
    if (iconElement) {
        iconElement.className = `${icon} ${colorClass} fa-2x`;
    }
    if (textElement) {
        textElement.textContent = text;
    }
}

async function refreshAgentStatus() {
    if (!window.currentControlHost) return;
    
    const refreshBtn = document.getElementById('refresh-status-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        // Get fresh agent status
        const { hostname, ipAddress } = window.currentControlHost;
        
        // Execute status check command
        const response = await fetch('/api/control_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress,
                action: 'status'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update service details output
            document.getElementById('service-details-output').textContent = data.output || 'No status output received';
        }
        
        // Refresh the data
        await refreshData();
        
        // Update status indicators with fresh data
        const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
        if (agent) {
            updateStatusIndicators(agent);
        }
        
    } catch (error) {
        console.error('Error refreshing agent status:', error);
        document.getElementById('service-details-output').textContent = 'Error: ' + error.message;
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

// Enhanced Agent Configuration Functions
function showEditableAgentConfig() {
    if (!window.currentControlHost) return;
    
    const { hostname, ipAddress } = window.currentControlHost;
    
    // Set host info
    document.getElementById('config-host-name').textContent = hostname;
    document.getElementById('config-host-ip').textContent = ipAddress;
    
    // Find agent data
    const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
    if (!agent) {
        alert('Agent not found. Please ensure the agent is deployed and running.');
        return;
    }
    
    // Load current configuration
    loadAgentConfiguration(agent.agent_id);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('agentConfigModal'));
    modal.show();
}

async function loadAgentConfiguration(agentId) {
    try {
        const response = await fetch(`/api/agent/config/${agentId}`);
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            
            // Populate form fields
            document.getElementById('scan-interval').value = config.scan_interval || 300;
            document.getElementById('heartbeat-interval').value = config.heartbeat_interval || 60;
            document.getElementById('scan-enabled').checked = config.scan_enabled !== false;
            document.getElementById('log-collection-enabled').checked = config.log_collection_enabled !== false;
            document.getElementById('log-paths').value = config.log_paths || '/var/log,/var/log/syslog,/var/log/auth.log';
            
            // Load test configuration
            await loadTestConfigurationSection(config.test_configuration);
        } else {
            console.error('Failed to load agent configuration:', data.error);
            // Set default values
            document.getElementById('scan-interval').value = 300;
            document.getElementById('heartbeat-interval').value = 60;
            document.getElementById('scan-enabled').checked = true;
            document.getElementById('log-collection-enabled').checked = true;
            document.getElementById('log-paths').value = '/var/log,/var/log/syslog,/var/log/auth.log';
            
            // Load default test configuration
            await loadTestConfigurationSection();
        }
    } catch (error) {
        console.error('Error loading agent configuration:', error);
        // Load default test configuration even on error
        await loadTestConfigurationSection();
    }
}

async function saveAgentConfig() {
    if (!window.currentControlHost) return;
    
    const { hostname, ipAddress } = window.currentControlHost;
    const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
    
    if (!agent) {
        alert('Agent not found');
        return;
    }
    
    const saveBtn = document.getElementById('save-config-btn');
    const originalText = saveBtn.innerHTML;
    
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        // Validate form
        const scanInterval = parseInt(document.getElementById('scan-interval').value);
        const heartbeatInterval = parseInt(document.getElementById('heartbeat-interval').value);
        
        if (scanInterval < 60 || scanInterval > 86400) {
            alert('Scan interval must be between 60 and 86400 seconds');
            return;
        }
        
        if (heartbeatInterval < 30 || heartbeatInterval > 300) {
            alert('Heartbeat interval must be between 30 and 300 seconds');
            return;
        }
        
        // Prepare configuration data
        const configData = {
            scan_interval: scanInterval,
            heartbeat_interval: heartbeatInterval,
            scan_enabled: document.getElementById('scan-enabled').checked,
            log_collection_enabled: document.getElementById('log-collection-enabled').checked,
            log_paths: document.getElementById('log-paths').value.trim(),
            test_configuration: getTestConfigurationForSave()
        };
        
        // Save configuration
        const response = await fetch(`/api/agent/config/${agent.agent_id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Agent configuration saved successfully! Changes will take effect within the heartbeat interval.');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('agentConfigModal'));
            modal.hide();
            
            // Refresh data
            setTimeout(refreshData, 1000);
        } else {
            alert('Failed to save configuration: ' + data.error);
        }
        
    } catch (error) {
        alert('Error saving configuration: ' + error.message);
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// Agent Cleanup Tools Functions
function showAgentCleanupTools() {
    const modal = new bootstrap.Modal(document.getElementById('agentCleanupModal'));
    modal.show();
    
    // Refresh statistics when modal opens
    refreshCleanupStats();
}

function refreshCleanupStats() {
    // Update statistics in the cleanup modal
    const totalAgents = agents.length;
    const onlineAgents = agents.filter(a => a.heartbeat_status === 'online').length;
    const offlineAgents = agents.filter(a => a.heartbeat_status === 'offline').length;
    
    // Calculate stale agents (24+ hours since last heartbeat)
    const now = new Date();
    const staleAgents = agents.filter(agent => {
        if (!agent.last_heartbeat) return true;
        try {
            const lastHeartbeat = new Date(agent.last_heartbeat.replace(' ', 'T'));
            const hoursSince = (now - lastHeartbeat) / (1000 * 60 * 60);
            return hoursSince >= 24;
        } catch {
            return true;
        }
    }).length;
    
    document.getElementById('stats-total-agents').textContent = totalAgents;
    document.getElementById('stats-online-agents').textContent = onlineAgents;
    document.getElementById('stats-offline-agents').textContent = offlineAgents;
    document.getElementById('stats-stale-agents').textContent = staleAgents;
}

function showCleanupResult(success, message, details = '') {
    const resultsContainer = document.getElementById('cleanup-results');
    const outputContainer = document.getElementById('cleanup-output');
    
    resultsContainer.style.display = 'block';
    
    const timestamp = new Date().toLocaleTimeString();
    const statusIcon = success ? '✅' : '❌';
    const statusClass = success ? 'text-success' : 'text-danger';
    
    const resultHtml = `
        <div class="mb-2">
            <span class="text-muted">[${timestamp}]</span>
            <span class="${statusClass}">${statusIcon} ${message}</span>
            ${details ? `<br><small class="text-muted ms-4">${details}</small>` : ''}
        </div>
    `;
    
    outputContainer.innerHTML += resultHtml;
    outputContainer.scrollTop = outputContainer.scrollHeight;
    
    // Refresh agent data and stats after cleanup
    if (success) {
        setTimeout(() => {
            refreshData();
            refreshCleanupStats();
        }, 1000);
    }
}

async function cleanupDuplicateAgents() {
    const btn = document.getElementById('cleanup-duplicates-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/agent/cleanup/duplicates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showCleanupResult(true, data.message, 
                `Removed ${data.removed_count} duplicate agent entries`);
        } else {
            showCleanupResult(false, 'Failed to remove duplicates', data.error);
        }
    } catch (error) {
        showCleanupResult(false, 'Error removing duplicates', error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function cleanupStaleAgents() {
    const hours = parseInt(document.getElementById('stale-hours').value) || 24;
    
    if (hours < 1 || hours > 168) {
        alert('Hours must be between 1 and 168 (7 days)');
        return;
    }
    
    if (!confirm(`Are you sure you want to remove agents that haven't sent heartbeats in the last ${hours} hours?`)) {
        return;
    }
    
    const btn = document.getElementById('cleanup-stale-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/agent/cleanup/stale', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ hours: hours })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showCleanupResult(true, data.message, 
                `Removed ${data.removed_count} stale agent entries`);
        } else {
            showCleanupResult(false, 'Failed to remove stale agents', data.error);
        }
    } catch (error) {
        showCleanupResult(false, 'Error removing stale agents', error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function removeAgentsByHost() {
    const hostname = document.getElementById('remove-hostname').value.trim();
    const ipAddress = document.getElementById('remove-ip').value.trim();
    
    if (!hostname && !ipAddress) {
        alert('Please specify either hostname or IP address');
        return;
    }
    
    const criteria = [];
    if (hostname) criteria.push(`hostname="${hostname}"`);
    if (ipAddress) criteria.push(`ip_address="${ipAddress}"`);
    
    const confirmMessage = `Are you sure you want to remove all agents matching ${criteria.join(' or ')}?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const btn = document.getElementById('remove-by-host-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/agent/remove_by_host', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname || null,
                ip_address: ipAddress || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showCleanupResult(true, data.message, 
                `Removed ${data.removed_count} agent entries`);
            
            // Clear the form
            document.getElementById('remove-hostname').value = '';
            document.getElementById('remove-ip').value = '';
        } else {
            showCleanupResult(false, 'Failed to remove agents', data.error);
        }
    } catch (error) {
        showCleanupResult(false, 'Error removing agents', error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Test Configuration Functions
let availableTestConfigurations = {};
let currentTestConfiguration = {};

async function loadTestConfigurationSection(existingConfig = null) {
    const container = document.getElementById('test-configuration-container');
    const loadingElement = document.getElementById('test-config-loading');
    
    try {
        // Fetch available test configurations from the API
        const response = await fetch('/api/agent/test_configurations');
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load test configurations');
        }
        
        availableTestConfigurations = data.test_configurations;
        
        // Use existing config or default configuration
        currentTestConfiguration = existingConfig || data.default_configuration || {};
        
        // Render the test configuration UI
        renderTestConfigurationUI();
        
    } catch (error) {
        console.error('Error loading test configuration:', error);
        loadingElement.innerHTML = `
            <div class="text-center text-danger py-3">
                <i class="fas fa-exclamation-triangle"></i> 
                Failed to load test configuration: ${error.message}
            </div>
        `;
    }
}

function renderTestConfigurationUI() {
    const container = document.getElementById('test-configuration-container');
    
    if (!availableTestConfigurations || Object.keys(availableTestConfigurations).length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-info-circle"></i> 
                No test configurations available
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // Render each category
    for (const [categoryName, categoryTests] of Object.entries(availableTestConfigurations)) {
        const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
        const categoryEnabled = currentTestConfiguration[categoryName] && 
                               Object.keys(currentTestConfiguration[categoryName]).length > 0;
        
        html += `
            <div class="test-category mb-3">
                <div class="card border-0">
                    <div class="card-header bg-light py-2">
                        <div class="form-check">
                            <input class="form-check-input category-checkbox" type="checkbox" 
                                   id="category-${categoryId}" 
                                   ${categoryEnabled ? 'checked' : ''}
                                   onchange="toggleTestCategory('${categoryName}')">
                            <label class="form-check-label fw-bold" for="category-${categoryId}">
                                ${categoryName}
                            </label>
                        </div>
                    </div>
                    <div class="card-body p-2" id="category-body-${categoryId}" 
                         style="display: ${categoryEnabled ? 'block' : 'none'}">
        `;
        
        // Render individual tests in this category
        for (const [testName, testConfig] of Object.entries(categoryTests)) {
            const testId = `${categoryId}-${testName.toLowerCase().replace(/\s+/g, '-')}`;
            const testEnabled = currentTestConfiguration[categoryName] && 
                               currentTestConfiguration[categoryName][testName];
            
            html += `
                <div class="form-check ms-3 mb-2">
                    <input class="form-check-input test-checkbox" type="checkbox" 
                           id="test-${testId}" 
                           data-category="${categoryName}"
                           data-test="${testName}"
                           ${testEnabled ? 'checked' : ''}
                           onchange="toggleIndividualTest('${categoryName}', '${testName}')">
                    <label class="form-check-label" for="test-${testId}">
                        <strong>${testName}</strong>
                        ${testConfig.description ? `<br><small class="text-muted">${testConfig.description}</small>` : ''}
                    </label>
                </div>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function toggleTestCategory(categoryName) {
    const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
    const categoryCheckbox = document.getElementById(`category-${categoryId}`);
    const categoryBody = document.getElementById(`category-body-${categoryId}`);
    
    if (categoryCheckbox.checked) {
        // Enable category - show tests and enable all tests
        categoryBody.style.display = 'block';
        
        if (!currentTestConfiguration[categoryName]) {
            currentTestConfiguration[categoryName] = {};
        }
        
        // Enable all tests in this category
        const categoryTests = availableTestConfigurations[categoryName];
        for (const testName of Object.keys(categoryTests)) {
            currentTestConfiguration[categoryName][testName] = true;
            
            // Update the checkbox
            const testId = `${categoryId}-${testName.toLowerCase().replace(/\s+/g, '-')}`;
            const testCheckbox = document.getElementById(`test-${testId}`);
            if (testCheckbox) {
                testCheckbox.checked = true;
            }
        }
    } else {
        // Disable category - hide tests and disable all tests
        categoryBody.style.display = 'none';
        
        if (currentTestConfiguration[categoryName]) {
            // Disable all tests in this category
            for (const testName of Object.keys(currentTestConfiguration[categoryName])) {
                const testId = `${categoryId}-${testName.toLowerCase().replace(/\s+/g, '-')}`;
                const testCheckbox = document.getElementById(`test-${testId}`);
                if (testCheckbox) {
                    testCheckbox.checked = false;
                }
            }
            
            delete currentTestConfiguration[categoryName];
        }
    }
}

function toggleIndividualTest(categoryName, testName) {
    const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
    const testId = `${categoryId}-${testName.toLowerCase().replace(/\s+/g, '-')}`;
    const testCheckbox = document.getElementById(`test-${testId}`);
    
    if (!currentTestConfiguration[categoryName]) {
        currentTestConfiguration[categoryName] = {};
    }
    
    if (testCheckbox.checked) {
        // Enable the test
        currentTestConfiguration[categoryName][testName] = true;
    } else {
        // Disable the test
        delete currentTestConfiguration[categoryName][testName];
        
        // If no tests are enabled in this category, remove the category
        if (Object.keys(currentTestConfiguration[categoryName]).length === 0) {
            delete currentTestConfiguration[categoryName];
            
            // Uncheck the category checkbox
            const categoryCheckbox = document.getElementById(`category-${categoryId}`);
            if (categoryCheckbox) {
                categoryCheckbox.checked = false;
            }
        }
    }
    
    // Update category checkbox state
    updateCategoryCheckboxState(categoryName);
}

function updateCategoryCheckboxState(categoryName) {
    const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
    const categoryCheckbox = document.getElementById(`category-${categoryId}`);
    
    if (!categoryCheckbox) return;
    
    const hasEnabledTests = currentTestConfiguration[categoryName] && 
                           Object.keys(currentTestConfiguration[categoryName]).length > 0;
    
    categoryCheckbox.checked = hasEnabledTests;
}

async function loadDefaultTestConfiguration() {
    const btn = document.getElementById('load-default-tests-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/agent/test_configurations');
        const data = await response.json();
        
        if (data.success) {
            currentTestConfiguration = data.default_configuration || {};
            renderTestConfigurationUI();
        } else {
            alert('Failed to load default configuration: ' + data.error);
        }
    } catch (error) {
        alert('Error loading default configuration: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function getTestConfigurationForSave() {
    // Return the current test configuration for inclusion in the save payload
    return currentTestConfiguration;
}

// Version Summary and Update Functions
let versionData = {};
let selectedAgentVersions = new Set();

function showVersionSummary() {
    const modal = new bootstrap.Modal(document.getElementById('versionSummaryModal'));
    modal.show();
    
    // Load version data when modal opens
    loadVersionData();
}

async function loadVersionData() {
    try {
        const response = await fetch('/api/agent/versions');
        const data = await response.json();
        
        if (data.success) {
            versionData = data;
            updateVersionSummary();
        } else {
            throw new Error(data.error || 'Failed to load version data');
        }
    } catch (error) {
        console.error('Error loading version data:', error);
        document.getElementById('version-table-body').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle"></i> Error loading version data: ${error.message}
                </td>
            </tr>
        `;
    }
}

function updateVersionSummary() {
    // Update statistics
    const totalAgents = versionData.agents ? versionData.agents.length : 0;
    const latestVersion = versionData.server_version || 'Unknown';
    const outdatedCount = versionData.agents ? versionData.agents.filter(agent => 
        agent.agent_version && agent.agent_version !== versionData.server_version
    ).length : 0;
    const uniqueVersions = versionData.agents ? 
        new Set(versionData.agents.map(agent => agent.agent_version || 'Unknown')).size : 0;
    
    document.getElementById('version-stats-total').textContent = totalAgents;
    document.getElementById('version-stats-latest').textContent = latestVersion;
    document.getElementById('version-stats-outdated').textContent = outdatedCount;
    document.getElementById('version-stats-unique').textContent = uniqueVersions;
    
    // Update server version info
    document.getElementById('server-agent-version').textContent = versionData.server_version || 'Unknown';
    document.getElementById('server-build-date').textContent = versionData.server_build_date || 'Unknown';
    
    // Update table
    renderVersionTable();
}

function renderVersionTable() {
    const tbody = document.getElementById('version-table-body');
    
    if (!versionData.agents || versionData.agents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle"></i> No agents found
                </td>
            </tr>
        `;
        return;
    }
    
    const rows = versionData.agents.map(agent => {
        const isSelected = selectedAgentVersions.has(agent.agent_id);
        const agentVersion = agent.agent_version || 'Unknown';
        const buildDate = agent.build_date || 'Unknown';
        const isOutdated = agentVersion !== versionData.server_version;
        const lastHeartbeat = agent.last_heartbeat ? 
            new Date(agent.last_heartbeat).toLocaleString() : 'Never';
        
        let statusBadge = '';
        let statusClass = 'secondary';
        let statusText = 'Unknown';
        
        if (isOutdated) {
            statusClass = 'warning';
            statusText = 'Outdated';
        } else if (agentVersion === versionData.server_version) {
            statusClass = 'success';
            statusText = 'Up to date';
        }
        
        statusBadge = `<span class="badge bg-${statusClass}">${statusText}</span>`;
        
        return `
            <tr>
                <td>
                    <div class="form-check">
                        <input class="form-check-input version-checkbox" type="checkbox" 
                               id="version-${agent.agent_id}" 
                               data-agent-id="${agent.agent_id}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleVersionSelection('${agent.agent_id}')">
                    </div>
                </td>
                <td>
                    <strong>${agent.hostname}</strong><br>
                    <small class="text-muted">${agent.ip_address}</small>
                </td>
                <td>
                    <code>${agentVersion}</code>
                </td>
                <td>
                    <small>${buildDate}</small>
                </td>
                <td>${statusBadge}</td>
                <td>
                    <small>${lastHeartbeat}</small>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning ${isOutdated ? '' : 'disabled'}" 
                                onclick="updateSingleAgent('${agent.hostname}', '${agent.ip_address}')" 
                                title="Update Agent" ${isOutdated ? '' : 'disabled'}>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-outline-info" 
                                onclick="showAgentVersionDetails('${agent.agent_id}')" 
                                title="View Details">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = rows;
}

function toggleVersionSelection(agentId) {
    if (selectedAgentVersions.has(agentId)) {
        selectedAgentVersions.delete(agentId);
    } else {
        selectedAgentVersions.add(agentId);
    }
    
    updateVersionSelectAllButton();
}

function toggleAllVersionSelections() {
    const selectAllCheckbox = document.getElementById('version-select-all');
    const agentCheckboxes = document.querySelectorAll('.version-checkbox');
    
    if (selectAllCheckbox.checked) {
        // Select all
        agentCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            selectedAgentVersions.add(checkbox.dataset.agentId);
        });
    } else {
        // Unselect all
        agentCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedAgentVersions.clear();
    }
}

function updateVersionSelectAllButton() {
    const selectAllCheckbox = document.getElementById('version-select-all');
    const agentCheckboxes = document.querySelectorAll('.version-checkbox');
    const checkedBoxes = document.querySelectorAll('.version-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === agentCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

async function refreshVersionData() {
    const btn = document.getElementById('refresh-version-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    try {
        await loadVersionData();
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function updateSelectedAgents() {
    if (selectedHosts.size === 0) {
        alert('Please select hosts with deployed agents to update');
        return;
    }
    
    // Filter selected hosts to only include those with agents
    const hostsWithAgents = Array.from(selectedHosts).map(hostId => {
        const host = hosts.find(h => h.id === hostId);
        const agent = agents.find(a => a.ip_address === host.ip_address || a.hostname === host.name);
        return agent ? { host, agent } : null;
    }).filter(item => item !== null);
    
    if (hostsWithAgents.length === 0) {
        alert('No agents found for selected hosts');
        return;
    }
    
    await performAgentUpdates(hostsWithAgents.map(item => item.host));
}

async function updateAllAgents() {
    const hostsWithAgents = hosts.filter(host => 
        agents.find(a => a.ip_address === host.ip_address || a.hostname === host.name)
    );
    
    if (hostsWithAgents.length === 0) {
        alert('No agents found to update');
        return;
    }
    
    const confirmMessage = `Are you sure you want to update all ${hostsWithAgents.length} agent(s)?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    await performAgentUpdates(hostsWithAgents);
}

async function updateSelectedFromVersionModal() {
    if (selectedAgentVersions.size === 0) {
        alert('Please select agents to update from the table');
        return;
    }
    
    const selectedHosts = Array.from(selectedAgentVersions).map(agentId => {
        const agent = versionData.agents.find(a => a.agent_id === agentId);
        return hosts.find(h => h.ip_address === agent.ip_address || h.name === agent.hostname);
    }).filter(host => host !== undefined);
    
    if (selectedHosts.length === 0) {
        alert('No matching hosts found for selected agents');
        return;
    }
    
    // Close version modal
    const versionModal = bootstrap.Modal.getInstance(document.getElementById('versionSummaryModal'));
    versionModal.hide();
    
    await performAgentUpdates(selectedHosts);
}

async function updateOutdatedAgents() {
    if (!versionData.agents) {
        alert('Version data not loaded');
        return;
    }
    
    const outdatedAgents = versionData.agents.filter(agent => 
        agent.agent_version && agent.agent_version !== versionData.server_version
    );
    
    if (outdatedAgents.length === 0) {
        alert('All agents are up to date!');
        return;
    }
    
    const confirmMessage = `Are you sure you want to update ${outdatedAgents.length} outdated agent(s)?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const outdatedHosts = outdatedAgents.map(agent => 
        hosts.find(h => h.ip_address === agent.ip_address || h.name === agent.hostname)
    ).filter(host => host !== undefined);
    
    // Close version modal
    const versionModal = bootstrap.Modal.getInstance(document.getElementById('versionSummaryModal'));
    versionModal.hide();
    
    await performAgentUpdates(outdatedHosts);
}

async function updateSingleAgent(hostname, ipAddress) {
    const host = hosts.find(h => h.name === hostname || h.ip_address === ipAddress);
    if (!host) {
        alert('Host not found');
        return;
    }
    
    await performAgentUpdates([host]);
}

async function performAgentUpdates(hostsToUpdate) {
    if (!hostsToUpdate || hostsToUpdate.length === 0) {
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('updateProgressModal'));
    modal.show();
    
    const progressBar = document.getElementById('update-progress');
    const statusElement = document.getElementById('update-status');
    const logsElement = document.getElementById('update-logs');
    const closeBtn = document.getElementById('close-update-btn');
    
    progressBar.style.width = '0%';
    statusElement.textContent = 'Starting updates...';
    logsElement.textContent = '';
    closeBtn.disabled = true;
    
    let successCount = 0;
    let errorCount = 0;
    
    try {
        for (let i = 0; i < hostsToUpdate.length; i++) {
            const host = hostsToUpdate[i];
            const progress = ((i + 1) / hostsToUpdate.length) * 100;
            
            progressBar.style.width = progress + '%';
            statusElement.textContent = `Updating ${host.name} (${i + 1}/${hostsToUpdate.length})`;
            
            const timestamp = new Date().toLocaleTimeString();
            logsElement.textContent += `\n[${timestamp}] Starting update for ${host.name} (${host.ip_address})\n`;
            logsElement.scrollTop = logsElement.scrollHeight;
            
            try {
                const response = await fetch('/api/update_agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostname: host.name,
                        ip_address: host.ip_address
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Successfully updated ${host.name}\n`;
                    successCount++;
                } else {
                    logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Failed to update ${host.name}: ${data.error}\n`;
                    errorCount++;
                }
            } catch (error) {
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Error updating ${host.name}: ${error.message}\n`;
                errorCount++;
            }
            
            logsElement.scrollTop = logsElement.scrollHeight;
        }
        
        statusElement.textContent = `Updates completed: ${successCount} successful, ${errorCount} failed`;
        
        // Refresh data to show updated versions
        setTimeout(() => {
            refreshData();
            if (document.getElementById('versionSummaryModal').classList.contains('show')) {
                loadVersionData();
            }
        }, 2000);
        
    } catch (error) {
        statusElement.textContent = 'Update process failed: ' + error.message;
    } finally {
        closeBtn.disabled = false;
    }
}

function showAgentVersionDetails(agentId) {
    const agent = versionData.agents.find(a => a.agent_id === agentId);
    if (!agent) {
        alert('Agent not found');
        return;
    }
    
    const details = [
        `Agent ID: ${agent.agent_id}`,
        `Hostname: ${agent.hostname}`,
        `IP Address: ${agent.ip_address}`,
        `Agent Version: ${agent.agent_version || 'Unknown'}`,
        `Build Date: ${agent.build_date || 'Unknown'}`,
        `Platform: ${agent.platform || 'Unknown'}`,
        `Last Heartbeat: ${agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'Never'}`,
        `Status: ${agent.heartbeat_status || 'Unknown'}`
    ];
    
    alert(details.join('\n'));
}

</script>
{% endblock %}
