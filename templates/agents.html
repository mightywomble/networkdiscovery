{% extends "base_patternfly.html" %}

{% block title %}Agent Management - Home Lab{% endblock %}

{% block breadcrumb %}
<li class="pf-c-breadcrumb__item">
    <a href="{{ url_for('index') }}" class="pf-c-breadcrumb__link">Home</a>
</li>
<li class="pf-c-breadcrumb__item" aria-current="page">
    <a href="#" class="pf-c-breadcrumb__link pf-m-current" aria-current="page">Agent Management</a>
</li>
{% endblock %}

{% block styles %}
<style>
/* Agent-specific styles */
.nm-agent-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 3px solid var(--pf-global--BorderColor--100);
    height: 100%;
}

.nm-agent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.nm-agent-card.online {
    border-left-color: var(--pf-global--success-color--100);
}

.nm-agent-card.offline {
    border-left-color: var(--pf-global--danger-color--100);
}

.nm-agent-card.warning {
    border-left-color: var(--pf-global--warning-color--100);
}

.nm-agent-card.selected {
    background-color: var(--pf-global--BackgroundColor--light-300);
    box-shadow: 0 0 0 2px var(--pf-global--primary-color--100);
}

.nm-agent-card-body {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.nm-agent-info {
    flex: 1;
}

.nm-agent-actions {
    margin-top: var(--pf-global--spacer--sm);
    padding-top: var(--pf-global--spacer--sm);
    border-top: 1px solid var(--pf-global--BorderColor--100);
}

.nm-agent-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--pf-global--spacer--sm);
}

.nm-agent-title {
    font-weight: var(--pf-global--FontWeight--bold);
    color: var(--pf-global--Color--dark-100);
    margin: 0;
}

.nm-agent-ip {
    color: var(--pf-global--Color--200);
    font-size: var(--pf-global--FontSize--sm);
    margin: 0;
}

.nm-agent-status {
    display: flex;
    align-items: center;
    gap: var(--pf-global--spacer--xs);
    font-size: var(--pf-global--FontSize--sm);
}

.nm-agent-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--pf-global--spacer--md);
    margin-bottom: var(--pf-global--spacer--sm);
}

.nm-agent-detail {
    display: flex;
    flex-direction: column;
    gap: var(--pf-global--spacer--xs);
}

.nm-agent-detail-label {
    color: var(--pf-global--Color--200);
    font-size: var(--pf-global--FontSize--xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.nm-agent-detail-value {
    color: var(--pf-global--Color--dark-100);
    font-weight: var(--pf-global--FontWeight--semi-bold);
    margin: 0;
}

.nm-action-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--pf-global--spacer--lg);
}

.nm-empty-state {
    text-align: center;
    padding: var(--pf-global--spacer--2xl) var(--pf-global--spacer--md);
}

.nm-empty-state-icon {
    font-size: 4rem;
    color: var(--pf-global--Color--200);
    margin-bottom: var(--pf-global--spacer--md);
}

/* Progress bars and loading states */
.nm-progress-container {
    background-color: var(--pf-global--BackgroundColor--light-300);
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin-top: var(--pf-global--spacer--xs);
}

.nm-progress-bar {
    height: 100%;
    background-color: var(--pf-global--primary-color--100);
    width: 0%;
    transition: width 0.3s ease, background-color 0.3s ease;
}

.nm-progress-bar.success {
    background-color: var(--pf-global--success-color--100);
}

.nm-progress-bar.danger {
    background-color: var(--pf-global--danger-color--100);
}

.nm-progress-bar.warning {
    background-color: var(--pf-global--warning-color--100);
}

.nm-progress-animated {
    animation: progress-animation 2s infinite linear;
}

@keyframes progress-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Modal customizations */
.pf-c-modal-box {
    max-width: 90vw;
    max-height: 90vh;
}

.pf-c-modal-box.pf-m-xl {
    max-width: 95vw;
}

/* Code blocks in modals */
.nm-code-block {
    background-color: var(--pf-global--BackgroundColor--dark-300);
    color: var(--pf-global--Color--light-100);
    font-family: 'Courier New', monospace;
    font-size: var(--pf-global--FontSize--sm);
    padding: var(--pf-global--spacer--md);
    border-radius: var(--pf-global--BorderRadius--sm);
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 400px;
    overflow-y: auto;
}

/* Responsive design */
@media (max-width: 768px) {
    .nm-agent-details {
        flex-direction: column;
        gap: var(--pf-global--spacer--sm);
    }
    
    .nm-agent-card {
        margin-bottom: var(--pf-global--spacer--sm);
    }
}
</style>
{% endblock %}

{% block content %}
<section class="pf-c-page__main-section pf-m-light">
    <div class="pf-c-content">
        <h1>
            <i class="fas fa-robot pf-u-mr-sm"></i>
            Agent Management
        </h1>
        <p class="pf-u-color-200">Deploy and manage network monitoring agents via SSH</p>
    </div>
</section>

<!-- Agent Statistics -->
<section class="pf-c-page__main-section" style="padding-top: 0;">
    <div class="pf-l-gallery pf-m-gutter" style="grid-template-columns: repeat(4, 1fr);">
        <div class="pf-c-card nm-stat-card">
            <div class="pf-c-card__body pf-u-text-align-center">
                <div class="nm-stat-value" style="color: var(--pf-global--primary-color--100)" id="total-hosts">-</div>
                <div class="nm-stat-label">Total Hosts</div>
            </div>
        </div>
        <div class="pf-c-card nm-stat-card">
            <div class="pf-c-card__body pf-u-text-align-center">
                <div class="nm-stat-value" style="color: var(--pf-global--success-color--100)" id="deployed-agents">-</div>
                <div class="nm-stat-label">Agents Deployed</div>
            </div>
        </div>
        <div class="pf-c-card nm-stat-card">
            <div class="pf-c-card__body pf-u-text-align-center">
                <div class="nm-stat-value" style="color: var(--pf-global--info-color--100)" id="online-agents">-</div>
                <div class="nm-stat-label">Online Agents</div>
            </div>
        </div>
        <div class="pf-c-card nm-stat-card">
            <div class="pf-c-card__body pf-u-text-align-center">
                <div class="nm-stat-value" style="color: var(--pf-global--warning-color--100)" id="pending-agents">-</div>
                <div class="nm-stat-label">Pending</div>
            </div>
        </div>
    </div>
</section>

<!-- Action Buttons -->
<section class="pf-c-page__main-section" style="padding-top: 0;">
    <div class="nm-action-buttons">
        <div class="pf-c-button-group">
            <button class="pf-c-button pf-m-primary" onclick="deploySelectedAgents()" disabled id="deploy-selected-btn">
                <i class="fas fa-rocket pf-u-mr-sm"></i>
                Deploy Selected
            </button>
            <button class="pf-c-button pf-m-secondary" onclick="updateSelectedAgents()" disabled id="update-selected-btn">
                <i class="fas fa-arrow-up pf-u-mr-sm"></i>
                Update Selected
            </button>
        </div>
        <div class="pf-c-button-group">
            <button class="pf-c-button pf-m-control" onclick="selectAllHosts()" id="select-all-btn">
                <i class="fas fa-check-square pf-u-mr-sm"></i>
                Select All
            </button>
            <button class="pf-c-button pf-m-control" onclick="refreshData()">
                <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                Refresh
            </button>
        </div>
    </div>
</section>

<!-- Agents List -->
<section class="pf-c-page__main-section" style="padding-top: 0;">
    <div id="hosts-container">
        <div class="nm-loading">
            <div class="pf-c-spinner pf-m-lg" role="progressbar" aria-label="Loading agents">
                <span class="pf-c-spinner__clipper"></span>
                <span class="pf-c-spinner__lead-ball"></span>
                <span class="pf-c-spinner__tail-ball"></span>
            </div>
        </div>
    </div>
</section>

<!-- PatternFly Modals -->

<!-- Deployment Progress Modal -->
<div class="pf-c-backdrop" id="deployment-progress-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="deployment-progress-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeDeploymentModal()" id="close-deployment-btn" disabled>
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="deployment-progress-title">
                    <i class="fas fa-rocket pf-u-mr-sm"></i>
                    Agent Deployment Progress
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-u-mb-md">
                    <div class="pf-c-progress" id="deployment-progress-container">
                        <div class="pf-c-progress__description">
                            <span id="deployment-status">Starting deployment...</span>
                        </div>
                        <div class="pf-c-progress__status">
                            <span class="pf-c-progress__measure" id="deployment-progress-text">0%</span>
                        </div>
                        <div class="pf-c-progress__bar">
                            <div class="pf-c-progress__indicator" style="width: 0%;" id="deployment-progress">
                                <span class="pf-c-progress__measure">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nm-code-block" id="deployment-logs"></div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Logs Modal -->
<div class="pf-c-backdrop" id="logs-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-xl" role="dialog" aria-modal="true" aria-labelledby="logs-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeLogsModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="logs-title">
                    <i class="fas fa-file-alt pf-u-mr-sm"></i>
                    Agent Logs
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-l-flex pf-u-mb-md">
                    <div class="pf-l-flex__item pf-m-flex-1">
                        <select class="pf-c-form-control" id="log-agent-select">
                            <option value="">All Agents</option>
                        </select>
                    </div>
                    <div class="pf-l-flex__item">
                        <select class="pf-c-form-control" id="log-hours-select">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div class="pf-l-flex__item">
                        <button class="pf-c-button pf-m-primary" onclick="loadAgentLogs()">
                            <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="nm-code-block" style="max-height: 500px;" id="logs-container">
                    <div style="text-align: center; padding: 2rem; color: var(--pf-global--Color--light-200);">
                        Select an agent and click refresh to view logs
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Status Modal -->
<div class="pf-c-backdrop" id="agent-status-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="agent-status-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeAgentStatusModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="agent-status-title">
                    <i class="fas fa-heartbeat pf-u-mr-sm"></i>
                    Agent Health Dashboard
                </h1>
                <p class="pf-c-modal-box__description">
                    <strong id="status-host-name"></strong> (<span id="status-host-ip"></span>)
                </p>
            </header>
            <div class="pf-c-modal-box__body">
                <!-- Status Overview Cards -->
                <div class="pf-l-gallery pf-m-gutter pf-u-mb-md">
                    <div class="pf-c-card pf-m-compact">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="pf-u-mb-sm">
                                <i class="fas fa-circle fa-2x" id="service-status-icon"></i>
                            </div>
                            <h6 class="pf-c-card__title pf-u-mb-xs">Service Status</h6>
                            <small id="service-status-text">Checking...</small>
                        </div>
                    </div>
                    <div class="pf-c-card pf-m-compact">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="pf-u-mb-sm">
                                <i class="fas fa-heart fa-2x" id="heartbeat-status-icon"></i>
                            </div>
                            <h6 class="pf-c-card__title pf-u-mb-xs">Heartbeat</h6>
                            <small id="heartbeat-status-text">Checking...</small>
                        </div>
                    </div>
                    <div class="pf-c-card pf-m-compact">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="pf-u-mb-sm">
                                <i class="fas fa-search fa-2x" id="scanning-status-icon"></i>
                            </div>
                            <h6 class="pf-c-card__title pf-u-mb-xs">Scanning</h6>
                            <small id="scanning-status-text">Checking...</small>
                        </div>
                    </div>
                    <div class="pf-c-card pf-m-compact">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="pf-u-mb-sm">
                                <i class="fas fa-file-alt fa-2x" id="logs-status-icon"></i>
                            </div>
                            <h6 class="pf-c-card__title pf-u-mb-xs">Log Collection</h6>
                            <small id="logs-status-text">Checking...</small>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="pf-c-expandable-section" aria-expanded="false">
                    <button type="button" class="pf-c-expandable-section__toggle" aria-expanded="false" onclick="toggleExpandableSection(this)">
                        <span class="pf-c-expandable-section__toggle-icon">
                            <i class="fas fa-angle-right" aria-hidden="true"></i>
                        </span>
                        <span class="pf-c-expandable-section__toggle-text">
                            <i class="fas fa-server pf-u-mr-sm"></i>
                            System Information
                        </span>
                    </button>
                    <div class="pf-c-expandable-section__content">
                        <div class="pf-l-flex pf-u-mt-md">
                            <div class="pf-l-flex__item pf-m-flex-1">
                                <dl class="pf-c-description-list">
                                    <div class="pf-c-description-list__group">
                                        <dt class="pf-c-description-list__term">Agent Version</dt>
                                        <dd class="pf-c-description-list__description">
                                            <div class="pf-c-description-list__text" id="agent-version">-</div>
                                        </dd>
                                    </div>
                                    <div class="pf-c-description-list__group">
                                        <dt class="pf-c-description-list__term">Platform</dt>
                                        <dd class="pf-c-description-list__description">
                                            <div class="pf-c-description-list__text" id="agent-platform">-</div>
                                        </dd>
                                    </div>
                                </dl>
                            </div>
                            <div class="pf-l-flex__item pf-m-flex-1">
                                <dl class="pf-c-description-list">
                                    <div class="pf-c-description-list__group">
                                        <dt class="pf-c-description-list__term">Last Heartbeat</dt>
                                        <dd class="pf-c-description-list__description">
                                            <div class="pf-c-description-list__text" id="last-heartbeat">-</div>
                                        </dd>
                                    </div>
                                    <div class="pf-c-description-list__group">
                                        <dt class="pf-c-description-list__term">Last Scan</dt>
                                        <dd class="pf-c-description-list__description">
                                            <div class="pf-c-description-list__text" id="last-scan">-</div>
                                        </dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Details -->
                <div class="pf-c-expandable-section" aria-expanded="false">
                    <button type="button" class="pf-c-expandable-section__toggle" aria-expanded="false" onclick="toggleExpandableSection(this)">
                        <span class="pf-c-expandable-section__toggle-icon">
                            <i class="fas fa-angle-right" aria-hidden="true"></i>
                        </span>
                        <span class="pf-c-expandable-section__toggle-text">
                            <i class="fas fa-cogs pf-u-mr-sm"></i>
                            Service Details
                        </span>
                    </button>
                    <div class="pf-c-expandable-section__content">
                        <div class="nm-code-block pf-u-mt-md" style="max-height: 300px;" id="service-details-output">
                            Click "Refresh Status" to load service details
                        </div>
                    </div>
                </div>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-primary" onclick="refreshAgentStatus()" id="refresh-status-btn">
                    <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                    Refresh Status
                </button>
                <button class="pf-c-button pf-m-link" onclick="closeAgentStatusModal()">Close</button>
            </footer>
        </div>
    </div>
</div>

<!-- Agent Data Modal -->
<div class="pf-c-backdrop" id="agent-data-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-xl" role="dialog" aria-modal="true" aria-labelledby="agent-data-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeAgentDataModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="agent-data-title">
                    <i class="fas fa-database pf-u-mr-sm"></i>
                    Agent Data
                </h1>
                <p class="pf-c-modal-box__description">
                    <strong id="data-agent-name"></strong> - Last scan data
                </p>
            </header>
            <div class="pf-c-modal-box__body">
                <!-- Tabs for different data sections -->
                <div class="pf-c-tabs" id="agent-data-tabs">
                    <ul class="pf-c-tabs__list" role="tablist">
                        <li class="pf-c-tabs__item" role="presentation">
                            <button class="pf-c-tabs__link pf-m-current" id="summary-tab" aria-controls="summary-tab-panel" role="tab">
                                <span class="pf-c-tabs__item-text">Summary</span>
                            </button>
                        </li>
                        <li class="pf-c-tabs__item" role="presentation">
                            <button class="pf-c-tabs__link" id="network-scans-tab" aria-controls="network-scans-tab-panel" role="tab">
                                <span class="pf-c-tabs__item-text">Network Scans</span>
                            </button>
                        </li>
                        <li class="pf-c-tabs__item" role="presentation">
                            <button class="pf-c-tabs__link" id="test-results-tab" aria-controls="test-results-tab-panel" role="tab">
                                <span class="pf-c-tabs__item-text">Test Results</span>
                            </button>
                        </li>
                        <li class="pf-c-tabs__item" role="presentation">
                            <button class="pf-c-tabs__link" id="raw-data-tab" aria-controls="raw-data-tab-panel" role="tab">
                                <span class="pf-c-tabs__item-text">Raw Data</span>
                            </button>
                        </li>
                    </ul>
                </div>
                
                <!-- Tab Panels -->
                <div class="pf-c-tabs__content">
                    <!-- Summary Panel -->
                    <section class="pf-c-tabs__item-body" id="summary-tab-panel" role="tabpanel">
                        <div id="agent-summary-content">
                            <div class="pf-u-text-align-center pf-u-p-lg">
                                <div class="pf-c-spinner" role="progressbar">
                                    <span class="pf-c-spinner__clipper"></span>
                                    <span class="pf-c-spinner__lead-ball"></span>
                                    <span class="pf-c-spinner__tail-ball"></span>
                                </div>
                                <p class="pf-u-mt-md">Loading agent data...</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Network Scans Panel -->
                    <section class="pf-c-tabs__item-body pf-m-hidden" id="network-scans-tab-panel" role="tabpanel">
                        <div id="network-scans-content">
                            <div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">
                                Select Summary tab first to load data
                            </div>
                        </div>
                    </section>
                    
                    <!-- Test Results Panel -->
                    <section class="pf-c-tabs__item-body pf-m-hidden" id="test-results-tab-panel" role="tabpanel">
                        <div id="test-results-content">
                            <div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">
                                Select Summary tab first to load data
                            </div>
                        </div>
                    </section>
                    
                    <!-- Raw Data Panel -->
                    <section class="pf-c-tabs__item-body pf-m-hidden" id="raw-data-tab-panel" role="tabpanel">
                        <div id="raw-data-content">
                            <div class="nm-code-block" style="max-height: 500px;" id="raw-data-display">
                                <div class="pf-u-text-align-center pf-u-p-lg pf-u-color-light-200">
                                    Select Summary tab first to load data
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version Summary Modal -->
<div class="pf-c-backdrop" id="version-summary-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-xl" role="dialog" aria-modal="true" aria-labelledby="version-summary-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeVersionSummaryModal()" id="close-version-modal-btn">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="version-summary-title">
                    <i class="fas fa-code-branch pf-u-mr-sm"></i>
                    Agent Version Management
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <!-- Statistics Section -->
                <div class="pf-l-gallery pf-m-gutter pf-u-mb-lg" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="pf-c-card nm-stat-card">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="nm-stat-value" style="color: var(--pf-global--warning-color--100)" id="version-latest-version">-</div>
                            <div class="nm-stat-label">Latest Version</div>
                        </div>
                    </div>
                    <div class="pf-c-card nm-stat-card">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="nm-stat-value" style="color: var(--pf-global--primary-color--100)" id="version-total-hosts">-</div>
                            <div class="nm-stat-label">Total Hosts</div>
                        </div>
                    </div>
                    <div class="pf-c-card nm-stat-card">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="nm-stat-value" style="color: var(--pf-global--success-color--100)" id="version-total-agents">-</div>
                            <div class="nm-stat-label">Total Agents</div>
                        </div>
                    </div>
                    <div class="pf-c-card nm-stat-card">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="nm-stat-value" style="color: var(--pf-global--info-color--100)" id="version-online-agents">-</div>
                            <div class="nm-stat-label">Online Agents</div>
                        </div>
                    </div>
                    <div class="pf-c-card nm-stat-card">
                        <div class="pf-c-card__body pf-u-text-align-center">
                            <div class="nm-stat-value" style="color: var(--pf-global--danger-color--100)" id="version-offline-agents">-</div>
                            <div class="nm-stat-label">Offline Agents</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="pf-u-text-align-center pf-u-mb-lg">
                    <div class="pf-c-button-group">
                        <button class="pf-c-button pf-m-primary" onclick="updateSelectedAgents()" disabled id="update-selected-agents-btn">
                            <i class="fas fa-arrow-up pf-u-mr-sm"></i>
                            Update Selected
                        </button>
                        <button class="pf-c-button pf-m-secondary" onclick="updateAllAgents()" disabled id="update-all-agents-btn">
                            <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                            Update All
                        </button>
                        <button class="pf-c-button pf-m-control" onclick="selectAllVersionHosts()" id="select-all-version-btn">
                            <i class="fas fa-check-square pf-u-mr-sm"></i>
                            Select All
                        </button>
                        <button class="pf-c-button pf-m-control" onclick="refreshVersionSummary()" id="refresh-versions-btn">
                            <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Update Progress (Hidden by default) -->
                <div class="pf-u-mb-lg" id="version-update-progress-container" hidden>
                    <div class="pf-c-progress">
                        <div class="pf-c-progress__description">
                            <span id="version-update-status">Starting update...</span>
                        </div>
                        <div class="pf-c-progress__status">
                            <span class="pf-c-progress__measure" id="version-update-progress-text">0%</span>
                        </div>
                        <div class="pf-c-progress__bar">
                            <div class="pf-c-progress__indicator" style="width: 0%;" id="version-update-progress">
                                <span class="pf-c-progress__measure">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="nm-code-block pf-u-mt-md" style="max-height: 200px;" id="version-update-logs"></div>
                </div>
                
                <!-- Version Summary Content -->
                <div id="version-summary-content">
                    <div class="pf-u-text-align-center pf-u-p-lg">
                        <div class="pf-c-spinner" role="progressbar">
                            <span class="pf-c-spinner__clipper"></span>
                            <span class="pf-c-spinner__lead-ball"></span>
                            <span class="pf-c-spinner__tail-ball"></span>
                        </div>
                        <p class="pf-u-mt-md">Loading version information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Run Progress Modal -->
<div class="pf-c-backdrop" id="agent-run-progress-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="agent-run-progress-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeAgentRunModal()" id="close-agent-run-btn" disabled>
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="agent-run-progress-title">
                    <i class="fas fa-play pf-u-mr-sm"></i>
                    Agent Scan Progress
                </h1>
                <p class="pf-c-modal-box__description">
                    <strong id="run-agent-name"></strong> - Triggering immediate network scan
                </p>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-u-mb-md">
                    <div class="pf-c-progress" id="agent-run-progress-container">
                        <div class="pf-c-progress__description">
                            <span id="agent-run-status">Initializing scan...</span>
                        </div>
                        <div class="pf-c-progress__status">
                            <span class="pf-c-progress__measure" id="agent-run-progress-text">0%</span>
                        </div>
                        <div class="pf-c-progress__bar">
                            <div class="pf-c-progress__indicator" style="width: 0%;" id="agent-run-progress">
                                <span class="pf-c-progress__measure">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nm-code-block" id="agent-run-logs"></div>
            </div>
            <footer class="pf-c-modal-box__footer">
                <button class="pf-c-button pf-m-primary" onclick="closeAgentRunModal()" id="agent-run-ok-btn" disabled>OK</button>
            </footer>
        </div>
    </div>
</div>

<!-- Agent Cleanup Tools Modal -->
<div class="pf-c-backdrop" id="cleanup-tools-backdrop" hidden>
    <div class="pf-l-bullseye">
        <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="cleanup-tools-title">
            <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="closeCleanupToolsModal()">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <header class="pf-c-modal-box__header">
                <h1 class="pf-c-modal-box__title" id="cleanup-tools-title">
                    <i class="fas fa-broom pf-u-mr-sm"></i>
                    Agent Database Cleanup Tools
                </h1>
            </header>
            <div class="pf-c-modal-box__body">
                <div class="pf-c-alert pf-m-warning pf-m-inline pf-u-mb-md">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p class="pf-c-alert__title">These tools permanently remove agent records from the database. Use with caution!</p>
                </div>
                
                <div id="cleanup-tools-content">
                    <div class="pf-u-text-align-center pf-u-p-lg">
                        <div class="pf-c-spinner" role="progressbar">
                            <span class="pf-c-spinner__clipper"></span>
                            <span class="pf-c-spinner__lead-ball"></span>
                            <span class="pf-c-spinner__tail-ball"></span>
                        </div>
                        <p class="pf-u-mt-md">Loading cleanup tools...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let hosts = [];
let agents = [];
let selectedHosts = new Set();
let deploymentInProgress = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    setInterval(refreshData, 30000); // Auto-refresh every 30 seconds
});

async function refreshData() {
    try {
        // Load hosts and agents data
        const [hostsResponse, agentsResponse] = await Promise.all([
            fetch('/api/hosts'),
            fetch('/api/agents')
        ]);
        
        const hostsData = await hostsResponse.json();
        const agentsData = await agentsResponse.json();
        
        if (hostsData.success) {
            hosts = hostsData.hosts || [];
        }
        
        if (agentsData.success) {
            agents = agentsData.agents || [];
        }
        
        renderHosts();
        updateStats();
        updateLogAgentSelect();
        
    } catch (error) {
        console.error('Error refreshing data:', error);
        showAlert('danger', 'Error loading data: ' + error.message);
    }
}

// Function to determine agent status based on heartbeat
function determineAgentStatus(agent) {
    if (!agent) {
        return {
            status: 'Not Deployed',
            statusClass: 'secondary',
            statusIcon: 'fas fa-minus-circle',
            cardClass: '',
            heartbeatStatus: null
        };
    }
    
    // Use the heartbeat status calculated by the server if available
    if (agent.heartbeat_status) {
        const serverStatus = agent.heartbeat_status.toLowerCase();
        switch (serverStatus) {
            case 'online':
                return {
                    status: 'Online',
                    statusClass: 'success',
                    statusIcon: 'fas fa-check-circle',
                    cardClass: 'online',
                    heartbeatStatus: 'online'
                };
            case 'warning':
                return {
                    status: 'Warning',
                    statusClass: 'warning',
                    statusIcon: 'fas fa-exclamation-triangle',
                    cardClass: 'warning',
                    heartbeatStatus: 'warning'
                };
            case 'offline':
                return {
                    status: 'Offline',
                    statusClass: 'danger',
                    statusIcon: 'fas fa-times-circle',
                    cardClass: 'offline',
                    heartbeatStatus: 'offline'
                };
            case 'never':
                return {
                    status: 'Never Connected',
                    statusClass: 'danger',
                    statusIcon: 'fas fa-times-circle',
                    cardClass: 'offline',
                    heartbeatStatus: 'offline'
                };
        }
    }
    
    // Fallback: Check if agent has last_heartbeat timestamp
    if (agent.last_heartbeat) {
        const now = new Date();
        // Handle different timestamp formats from server
        let lastHeartbeat;
        try {
            // Try parsing as-is first (ISO format)
            lastHeartbeat = new Date(agent.last_heartbeat);
            // If that gives invalid date, try with 'T' separator
            if (isNaN(lastHeartbeat.getTime())) {
                lastHeartbeat = new Date(agent.last_heartbeat.replace(' ', 'T') + 'Z');
            }
        } catch (e) {
            console.warn('Failed to parse heartbeat timestamp:', agent.last_heartbeat);
            return {
                status: 'Unknown',
                statusClass: 'secondary',
                statusIcon: 'fas fa-question-circle',
                cardClass: '',
                heartbeatStatus: 'unknown'
            };
        }
        
        const minutesSinceHeartbeat = Math.floor((now - lastHeartbeat) / (1000 * 60));
        
        // Update the agent object with calculated minutes
        agent.minutes_since_heartbeat = minutesSinceHeartbeat;
        
        // Determine status based on time since last heartbeat
        if (minutesSinceHeartbeat <= 5) {
            // Online: heartbeat within last 5 minutes
            return {
                status: 'Online',
                statusClass: 'success',
                statusIcon: 'fas fa-check-circle',
                cardClass: 'online',
                heartbeatStatus: 'online'
            };
        } else if (minutesSinceHeartbeat <= 15) {
            // Warning: heartbeat between 5-15 minutes ago
            return {
                status: 'Warning',
                statusClass: 'warning',
                statusIcon: 'fas fa-exclamation-triangle',
                cardClass: 'warning',
                heartbeatStatus: 'warning'
            };
        } else {
            // Offline: heartbeat more than 15 minutes ago
            return {
                status: 'Offline',
                statusClass: 'danger',
                statusIcon: 'fas fa-times-circle',
                cardClass: 'offline',
                heartbeatStatus: 'offline'
            };
        }
    } else {
        // No heartbeat data - check if agent exists but never connected
        return {
            status: 'Never Connected',
            statusClass: 'danger',
            statusIcon: 'fas fa-times-circle',
            cardClass: 'offline',
            heartbeatStatus: 'offline'
        };
    }
}

function renderHosts() {
    const container = document.getElementById('hosts-container');
    
    if (hosts.length === 0) {
        container.innerHTML = `
            <div class="nm-empty-state">
                <div class="nm-empty-state-icon">
                    <i class="fas fa-server"></i>
                </div>
                <h3>No Hosts Configured</h3>
                <p class="pf-u-color-200 pf-u-mb-md">Add hosts first to deploy agents</p>
                <a href="/hosts" class="pf-c-button pf-m-primary">
                    <i class="fas fa-plus pf-u-mr-sm"></i>
                    Add Hosts
                </a>
            </div>
        `;
        return;
    }

    const hostCards = hosts.map(host => {
        const agent = agents.find(a => a.ip_address === host.ip_address || a.hostname === host.name);
        const isSelected = selectedHosts.has(host.id);
        
        // Determine agent status using the new robust logic
        const agentStatusInfo = determineAgentStatus(agent);
        if (agent) {
            // Update the agent object with the calculated status for consistency
            agent.heartbeat_status = agentStatusInfo.heartbeatStatus;
        }
        const agentStatus = agentStatusInfo.status;
        const agentStatusClass = agentStatusInfo.statusClass;
        const agentStatusIcon = agentStatusInfo.statusIcon;
        const cardClass = agentStatusInfo.cardClass;
        
        return `
            <div class="pf-l-gallery__item">
                <div class="pf-c-card nm-agent-card ${cardClass} ${isSelected ? 'selected' : ''}" onclick="toggleHostSelection(${host.id}, event)">
                    <div class="pf-c-card__header">
                        <div class="pf-c-card__header-main">
                            <div class="nm-agent-header">
                                <div>
                                    <h3 class="nm-agent-title">
                                        <i class="fas fa-server pf-u-mr-xs"></i>
                                        ${host.name}
                                    </h3>
                                    <p class="nm-agent-ip">${host.ip_address}</p>
                                </div>
                                <div class="pf-c-check">
                                    <input class="pf-c-check__input" type="checkbox" 
                                           id="agent-check-${host.id}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="event.stopPropagation(); toggleHostSelection(${host.id})">
                                    <label class="pf-c-check__label" for="agent-check-${host.id}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pf-c-card__body nm-agent-card-body">
                        <div class="nm-agent-info">
                            <div class="nm-agent-details">
                                <div class="nm-agent-detail">
                                    <p class="nm-agent-detail-label">SSH User</p>
                                    <p class="nm-agent-detail-value">${host.username}</p>
                                </div>
                                <div class="nm-agent-detail">
                                    <p class="nm-agent-detail-label">Host Status</p>
                                    <span class="pf-c-label pf-m-${host.status === 'online' ? 'green' : host.status === 'offline' ? 'red' : 'orange'}">
                                        ${host.status || 'Unknown'}
                                    </span>
                                </div>
                                <div class="nm-agent-detail">
                                    <p class="nm-agent-detail-label">Agent Status</p>
                                    <span class="pf-c-label pf-m-${agentStatusClass}">
                                        <i class="${agentStatusIcon} pf-u-mr-xs"></i>
                                        ${agentStatus}
                                    </span>
                                </div>
                                ${agent ? `
                                <div class="nm-agent-detail">
                                    <p class="nm-agent-detail-label">Last Communication</p>
                                    <p class="nm-agent-detail-value">${agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'Never'}</p>
                                </div>
                                ` : ''}
                            </div>
                            ${host.description ? `<p class="pf-u-color-200 pf-u-mb-sm">${host.description}</p>` : ''}
                        </div>
                        
                        <div class="nm-agent-actions">
                            ${agent ? `
                                <div class="pf-c-button-group pf-m-compact">
                                    <button class="pf-c-button pf-m-secondary pf-m-small" onclick="event.stopPropagation(); showAgentControl('${host.name}', '${host.ip_address}')" title="Control Agent">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="pf-c-button pf-m-tertiary pf-m-small" onclick="event.stopPropagation(); runAgentNow('${host.name}', '${host.ip_address}')" title="Run Agent Now">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="pf-c-button pf-m-tertiary pf-m-small" onclick="event.stopPropagation(); viewHostAgentLogs('${agent.agent_id}')" title="View Logs">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                    <button class="pf-c-button pf-m-tertiary pf-m-small" onclick="event.stopPropagation(); viewLastAgentData('${agent.agent_id}')" title="View Last Data">
                                        <i class="fas fa-database"></i>
                                    </button>
                                    <button class="pf-c-button pf-m-danger pf-m-small" onclick="event.stopPropagation(); uninstallAgent('${host.name}', '${host.ip_address}')" title="Uninstall">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : `
                                <button class="pf-c-button pf-m-primary pf-m-small pf-m-block" onclick="event.stopPropagation(); deploySingleAgent(${host.id})">
                                    <i class="fas fa-rocket pf-u-mr-xs"></i>
                                    Deploy Agent
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `<div class="pf-l-gallery pf-m-gutter">${hostCards}</div>`;
}

function updateStats() {
    const totalHosts = hosts.length;
    const deployedAgents = agents.length;
    
    // Update agent statuses before counting
    let onlineCount = 0;
    let offlineCount = 0;
    let warningCount = 0;
    
    agents.forEach(agent => {
        const statusInfo = determineAgentStatus(agent);
        switch (statusInfo.heartbeatStatus) {
            case 'online':
                onlineCount++;
                break;
            case 'warning':
                warningCount++;
                break;
            case 'offline':
            default:
                offlineCount++;
                break;
        }
    });
    
    const pendingAgents = selectedHosts.size;
    
    document.getElementById('total-hosts').textContent = totalHosts;
    document.getElementById('deployed-agents').textContent = deployedAgents;
    document.getElementById('online-agents').textContent = onlineCount;
    document.getElementById('pending-agents').textContent = pendingAgents;
}

function toggleHostSelection(hostId, event) {
    if (event) event.stopPropagation();
    
    if (selectedHosts.has(hostId)) {
        selectedHosts.delete(hostId);
    } else {
        selectedHosts.add(hostId);
    }
    
    renderHosts();
    updateStats();
    updateActionButtons();
}

function selectAllHosts() {
    if (selectedHosts.size === hosts.length) {
        // Unselect all
        selectedHosts.clear();
    } else {
        // Select all hosts
        selectedHosts.clear();
        hosts.forEach(host => selectedHosts.add(host.id));
    }
    
    renderHosts();
    updateStats();
    updateActionButtons();
    updateSelectAllButton();
}

function updateSelectAllButton() {
    const btn = document.getElementById('select-all-btn');
    
    if (selectedHosts.size === 0) {
        btn.innerHTML = '<i class="fas fa-check-square pf-u-mr-sm"></i>Select All';
    } else if (selectedHosts.size === hosts.length) {
        btn.innerHTML = '<i class="fas fa-square pf-u-mr-sm"></i>Unselect All';
    } else {
        btn.innerHTML = '<i class="fas fa-minus-square pf-u-mr-sm"></i>Select All';
    }
}

function updateActionButtons() {
    const deployBtn = document.getElementById('deploy-selected-btn');
    const updateBtn = document.getElementById('update-selected-btn');
    
    const hasSelection = selectedHosts.size > 0;
    
    deployBtn.disabled = !hasSelection;
    updateBtn.disabled = !hasSelection;
    
    updateSelectAllButton();
}

// Modal functions
function showAgentLogs() {
    document.getElementById('logs-backdrop').hidden = false;
}

function closeLogsModal() {
    document.getElementById('logs-backdrop').hidden = true;
}

function showAgentCleanupTools() {
    // Implementation for cleanup tools modal
}

function showVersionSummary() {
    // Implementation for version summary modal
}

function updateAllAgents() {
    // Implementation for update all agents
}

function toggleExpandableSection(button) {
    const section = button.closest('.pf-c-expandable-section');
    const content = section.querySelector('.pf-c-expandable-section__content');
    const icon = button.querySelector('.pf-c-expandable-section__toggle-icon i');
    const isExpanded = section.getAttribute('aria-expanded') === 'true';
    
    section.setAttribute('aria-expanded', !isExpanded);
    button.setAttribute('aria-expanded', !isExpanded);
    
    if (isExpanded) {
        icon.classList.remove('fa-angle-down');
        icon.classList.add('fa-angle-right');
        content.style.display = 'none';
    } else {
        icon.classList.remove('fa-angle-right');
        icon.classList.add('fa-angle-down');
        content.style.display = 'block';
    }
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="pf-c-alert pf-m-${type} pf-m-inline" aria-label="${type} alert">
            <div class="pf-c-alert__icon">
                <i class="fas fa-${type === 'danger' ? 'exclamation-circle' : 'check-circle'}" aria-hidden="true"></i>
            </div>
            <p class="pf-c-alert__title">${message}</p>
            <div class="pf-c-alert__action">
                <button class="pf-c-button pf-m-plain" type="button" aria-label="Close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    `;
    
    const content = document.querySelector('.nm-content');
    content.insertAdjacentHTML('afterbegin', alertHtml);
}

// Complete JavaScript implementation with PatternFly compatibility

// Deployment functions
async function deploySelectedAgents() {
    if (selectedHosts.size === 0) {
        showAlert('warning', 'Please select hosts to deploy agents to');
        return;
    }
    
    if (deploymentInProgress) {
        showAlert('warning', 'Deployment already in progress');
        return;
    }
    
    const selectedHostsArray = Array.from(selectedHosts).map(id => 
        hosts.find(h => h.id === id)
    ).filter(h => h);
    
    if (selectedHostsArray.length === 0) {
        showAlert('warning', 'No valid hosts selected');
        return;
    }
    
    deploymentInProgress = true;
    document.getElementById('deployment-progress-backdrop').hidden = false;
    
    const progressIndicator = document.getElementById('deployment-progress');
    const progressText = document.getElementById('deployment-progress-text');
    const statusElement = document.getElementById('deployment-status');
    const logsElement = document.getElementById('deployment-logs');
    const closeBtn = document.getElementById('close-deployment-btn');
    
    progressIndicator.style.width = '0%';
    progressText.textContent = '0%';
    statusElement.textContent = 'Starting deployment...';
    logsElement.textContent = '';
    closeBtn.disabled = true;
    
    try {
        for (let i = 0; i < selectedHostsArray.length; i++) {
            const host = selectedHostsArray[i];
            const progress = Math.round(((i + 1) / selectedHostsArray.length) * 100);
            
            progressIndicator.style.width = progress + '%';
            progressText.textContent = progress + '%';
            statusElement.textContent = `Deploying to ${host.name} (${i + 1}/${selectedHostsArray.length})`;
            
            logsElement.textContent += `
[${new Date().toLocaleTimeString()}] Starting deployment to ${host.name} (${host.ip_address})
`;
            logsElement.scrollTop = logsElement.scrollHeight;
            
            try {
                await deployAgentToHost(host);
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Successfully deployed to ${host.name}
`;
            } catch (error) {
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Failed to deploy to ${host.name}: ${error.message}
`;
            }
            
            logsElement.scrollTop = logsElement.scrollHeight;
        }
        
        statusElement.textContent = 'Deployment completed';
        selectedHosts.clear();
        
        // Refresh data to show new agents
        setTimeout(() => {
            refreshData();
        }, 2000);
        
    } catch (error) {
        statusElement.textContent = 'Deployment failed: ' + error.message;
    } finally {
        deploymentInProgress = false;
        closeBtn.disabled = false;
    }
}

async function deployAgentToHost(host) {
    try {
        const response = await fetch('/api/deploy_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                host_id: host.id,
                server_url: window.location.origin
            })
        });
        
        if (!response.ok) {
            let errorText;
            try {
                errorText = await response.text();
                const errorData = JSON.parse(errorText);
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            } catch (jsonError) {
                throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Deployment failed');
        }
        
        return data;
        
    } catch (error) {
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error(`Network error: Cannot connect to server. ${error.message}`);
        }
        throw error;
    }
}

async function updateSelectedAgents() {
    if (selectedHosts.size === 0) {
        showAlert('warning', 'Please select hosts to update agents on');
        return;
    }
    
    // Implementation for agent updates
    showAlert('info', 'Agent update functionality will be implemented soon');
}

function deploySingleAgent(hostId) {
    selectedHosts.clear();
    selectedHosts.add(hostId);
    deploySelectedAgents();
}

function updateLogAgentSelect() {
    const select = document.getElementById('log-agent-select');
    select.innerHTML = '<option value="">All Agents</option>' +
        agents.map(agent => `<option value="${agent.agent_id}">${agent.hostname} (${agent.ip_address})</option>`).join('');
}

// Agent logs functionality
async function loadAgentLogs() {
    const agentId = document.getElementById('log-agent-select').value;
    const hours = document.getElementById('log-hours-select').value;
    const container = document.getElementById('logs-container');
    
    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--pf-global--Color--light-200);"><i class="fas fa-spinner fa-spin"></i> Loading logs...</div>';
    
    try {
        const url = `/api/agent/logs?${agentId ? `agent_id=${agentId}&` : ''}hours=${hours}&limit=1000`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            if (data.logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--pf-global--Color--light-200);">No logs found for the selected criteria</div>';
                return;
            }
            
            const logsHtml = data.logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const level = log.level || 'info';
                const levelColor = level === 'error' ? '#ff6b6b' : level === 'warning' ? '#feca57' : '#48dbfb';
                
                return `<div style="margin-bottom: 0.25rem;">
                    <span style="color: var(--pf-global--Color--light-200);">[${timestamp}]</span>
                    <span style="color: ${levelColor};">[${level.toUpperCase()}]</span>
                    ${log.source ? `<span style="color: #2ed573;">[${log.source}]</span>` : ''}
                    <span>${log.message}</span>
                </div>`;
            }).join('');
            
            container.innerHTML = logsHtml;
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = `<div style="color: #ff6b6b; padding: 1rem;">Failed to load logs: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div style="color: #ff6b6b; padding: 1rem;">Error loading logs: ${error.message}</div>`;
    }
}

// Agent control functions
function showAgentControl(hostname, ipAddress) {
    // Store current host for control operations
    window.currentControlHost = { hostname, ipAddress };
    
    // Set host info in status modal
    document.getElementById('status-host-name').textContent = hostname;
    document.getElementById('status-host-ip').textContent = ipAddress;
    
    // Reset status indicators
    resetStatusIndicators();
    
    // Show status modal
    document.getElementById('agent-status-backdrop').hidden = false;
    
    // Find agent data and update indicators
    const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
    if (agent) {
        updateStatusIndicators(agent);
    }
}

function resetStatusIndicators() {
    const indicators = [
        { id: 'service-status-icon', color: 'pf-u-color-200', text: 'service-status-text' },
        { id: 'heartbeat-status-icon', color: 'pf-u-color-200', text: 'heartbeat-status-text' },
        { id: 'scanning-status-icon', color: 'pf-u-color-200', text: 'scanning-status-text' },
        { id: 'logs-status-icon', color: 'pf-u-color-200', text: 'logs-status-text' }
    ];
    
    indicators.forEach(indicator => {
        const iconElement = document.getElementById(indicator.id);
        const textElement = document.getElementById(indicator.text);
        
        if (iconElement) {
            iconElement.className = `fas fa-circle fa-2x ${indicator.color}`;
        }
        if (textElement) {
            textElement.textContent = 'Checking...';
        }
    });
    
    // Reset system info
    document.getElementById('agent-version').textContent = '-';
    document.getElementById('agent-platform').textContent = '-';
    document.getElementById('last-heartbeat').textContent = '-';
    document.getElementById('last-scan').textContent = '-';
}

function updateStatusIndicators(agent) {
    // Update service status
    updateStatusIndicator(
        'service-status-icon',
        'service-status-text',
        agent.heartbeat_status === 'online' ? 'success' : agent.heartbeat_status === 'warning' ? 'warning' : 'danger',
        agent.heartbeat_status === 'online' ? 'Active' : agent.heartbeat_status === 'warning' ? 'Warning' : 'Inactive'
    );
    
    // Update heartbeat status
    const minutesSince = agent.minutes_since_heartbeat;
    updateStatusIndicator(
        'heartbeat-status-icon',
        'heartbeat-status-text',
        minutesSince <= 2 ? 'success' : minutesSince <= 5 ? 'warning' : 'danger',
        minutesSince !== null ? `${minutesSince}m ago` : 'Never'
    );
    
    // Update scanning status
    updateStatusIndicator(
        'scanning-status-icon',
        'scanning-status-text',
        agent.heartbeat_status === 'online' ? 'success' : 'secondary',
        agent.heartbeat_status === 'online' ? 'Active' : 'Unknown'
    );
    
    // Update log collection status
    updateStatusIndicator(
        'logs-status-icon',
        'logs-status-text',
        agent.heartbeat_status === 'online' ? 'success' : 'secondary',
        agent.heartbeat_status === 'online' ? 'Collecting' : 'Inactive'
    );
    
    // Update system info
    document.getElementById('agent-version').textContent = agent.agent_version || '-';
    document.getElementById('agent-platform').textContent = agent.platform || '-';
    document.getElementById('last-heartbeat').textContent = 
        agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : '-';
    document.getElementById('last-scan').textContent = 
        agent.last_scan ? new Date(agent.last_scan).toLocaleString() : '-';
}

function updateStatusIndicator(iconId, textId, status, text) {
    const iconElement = document.getElementById(iconId);
    const textElement = document.getElementById(textId);
    
    let colorClass = 'pf-u-color-200';
    switch (status) {
        case 'success':
            colorClass = 'pf-u-success-color-100';
            break;
        case 'warning':
            colorClass = 'pf-u-warning-color-100';
            break;
        case 'danger':
            colorClass = 'pf-u-danger-color-100';
            break;
    }
    
    if (iconElement) {
        iconElement.className = `fas fa-circle fa-2x ${colorClass}`;
    }
    if (textElement) {
        textElement.textContent = text;
    }
}

async function refreshAgentStatus() {
    if (!window.currentControlHost) return;
    
    const refreshBtn = document.getElementById('refresh-status-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        const { hostname, ipAddress } = window.currentControlHost;
        
        // Execute status check command
        const response = await fetch('/api/control_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress,
                action: 'status'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('service-details-output').textContent = data.output || 'No status output received';
        }
        
        // Refresh the data
        await refreshData();
        
        // Update status indicators with fresh data
        const agent = agents.find(a => a.ip_address === ipAddress || a.hostname === hostname);
        if (agent) {
            updateStatusIndicators(agent);
        }
        
    } catch (error) {
        console.error('Error refreshing agent status:', error);
        document.getElementById('service-details-output').textContent = 'Error: ' + error.message;
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

async function runAgentNow(hostname, ipAddress) {
    // Set agent name in modal
    document.getElementById('run-agent-name').textContent = `${hostname} (${ipAddress})`;
    
    // Show the progress modal
    document.getElementById('agent-run-progress-backdrop').hidden = false;
    
    // Reset modal state
    const progressIndicator = document.getElementById('agent-run-progress');
    const progressText = document.getElementById('agent-run-progress-text');
    const statusElement = document.getElementById('agent-run-status');
    const logsElement = document.getElementById('agent-run-logs');
    const closeBtn = document.getElementById('close-agent-run-btn');
    const okBtn = document.getElementById('agent-run-ok-btn');
    
    progressIndicator.style.width = '0%';
    progressText.textContent = '0%';
    statusElement.textContent = 'Initializing scan...';
    logsElement.textContent = '';
    closeBtn.disabled = true;
    okBtn.disabled = true;
    
    try {
        // Step 1: Initialize (10%)
        progressIndicator.style.width = '10%';
        progressText.textContent = '10%';
        statusElement.textContent = 'Connecting to agent...';
        logsElement.textContent += `[${new Date().toLocaleTimeString()}] Connecting to ${hostname}
`;
        
        // Step 2: Send run command (30%)
        progressIndicator.style.width = '30%';
        progressText.textContent = '30%';
        statusElement.textContent = 'Sending scan command...';
        logsElement.textContent += `[${new Date().toLocaleTimeString()}] Sending immediate scan command
`;
        logsElement.scrollTop = logsElement.scrollHeight;
        
        const response = await fetch('/api/agent/run_now', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress
            })
        });
        
        const data = await response.json();
        
        // Step 3: Processing response (60%)
        progressIndicator.style.width = '60%';
        progressText.textContent = '60%';
        statusElement.textContent = 'Processing response...';
        
        if (data.success) {
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Scan command sent successfully
`;
            
            // Step 4: Waiting for scan to start (80%)
            progressIndicator.style.width = '80%';
            progressText.textContent = '80%';
            statusElement.textContent = 'Starting network scan...';
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] Agent is starting network scan
`;
            
            // Simulate scan initialization delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Step 5: Complete (100%)
            progressIndicator.style.width = '100%';
            progressText.textContent = '100%';
            statusElement.textContent = 'Scan initiated successfully';
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Network scan has been triggered
`;
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] Scan results will be available shortly
`;
            
            // Change progress bar to success color
            progressIndicator.parentElement.classList.add('pf-m-success');
            
        } else {
            throw new Error(data.error || 'Failed to trigger agent scan');
        }
        
    } catch (error) {
        // Error state
        progressIndicator.style.width = '100%';
        progressText.textContent = '100%';
        statusElement.textContent = 'Scan failed';
        logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Error: ${error.message}
`;
        
        // Change progress bar to error color
        progressIndicator.parentElement.classList.add('pf-m-danger');
    } finally {
        // Enable close buttons
        closeBtn.disabled = false;
        okBtn.disabled = false;
        logsElement.scrollTop = logsElement.scrollHeight;
        
        // Auto-refresh data after a short delay to show updated agent status
        setTimeout(() => {
            refreshData();
        }, 3000);
    }
}

function closeAgentRunModal() {
    document.getElementById('agent-run-progress-backdrop').hidden = true;
    
    // Reset modal state for next use
    const progressIndicator = document.getElementById('agent-run-progress');
    const progressContainer = progressIndicator.parentElement;
    
    // Remove status classes
    progressContainer.classList.remove('pf-m-success', 'pf-m-danger');
}

function viewHostAgentLogs(agentId) {
    document.getElementById('log-agent-select').value = agentId;
    showAgentLogs();
    loadAgentLogs();
}

function viewLastAgentData(agentId) {
    const agent = agents.find(a => a.agent_id === agentId);
    if (!agent) {
        showAlert('danger', 'Agent not found');
        return;
    }
    
    // Set agent name in the modal
    document.getElementById('data-agent-name').textContent = `${agent.hostname} (${agent.ip_address})`;
    
    // Reset tab content
    resetAgentDataTabs();
    
    // Show the modal
    document.getElementById('agent-data-backdrop').hidden = false;
    
    // Load agent data
    loadAgentData(agentId);
}

async function uninstallAgent(hostname, ipAddress) {
    if (!confirm(`Are you sure you want to uninstall the agent from ${hostname}?

This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/uninstall_agent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hostname: hostname,
                ip_address: ipAddress
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', 'Agent uninstalled successfully');
            refreshData();
        } else {
            showAlert('danger', 'Failed to uninstall agent: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Error uninstalling agent: ' + error.message);
    }
}

function closeDeploymentModal() {
    document.getElementById('deployment-progress-backdrop').hidden = true;
}

function closeAgentStatusModal() {
    document.getElementById('agent-status-backdrop').hidden = true;
}

// Agent Data Modal Functions
function resetAgentDataTabs() {
    // Reset all tab panels to hidden
    const panels = document.querySelectorAll('#agent-data-tabs .pf-c-tabs__item-body');
    panels.forEach(panel => {
        panel.classList.add('pf-m-hidden');
    });
    
    // Show summary panel and set active tab
    document.getElementById('summary-tab-panel').classList.remove('pf-m-hidden');
    
    // Reset tab buttons
    const tabButtons = document.querySelectorAll('#agent-data-tabs .pf-c-tabs__link');
    tabButtons.forEach(btn => {
        btn.classList.remove('pf-m-current');
    });
    document.getElementById('summary-tab').classList.add('pf-m-current');
}

async function loadAgentData(agentId) {
    try {
        const response = await fetch(`/api/agent/last_data/${agentId}`);
        const data = await response.json();
        
        if (data.success) {
            const agentData = data.agent_data;
            displayAgentSummary(agentData);
            displayNetworkScans(agentData.network_data || []);
            displayTestResults(agentData.test_results || {});
            displayRawData(agentData);
        } else {
            document.getElementById('agent-summary-content').innerHTML = 
                `<div class="pf-c-alert pf-m-danger pf-m-inline"><div class="pf-c-alert__icon"><i class="fas fa-exclamation-circle"></i></div><p class="pf-c-alert__title">Failed to load agent data: ${data.error}</p></div>`;
        }
    } catch (error) {
        document.getElementById('agent-summary-content').innerHTML = 
            `<div class="pf-c-alert pf-m-danger pf-m-inline"><div class="pf-c-alert__icon"><i class="fas fa-exclamation-circle"></i></div><p class="pf-c-alert__title">Error loading agent data: ${error.message}</p></div>`;
    }
}

function displayAgentSummary(data) {
    const summaryHtml = `
        <div class="pf-l-gallery pf-m-gutter pf-u-mb-md">
            <div class="pf-c-card pf-m-compact">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="pf-u-mb-sm">
                        <i class="fas fa-network-wired fa-2x pf-u-color-100"></i>
                    </div>
                    <h6 class="pf-c-card__title pf-u-mb-xs">Hosts Discovered</h6>
                    <div class="pf-u-font-size-2xl pf-u-font-weight-bold">${data.hosts_count || 0}</div>
                </div>
            </div>
            <div class="pf-c-card pf-m-compact">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="pf-u-mb-sm">
                        <i class="fas fa-globe fa-2x pf-u-color-100"></i>
                    </div>
                    <h6 class="pf-c-card__title pf-u-mb-xs">Services Found</h6>
                    <div class="pf-u-font-size-2xl pf-u-font-weight-bold">${data.services_count || 0}</div>
                </div>
            </div>
            <div class="pf-c-card pf-m-compact">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="pf-u-mb-sm">
                        <i class="fas fa-shield-alt fa-2x pf-u-color-100"></i>
                    </div>
                    <h6 class="pf-c-card__title pf-u-mb-xs">Tests Run</h6>
                    <div class="pf-u-font-size-2xl pf-u-font-weight-bold">${data.tests_count || 0}</div>
                </div>
            </div>
            <div class="pf-c-card pf-m-compact">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="pf-u-mb-sm">
                        <i class="fas fa-clock fa-2x pf-u-color-100"></i>
                    </div>
                    <h6 class="pf-c-card__title pf-u-mb-xs">Last Scan</h6>
                    <div class="pf-u-font-size-sm">${data.last_scan ? new Date(data.last_scan).toLocaleString() : 'Never'}</div>
                </div>
            </div>
        </div>
        
        <div class="pf-c-description-list pf-m-horizontal">
            <div class="pf-c-description-list__group">
                <dt class="pf-c-description-list__term">Agent Version</dt>
                <dd class="pf-c-description-list__description">
                    <div class="pf-c-description-list__text">${data.agent_version || 'Unknown'}</div>
                </dd>
            </div>
            <div class="pf-c-description-list__group">
                <dt class="pf-c-description-list__term">Platform</dt>
                <dd class="pf-c-description-list__description">
                    <div class="pf-c-description-list__text">${data.platform || 'Unknown'}</div>
                </dd>
            </div>
            <div class="pf-c-description-list__group">
                <dt class="pf-c-description-list__term">Scan Duration</dt>
                <dd class="pf-c-description-list__description">
                    <div class="pf-c-description-list__text">${data.scan_duration || 'Unknown'}</div>
                </dd>
            </div>
        </div>
    `;
    
    document.getElementById('agent-summary-content').innerHTML = summaryHtml;
}

function displayNetworkScans(networkScans) {
    if (!networkScans || networkScans.length === 0) {
        document.getElementById('network-scans-content').innerHTML = 
            '<div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">No network scan data available</div>';
        return;
    }
    
    const scansHtml = networkScans.map(scan => `
        <div class="pf-c-card pf-m-compact pf-u-mb-md">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-server pf-u-mr-sm"></i>
                    ${scan.ip_address} ${scan.hostname ? `(${scan.hostname})` : ''}
                </div>
            </div>
            <div class="pf-c-card__body">
                <div class="pf-l-flex pf-u-mb-sm">
                    <div class="pf-l-flex__item">
                        <strong>MAC Address:</strong> ${scan.mac_address || 'Unknown'}
                    </div>
                    <div class="pf-l-flex__item">
                        <strong>Status:</strong> 
                        <span class="pf-c-label pf-m-${scan.status === 'up' ? 'green' : 'red'}">
                            ${scan.status || 'Unknown'}
                        </span>
                    </div>
                </div>
                ${scan.services && scan.services.length > 0 ? `
                <div class="pf-u-mb-sm">
                    <strong>Services:</strong>
                    <div class="pf-u-mt-xs">
                        ${scan.services.map(service => 
                            `<span class="pf-c-label pf-m-outline pf-u-mr-xs">${service.port}/${service.protocol}</span>`
                        ).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    document.getElementById('network-scans-content').innerHTML = scansHtml;
}

function displayTestResults(testResults) {
    // Handle both array and object formats
    let testArray = [];
    
    if (!testResults) {
        document.getElementById('test-results-content').innerHTML = 
            '<div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">No test results available</div>';
        return;
    }
    
    if (Array.isArray(testResults)) {
        testArray = testResults;
    } else if (typeof testResults === 'object') {
        // Convert object to array of test results
        testArray = Object.keys(testResults).map(key => ({
            test_name: key,
            ...testResults[key]
        }));
    }
    
    if (testArray.length === 0) {
        document.getElementById('test-results-content').innerHTML = 
            '<div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">No test results available</div>';
        return;
    }
    
    const resultsHtml = testArray.map(test => `
        <div class="pf-c-card pf-m-compact pf-u-mb-md">
            <div class="pf-c-card__header">
                <div class="pf-c-card__title">
                    <i class="fas fa-${test.status === 'pass' ? 'check-circle' : test.status === 'fail' ? 'times-circle' : 'exclamation-circle'} pf-u-mr-sm"></i>
                    ${test.test_name}
                </div>
                <div class="pf-c-card__actions">
                    <span class="pf-c-label pf-m-${test.status === 'pass' ? 'green' : test.status === 'fail' ? 'red' : 'orange'}">
                        ${(test.status || 'unknown').toUpperCase()}
                    </span>
                </div>
            </div>
            <div class="pf-c-card__body">
                <p class="pf-u-mb-sm">${test.description || 'No description available'}</p>
                ${test.result_details ? `<div class="nm-code-block" style="max-height: 150px;">${test.result_details}</div>` : ''}
            </div>
        </div>
    `).join('');
    
    document.getElementById('test-results-content').innerHTML = resultsHtml;
}

function displayRawData(data) {
    const rawDataString = JSON.stringify(data, null, 2);
    document.getElementById('raw-data-display').textContent = rawDataString;
}

// Tab switching for agent data modal
document.addEventListener('click', function(e) {
    if (e.target.closest('#agent-data-tabs .pf-c-tabs__link')) {
        const clickedTab = e.target.closest('.pf-c-tabs__link');
        const tabId = clickedTab.id;
        const panelId = clickedTab.getAttribute('aria-controls');
        
        // Remove current class from all tabs
        document.querySelectorAll('#agent-data-tabs .pf-c-tabs__link').forEach(tab => {
            tab.classList.remove('pf-m-current');
        });
        
        // Hide all panels
        document.querySelectorAll('#agent-data-tabs .pf-c-tabs__item-body').forEach(panel => {
            panel.classList.add('pf-m-hidden');
        });
        
        // Activate clicked tab and show corresponding panel
        clickedTab.classList.add('pf-m-current');
        document.getElementById(panelId).classList.remove('pf-m-hidden');
    }
});

function closeAgentDataModal() {
    document.getElementById('agent-data-backdrop').hidden = true;
}

// Global variables for version management
let selectedVersionHosts = new Set();
let versionUpdateInProgress = false;
let latestVersion = null; // Will be determined from actual agent versions

// Version Summary Modal Functions
function showVersionSummary() {
    document.getElementById('version-summary-backdrop').hidden = false;
    selectedVersionHosts.clear();
    loadVersionSummary();
}

function closeVersionSummaryModal() {
    document.getElementById('version-summary-backdrop').hidden = true;
    selectedVersionHosts.clear();
}

async function loadVersionSummary() {
    try {
        // Load agent versions
        const versionsResponse = await fetch('/api/agent/versions');
        const versionsData = await versionsResponse.json();
        
        if (versionsData.success) {
            const agents = versionsData.agents || [];
            
            // Determine latest version from actual agent versions
            if (agents.length > 0) {
                const versions = agents
                    .map(a => a.agent_version)
                    .filter(v => v && v !== 'Unknown')
                    .map(v => {
                        // Parse semantic version (e.g., "1.6.6" -> [1, 6, 6])
                        const parts = v.split('.').map(n => parseInt(n) || 0);
                        return { version: v, parts: parts };
                    })
                    .sort((a, b) => {
                        // Sort by semantic version (descending)
                        for (let i = 0; i < Math.max(a.parts.length, b.parts.length); i++) {
                            const aPart = a.parts[i] || 0;
                            const bPart = b.parts[i] || 0;
                            if (aPart !== bPart) {
                                return bPart - aPart; // Descending order
                            }
                        }
                        return 0;
                    });
                
                // Set latest version to the highest version found
                latestVersion = versions.length > 0 ? versions[0].version : 'Unknown';
            } else {
                latestVersion = 'Unknown';
            }
            
            await displayVersionSummary(agents);
            updateVersionStats(agents);
        } else {
            document.getElementById('version-summary-content').innerHTML = 
                `<div class="pf-c-alert pf-m-danger pf-m-inline"><div class="pf-c-alert__icon"><i class="fas fa-exclamation-circle"></i></div><p class="pf-c-alert__title">Failed to load version data: ${versionsData.error}</p></div>`;
        }
    } catch (error) {
        document.getElementById('version-summary-content').innerHTML = 
            `<div class="pf-c-alert pf-m-danger pf-m-inline"><div class="pf-c-alert__icon"><i class="fas fa-exclamation-circle"></i></div><p class="pf-c-alert__title">Error loading version data: ${error.message}</p></div>`;
    }
}

function updateVersionStats(agents) {
    const totalHosts = hosts.length;
    const totalAgents = agents.length;
    
    // Update agent statuses and count them properly
    let onlineCount = 0;
    let offlineCount = 0;
    let warningCount = 0;
    
    agents.forEach(agent => {
        const statusInfo = determineAgentStatus(agent);
        switch (statusInfo.heartbeatStatus) {
            case 'online':
                onlineCount++;
                break;
            case 'warning':
                warningCount++;
                break;
            case 'offline':
            default:
                offlineCount++;
                break;
        }
    });
    
    document.getElementById('version-latest-version').textContent = latestVersion || 'Unknown';
    document.getElementById('version-total-hosts').textContent = totalHosts;
    document.getElementById('version-total-agents').textContent = totalAgents;
    document.getElementById('version-online-agents').textContent = onlineCount;
    document.getElementById('version-offline-agents').textContent = offlineCount;
}

function displayVersionSummary(versions) {
    if (!versions || versions.length === 0) {
        document.getElementById('version-summary-content').innerHTML = 
            '<div class="pf-u-text-align-center pf-u-p-lg pf-u-color-200">No version data available</div>';
        return;
    }
    
    // Update agent statuses first to ensure consistency
    versions.forEach(agent => {
        const statusInfo = determineAgentStatus(agent);
        // Update the agent object with the calculated status
        agent.heartbeat_status = statusInfo.heartbeatStatus;
    });
    
    // Create individual cards for each host
    const hostCards = versions.map(agent => {
        const isSelected = selectedVersionHosts.has(agent.agent_id);
        const currentVersion = agent.agent_version || 'Unknown';
        const isOutdated = currentVersion !== latestVersion && currentVersion !== 'Unknown' && latestVersion !== 'Unknown';
        const versionStatusClass = currentVersion === latestVersion ? 'green' : isOutdated ? 'orange' : 'red';
        const versionStatusText = currentVersion === latestVersion ? 'Current' : isOutdated ? 'Outdated' : 'Unknown';
        
        return `
            <div class="pf-l-gallery__item">
                <div class="pf-c-card pf-m-compact ${isSelected ? 'nm-agent-card selected' : 'nm-agent-card'}" onclick="toggleVersionHostSelection('${agent.agent_id}', event)">
                    <div class="pf-c-card__header">
                        <div class="pf-c-card__header-main">
                            <div class="nm-agent-header">
                                <div>
                                    <h4 class="pf-c-card__title">
                                        <i class="fas fa-server pf-u-mr-xs"></i>
                                        ${agent.hostname}
                                    </h4>
                                    <p class="pf-u-color-200 pf-u-font-size-sm">${agent.ip_address}</p>
                                </div>
                                <div class="pf-c-check">
                                    <input class="pf-c-check__input" type="checkbox" 
                                           id="version-check-${agent.agent_id}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="event.stopPropagation(); toggleVersionHostSelection('${agent.agent_id}')">
                                    <label class="pf-c-check__label" for="version-check-${agent.agent_id}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pf-c-card__body">
                        <!-- Current Version -->
                        <div class="pf-u-mb-sm">
                            <span class="pf-u-font-weight-bold">Current Version:</span>
                            <span class="pf-c-label pf-m-${versionStatusClass} pf-u-ml-sm">
                                <i class="fas fa-${versionStatusClass === 'green' ? 'check' : versionStatusClass === 'orange' ? 'exclamation-triangle' : 'times'} pf-u-mr-xs"></i>
                                ${currentVersion} (${versionStatusText})
                            </span>
                        </div>
                        
                        <!-- Version Select (only show if not already latest) -->
                        ${currentVersion !== latestVersion && latestVersion !== 'Unknown' ? `
                        <div class="pf-u-mb-sm">
                            <label class="pf-c-form__label" for="version-select-${agent.agent_id}">
                                <span class="pf-c-form__label-text">Update to:</span>
                            </label>
                            <select class="pf-c-form-control" id="version-select-${agent.agent_id}" onchange="event.stopPropagation()">
                                <option value="${latestVersion}">${latestVersion} (Latest)</option>
                            </select>
                        </div>
                        ` : ''}
                        
                        <!-- Agent Status -->
                        <div class="pf-u-mb-sm">
                            <span class="pf-u-font-weight-bold">Status:</span>
                            <span class="pf-c-label pf-m-${agent.heartbeat_status === 'online' ? 'green' : agent.heartbeat_status === 'warning' ? 'orange' : 'red'} pf-u-ml-sm">
                                ${agent.heartbeat_status || 'offline'}
                            </span>
                        </div>
                        
                        <!-- Last Communication -->
                        <div class="pf-u-mb-sm">
                            <span class="pf-u-font-weight-bold pf-u-font-size-sm">Last Heartbeat:</span>
                            <span class="pf-u-color-200 pf-u-font-size-sm">
                                ${agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'Never'}
                            </span>
                        </div>
                        
                        <!-- Progress Bar (Hidden by default) -->
                        <div class="nm-progress-container" id="version-progress-${agent.agent_id}" style="display: none;">
                            <div class="nm-progress-bar" id="version-progress-bar-${agent.agent_id}"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('version-summary-content').innerHTML = 
        `<div class="pf-l-gallery pf-m-gutter">${hostCards}</div>`;
    
    updateVersionActionButtons();
}

function toggleVersionHostSelection(agentId, event) {
    if (event) event.stopPropagation();
    
    if (versionUpdateInProgress) {
        showAlert('warning', 'Update in progress, cannot change selection');
        return;
    }
    
    if (selectedVersionHosts.has(agentId)) {
        selectedVersionHosts.delete(agentId);
    } else {
        selectedVersionHosts.add(agentId);
    }
    
    // Re-render to update selection state
    loadVersionSummary();
}

function selectAllVersionHosts() {
    if (versionUpdateInProgress) {
        showAlert('warning', 'Update in progress, cannot change selection');
        return;
    }
    
    // Get all available agent IDs from the DOM
    const checkboxes = document.querySelectorAll('[id^="version-check-"]');
    const agentIds = Array.from(checkboxes).map(cb => cb.id.replace('version-check-', ''));
    
    if (selectedVersionHosts.size === agentIds.length) {
        // Unselect all
        selectedVersionHosts.clear();
    } else {
        // Select all
        selectedVersionHosts.clear();
        agentIds.forEach(id => selectedVersionHosts.add(id));
    }
    
    loadVersionSummary();
}

function updateVersionActionButtons() {
    const updateSelectedBtn = document.getElementById('update-selected-agents-btn');
    const updateAllBtn = document.getElementById('update-all-agents-btn');
    const selectAllBtn = document.getElementById('select-all-version-btn');
    
    const hasSelection = selectedVersionHosts.size > 0;
    const totalAgents = document.querySelectorAll('[id^="version-check-"]').length;
    
    if (updateSelectedBtn) {
        updateSelectedBtn.disabled = !hasSelection || versionUpdateInProgress;
    }
    
    if (updateAllBtn) {
        updateAllBtn.disabled = totalAgents === 0 || versionUpdateInProgress;
    }
    
    if (selectAllBtn) {
        if (selectedVersionHosts.size === 0) {
            selectAllBtn.innerHTML = '<i class="fas fa-check-square pf-u-mr-sm"></i>Select All';
        } else if (selectedVersionHosts.size === totalAgents) {
            selectAllBtn.innerHTML = '<i class="fas fa-square pf-u-mr-sm"></i>Unselect All';
        } else {
            selectAllBtn.innerHTML = '<i class="fas fa-minus-square pf-u-mr-sm"></i>Select All';
        }
    }
}

// Update functions
async function updateSelectedAgents() {
    if (selectedVersionHosts.size === 0) {
        showAlert('warning', 'Please select agents to update');
        return;
    }
    
    if (versionUpdateInProgress) {
        showAlert('warning', 'Update already in progress');
        return;
    }
    
    const selectedAgents = agents.filter(a => selectedVersionHosts.has(a.agent_id));
    await performAgentUpdates(selectedAgents);
}

async function updateAllAgents() {
    if (agents.length === 0) {
        showAlert('warning', 'No agents available to update');
        return;
    }
    
    if (versionUpdateInProgress) {
        showAlert('warning', 'Update already in progress');
        return;
    }
    
    if (!confirm('Are you sure you want to update all agents? This will update all deployed agents to the latest version.')) {
        return;
    }
    
    await performAgentUpdates(agents);
}

async function performAgentUpdates(agentsToUpdate) {
    versionUpdateInProgress = true;
    
    // Show progress container
    document.getElementById('version-update-progress-container').hidden = false;
    
    // Disable action buttons and close button
    document.getElementById('close-version-modal-btn').disabled = true;
    updateVersionActionButtons();
    
    const progressIndicator = document.getElementById('version-update-progress');
    const progressText = document.getElementById('version-update-progress-text');
    const statusElement = document.getElementById('version-update-status');
    const logsElement = document.getElementById('version-update-logs');
    
    progressIndicator.style.width = '0%';
    progressText.textContent = '0%';
    statusElement.textContent = 'Starting agent updates...';
    logsElement.textContent = '';
    
    try {
        for (let i = 0; i < agentsToUpdate.length; i++) {
            const agent = agentsToUpdate[i];
            const progress = Math.round(((i + 1) / agentsToUpdate.length) * 100);
            
            // Update main progress bar
            progressIndicator.style.width = progress + '%';
            progressText.textContent = progress + '%';
            statusElement.textContent = `Updating ${agent.hostname} (${i + 1}/${agentsToUpdate.length})`;
            
            // Show individual progress bar for this agent
            const agentProgressContainer = document.getElementById(`version-progress-${agent.agent_id}`);
            const agentProgressBar = document.getElementById(`version-progress-bar-${agent.agent_id}`);
            
            if (agentProgressContainer && agentProgressBar) {
                agentProgressContainer.style.display = 'block';
                agentProgressBar.style.width = '0%';
                agentProgressBar.className = 'nm-progress-bar nm-progress-animated';
            }
            
            logsElement.textContent += `
[${new Date().toLocaleTimeString()}] Starting update for ${agent.hostname} (${agent.ip_address})
`;
            logsElement.scrollTop = logsElement.scrollHeight;
            
            try {
                // Get selected version for this agent
                const versionSelect = document.getElementById(`version-select-${agent.agent_id}`);
                const targetVersion = versionSelect ? versionSelect.value : latestVersion;
                
                // Animate individual progress bar
                if (agentProgressBar) {
                    agentProgressBar.style.width = '50%';
                }
                
                await updateAgentToVersion(agent, targetVersion);
                
                // Complete individual progress bar
                if (agentProgressBar) {
                    agentProgressBar.style.width = '100%';
                    agentProgressBar.className = 'nm-progress-bar success';
                }
                
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✓ Successfully updated ${agent.hostname} to version ${targetVersion}
`;
            } catch (error) {
                // Error individual progress bar
                if (agentProgressBar) {
                    agentProgressBar.style.width = '100%';
                    agentProgressBar.className = 'nm-progress-bar danger';
                }
                
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] ✗ Failed to update ${agent.hostname}: ${error.message}
`;
            }
            
            logsElement.scrollTop = logsElement.scrollHeight;
        }
        
        statusElement.textContent = 'Agent updates completed';
        selectedVersionHosts.clear();
        
        // Refresh data to show new versions
        setTimeout(() => {
            refreshData();
            loadVersionSummary();
        }, 2000);
        
    } catch (error) {
        statusElement.textContent = 'Update failed: ' + error.message;
    } finally {
        versionUpdateInProgress = false;
        document.getElementById('close-version-modal-btn').disabled = false;
        updateVersionActionButtons();
    }
}

async function updateAgentToVersion(agent, targetVersion) {
    try {
        // If no target version specified, use the latest version
        const versionToUpdate = targetVersion || latestVersion;
        
        const response = await fetch('/api/agent/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                agent_id: agent.agent_id,
                hostname: agent.hostname,
                ip_address: agent.ip_address,
                target_version: versionToUpdate
            })
        });
        
        if (!response.ok) {
            let errorText;
            try {
                errorText = await response.text();
                const errorData = JSON.parse(errorText);
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            } catch (jsonError) {
                throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Update failed');
        }
        
        return data;
        
    } catch (error) {
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error(`Network error: Cannot connect to server. ${error.message}`);
        }
        throw error;
    }
}

async function refreshVersionSummary() {
    const refreshBtn = document.getElementById('refresh-versions-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        await refreshData();
        await loadVersionSummary();
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

// Cleanup Tools Modal Functions
function showAgentCleanupTools() {
    document.getElementById('cleanup-tools-backdrop').hidden = false;
    loadCleanupTools();
}

function closeCleanupToolsModal() {
    document.getElementById('cleanup-tools-backdrop').hidden = true;
}

async function loadCleanupTools() {
    try {
        // Load cleanup statistics
        const [hostsResponse, agentsResponse, logsResponse] = await Promise.all([
            fetch('/api/hosts'),
            fetch('/api/agents'),
            fetch('/api/agent/cleanup/logs/info')
        ]);
        
        const hostsData = await hostsResponse.json();
        const agentsData = await agentsResponse.json();
        let logsData = { log_files: 0, total_size: '0 MB' };
        
        // Handle logs info response (may not exist)
        if (logsResponse.ok) {
            const logsResult = await logsResponse.json();
            if (logsResult.success) {
                logsData = logsResult;
            }
        }
        
        const stats = {
            hosts: hostsData.success ? (hostsData.hosts || []).length : 0,
            agents: agentsData.success ? (agentsData.agents || []).length : 0,
            logFiles: logsData.log_files || 0,
            logSize: logsData.total_size || '0 MB'
        };
        
        displayCleanupTools(stats);
        
    } catch (error) {
        console.error('Error loading cleanup stats:', error);
        // Display with default stats if loading fails
        displayCleanupTools({
            hosts: 0,
            agents: 0,
            logFiles: 0,
            logSize: '0 MB'
        });
    }
}

function displayCleanupTools(stats) {
    const toolsHtml = `
        <!-- Statistics Section -->
        <div class="pf-l-gallery pf-m-gutter pf-u-mb-lg" style="grid-template-columns: repeat(3, 1fr);">
            <div class="pf-c-card nm-stat-card">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="nm-stat-value" style="color: var(--pf-global--primary-color--100)" id="cleanup-total-hosts">${stats.hosts}</div>
                    <div class="nm-stat-label">Total Hosts</div>
                </div>
            </div>
            <div class="pf-c-card nm-stat-card">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="nm-stat-value" style="color: var(--pf-global--success-color--100)" id="cleanup-total-agents">${stats.agents}</div>
                    <div class="nm-stat-label">Total Agents</div>
                </div>
            </div>
            <div class="pf-c-card nm-stat-card">
                <div class="pf-c-card__body pf-u-text-align-center">
                    <div class="nm-stat-value" style="color: var(--pf-global--info-color--100)" id="cleanup-log-files">${stats.logFiles}</div>
                    <div class="nm-stat-label">Log Files (${stats.logSize})</div>
                </div>
            </div>
        </div>
        
        <!-- Refresh Button -->
        <div class="pf-u-text-align-center pf-u-mb-lg">
            <button class="pf-c-button pf-m-secondary" onclick="refreshCleanupStats()">
                <i class="fas fa-sync-alt pf-u-mr-sm"></i>
                Refresh Statistics
            </button>
        </div>
        
        <!-- Cleanup Tools Cards -->
        <div class="pf-l-gallery pf-m-gutter" style="grid-template-columns: repeat(3, 1fr);">
            <div class="pf-c-card">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__title">
                        <i class="fas fa-copy pf-u-mr-sm"></i>
                        Remove Duplicate Agents
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-mb-md">Remove duplicate agent entries from the database</p>
                    <button class="pf-c-button pf-m-danger pf-m-block" onclick="cleanupInactiveAgents()">
                        <i class="fas fa-broom pf-u-mr-sm"></i>
                        Remove Duplicates
                    </button>
                </div>
            </div>
            <div class="pf-c-card">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__title">
                        <i class="fas fa-database pf-u-mr-sm"></i>
                        Remove Stale Data
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-mb-md">Remove stale agent data from the database</p>
                    <button class="pf-c-button pf-m-warning pf-m-block" onclick="cleanupOldData()">
                        <i class="fas fa-calendar-times pf-u-mr-sm"></i>
                        Remove Stale Data
                    </button>
                </div>
            </div>
            <div class="pf-c-card">
                <div class="pf-c-card__header">
                    <div class="pf-c-card__title">
                        <i class="fas fa-file-alt pf-u-mr-sm"></i>
                        Clear Log Files
                    </div>
                </div>
                <div class="pf-c-card__body">
                    <p class="pf-u-mb-md">Clear agent log files to free up disk space</p>
                    <button class="pf-c-button pf-m-secondary pf-m-block" onclick="cleanupLogFiles()">
                        <i class="fas fa-file-times pf-u-mr-sm"></i>
                        Clear Log Files
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('cleanup-tools-content').innerHTML = toolsHtml;
}

async function cleanupInactiveAgents() {
    if (!confirm('Are you sure you want to remove duplicate agent entries? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/agent/cleanup/duplicates', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `Removed ${data.count || 0} duplicate agents`);
            refreshData();
        } else {
            showAlert('danger', 'Failed to cleanup duplicate agents: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Error cleaning up duplicate agents: ' + error.message);
    }
}

async function cleanupOldData() {
    if (!confirm('Are you sure you want to remove stale agent data? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/agent/cleanup/stale', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `Removed stale data (${data.count || 0} records)`);
        } else {
            showAlert('danger', 'Failed to cleanup stale data: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Error cleaning up stale data: ' + error.message);
    }
}

async function cleanupLogFiles() {
    if (!confirm('Are you sure you want to clear old log files? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/agent/cleanup/logs', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `Cleared log files (${data.size || 'unknown size'} freed)`);
        } else {
            showAlert('danger', 'Failed to cleanup log files: ' + data.error);
        }
    } catch (error) {
        showAlert('danger', 'Error cleaning up log files: ' + error.message);
    }
}

// Refresh cleanup statistics
async function refreshCleanupStats() {
    try {
        // Show loading state on refresh button
        const refreshBtn = event.target;
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin pf-u-mr-sm"></i>Refreshing...';
        refreshBtn.disabled = true;
        
        // Reload cleanup statistics
        await loadCleanupTools();
        
        // Also refresh the main data after cleanup operations
        await refreshData();
        
        // Restore button
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
    } catch (error) {
        console.error('Error refreshing cleanup stats:', error);
        showAlert('danger', 'Error refreshing statistics: ' + error.message);
    }
}

// Initialize action buttons state
updateActionButtons();

</script>
{% endblock %}
