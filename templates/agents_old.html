{% extends "base.html" %}

{% block title %}Agent Management - Network Map{% endblock %}

{% block content %}
    <style>
        .agent-card {
            transition: all 0.3s ease;
            border-left: 4px solid #6c757d;
        }
        .agent-card.online {
            border-left-color: #28a745;
        }
        .agent-card.warning {
            border-left-color: #ffc107;
        }
        .agent-card.offline {
            border-left-color: #dc3545;
        }
        .agent-card.never {
            border-left-color: #6c757d;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .config-editor {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .deployment-section {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .code-block {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-network-wired"></i> Network Map</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link" href="/hosts">Hosts</a>
                <a class="nav-link" href="/network_diagram">Network Diagram</a>
                <a class="nav-link active" href="/agents">Agents</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-robot"></i> Agent Management</h1>
                <p class="text-muted">Deploy and manage network monitoring agents on remote hosts</p>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Agents</h6>
                                <h3 class="mb-0" id="total-agents">-</h3>
                            </div>
                            <i class="fas fa-robot fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Online</h6>
                                <h3 class="mb-0" id="online-agents">-</h3>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Warning</h6>
                                <h3 class="mb-0" id="warning-agents">-</h3>
                            </div>
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Offline</h6>
                                <h3 class="mb-0" id="offline-agents">-</h3>
                            </div>
                            <i class="fas fa-times-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col">
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-primary" onclick="refreshAgents()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#deploymentModal">
                        <i class="fas fa-plus"></i> Deploy New Agent
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="exportAgentData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#logsModal">
                        <i class="fas fa-file-alt"></i> View Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Agents List -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Deployed Agents
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="agents-container">
                            <!-- Agents will be loaded here -->
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading agents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Deployment Modal -->
    <div class="modal fade" id="deploymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-rocket"></i> Deploy New Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="deployment-section">
                        <h6><i class="fas fa-info-circle"></i> Prerequisites</h6>
                        <ul class="mb-3">
                            <li>Target host must be running Ubuntu/Debian Linux</li>
                            <li>SSH access must be available</li>
                            <li>User must have passwordless sudo configured</li>
                            <li>Python 3 must be installed</li>
                        </ul>
                        
                        <h6><i class="fas fa-download"></i> Download Agent Script</h6>
                        <p>Download and run the agent installation script on your target host:</p>
                        <div class="code-block" id="deployment-commands">
# Download the agent script
curl -O http://{{ request.host }}/static/network_agent.py

# Make it executable
chmod +x network_agent.py

# Install as service (requires sudo)
sudo python3 network_agent.py --install --server-url http://{{ request.host }}

# Start the agent service
sudo systemctl start network-agent
sudo systemctl enable network-agent
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('deployment-commands')">
                            <i class="fas fa-copy"></i> Copy Commands
                        </button>
                    </div>

                    <div class="deployment-section">
                        <h6><i class="fas fa-cog"></i> Manual Configuration</h6>
                        <p>For manual setup, configure these settings in the agent script:</p>
                        <div class="code-block">
SERVER_URL = "http://{{ request.host }}"
SCAN_INTERVAL = 300  # 5 minutes
HEARTBEAT_INTERVAL = 60  # 1 minute
LOG_COLLECTION = True
                        </div>
                    </div>

                    <div class="deployment-section">
                        <h6><i class="fas fa-user-shield"></i> Passwordless Sudo Setup</h6>
                        <p>Configure passwordless sudo for the agent user:</p>
                        <div class="code-block">
# Create sudo rule for agent user
echo "agentuser ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/network-agent

# Verify the configuration
sudo -l -U agentuser
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="/static/network_agent.py" class="btn btn-primary" download>
                        <i class="fas fa-download"></i> Download Agent Script
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Agent Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="config-form">
                        <input type="hidden" id="config-agent-id">
                        
                        <div class="mb-3">
                            <label class="form-label">Scan Interval (seconds)</label>
                            <input type="number" class="form-control" id="config-scan-interval" min="60" max="86400">
                            <small class="form-text text-muted">How often to run network scans (60-86400 seconds)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Heartbeat Interval (seconds)</label>
                            <input type="number" class="form-control" id="config-heartbeat-interval" min="30" max="300">
                            <small class="form-text text-muted">How often to send status updates (30-300 seconds)</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="config-log-collection">
                                <label class="form-check-label" for="config-log-collection">
                                    Enable Log Collection
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Log Paths</label>
                            <textarea class="form-control" id="config-log-paths" rows="3" placeholder="/var/log,/var/log/syslog"></textarea>
                            <small class="form-text text-muted">Comma-separated list of log files/directories to monitor</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="config-scan-enabled">
                                <label class="form-check-label" for="config-scan-enabled">
                                    Enable Network Scanning
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgentConfig()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-alt"></i> Agent Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="log-agent-select">
                                <option value="">All Agents</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="log-hours-select">
                                <option value="1">Last Hour</option>
                                <option value="6">Last 6 Hours</option>
                                <option value="24" selected>Last 24 Hours</option>
                                <option value="168">Last Week</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="loadAgentLogs()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="log-viewer" id="logs-container">
                        <div class="text-center text-muted p-4">
                            Select an agent and click refresh to view logs
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Refresh Button -->
    <button class="btn btn-primary btn-lg rounded-circle refresh-button" onclick="refreshAgents()" title="Refresh Agents">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let agents = [];
        let refreshInterval;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshAgents();
            startAutoRefresh();
            
            // Update server URL in deployment modal
            const serverUrl = window.location.origin;
            document.getElementById('deployment-commands').textContent = 
                document.getElementById('deployment-commands').textContent.replace(/http:\/\/[^\/]+/g, serverUrl);
        });

        function startAutoRefresh() {
            // Refresh every 30 seconds
            refreshInterval = setInterval(refreshAgents, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        async function refreshAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                if (data.success) {
                    agents = data.agents;
                    renderAgents();
                    updateStats();
                    updateLogAgentSelect();
                } else {
                    console.error('Failed to load agents:', data.error);
                    document.getElementById('agents-container').innerHTML = 
                        '<div class="alert alert-danger">Failed to load agents: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Error refreshing agents:', error);
                document.getElementById('agents-container').innerHTML = 
                    '<div class="alert alert-danger">Error loading agents: ' + error.message + '</div>';
            }
        }

        function renderAgents() {
            const container = document.getElementById('agents-container');
            
            if (agents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>No Agents Deployed</h5>
                        <p>Deploy your first agent to start monitoring remote hosts</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deploymentModal">
                            <i class="fas fa-plus"></i> Deploy Agent
                        </button>
                    </div>
                `;
                return;
            }

            const html = agents.map(agent => `
                <div class="agent-card card mb-3 ${agent.heartbeat_status}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">
                                    <i class="fas fa-server"></i> ${agent.hostname}
                                    <span class="status-badge badge bg-${getStatusColor(agent.heartbeat_status)} ms-2">
                                        ${agent.heartbeat_status.toUpperCase()}
                                    </span>
                                </h6>
                                <small class="text-muted">${agent.ip_address}</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">User:</small><br>
                                <strong>${agent.username}</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Last Heartbeat:</small><br>
                                <strong>${formatLastSeen(agent.last_heartbeat, agent.minutes_since_heartbeat)}</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Last Scan:</small><br>
                                <strong>${formatLastSeen(agent.last_scan_time)}</strong>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="configureAgent('${agent.agent_id}')" title="Configure">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewAgentLogs('${agent.agent_id}')" title="View Logs">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="pingAgent('${agent.agent_id}')" title="Test Connection">
                                        <i class="fas fa-satellite-dish"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="removeAgent('${agent.agent_id}')" title="Remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        ${agent.error_message ? `
                        <div class="row mt-2">
                            <div class="col">
                                <div class="alert alert-warning alert-sm mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> ${agent.error_message}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updateStats() {
            const stats = {
                total: agents.length,
                online: agents.filter(a => a.heartbeat_status === 'online').length,
                warning: agents.filter(a => a.heartbeat_status === 'warning').length,
                offline: agents.filter(a => a.heartbeat_status === 'offline').length
            };

            document.getElementById('total-agents').textContent = stats.total;
            document.getElementById('online-agents').textContent = stats.online;
            document.getElementById('warning-agents').textContent = stats.warning;
            document.getElementById('offline-agents').textContent = stats.offline;
        }

        function updateLogAgentSelect() {
            const select = document.getElementById('log-agent-select');
            select.innerHTML = '<option value="">All Agents</option>' +
                agents.map(agent => `<option value="${agent.agent_id}">${agent.hostname} (${agent.ip_address})</option>`).join('');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'online': return 'success';
                case 'warning': return 'warning';
                case 'offline': return 'danger';
                default: return 'secondary';
            }
        }

        function formatLastSeen(timestamp, minutesAgo = null) {
            if (!timestamp) return 'Never';
            
            if (minutesAgo !== null) {
                if (minutesAgo < 1) return 'Just now';
                if (minutesAgo < 60) return `${minutesAgo}m ago`;
                const hours = Math.floor(minutesAgo / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            }
            
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        async function configureAgent(agentId) {
            try {
                const response = await fetch(`/api/agent/config/${agentId}`);
                const data = await response.json();
                
                if (data.success) {
                    const config = data.config;
                    document.getElementById('config-agent-id').value = agentId;
                    document.getElementById('config-scan-interval').value = config.scan_interval;
                    document.getElementById('config-heartbeat-interval').value = config.heartbeat_interval;
                    document.getElementById('config-log-collection').checked = config.log_collection_enabled;
                    document.getElementById('config-log-paths').value = config.log_paths;
                    document.getElementById('config-scan-enabled').checked = config.scan_enabled;
                    
                    new bootstrap.Modal(document.getElementById('configModal')).show();
                } else {
                    alert('Failed to load agent configuration: ' + data.error);
                }
            } catch (error) {
                alert('Error loading configuration: ' + error.message);
            }
        }

        async function saveAgentConfig() {
            const agentId = document.getElementById('config-agent-id').value;
            const config = {
                scan_interval: parseInt(document.getElementById('config-scan-interval').value),
                heartbeat_interval: parseInt(document.getElementById('config-heartbeat-interval').value),
                log_collection_enabled: document.getElementById('config-log-collection').checked,
                log_paths: document.getElementById('config-log-paths').value,
                scan_enabled: document.getElementById('config-scan-enabled').checked
            };

            try {
                const response = await fetch(`/api/agent/config/${agentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                    alert('Configuration saved successfully');
                    refreshAgents();
                } else {
                    alert('Failed to save configuration: ' + data.error);
                }
            } catch (error) {
                alert('Error saving configuration: ' + error.message);
            }
        }

        function viewAgentLogs(agentId) {
            document.getElementById('log-agent-select').value = agentId;
            new bootstrap.Modal(document.getElementById('logsModal')).show();
            loadAgentLogs();
        }

        async function loadAgentLogs() {
            const agentId = document.getElementById('log-agent-select').value;
            const hours = document.getElementById('log-hours-select').value;
            const container = document.getElementById('logs-container');
            
            container.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading logs...</div>';
            
            try {
                const url = `/api/agent/logs?${agentId ? `agent_id=${agentId}&` : ''}hours=${hours}&limit=1000`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    if (data.logs.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted p-4">No logs found for the selected criteria</div>';
                        return;
                    }
                    
                    const logsHtml = data.logs.map(log => {
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        const level = log.level || 'info';
                        const levelColor = level === 'error' ? 'text-danger' : level === 'warning' ? 'text-warning' : 'text-info';
                        
                        return `<div class="mb-1">
                            <span class="text-muted">[${timestamp}]</span>
                            <span class="${levelColor}">[${level.toUpperCase()}]</span>
                            ${log.source ? `<span class="text-success">[${log.source}]</span>` : ''}
                            <span>${log.message}</span>
                        </div>`;
                    }).join('');
                    
                    container.innerHTML = logsHtml;
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Failed to load logs: ' + data.error + '</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Error loading logs: ' + error.message + '</div>';
            }
        }

        async function pingAgent(agentId) {
            // This would require a ping endpoint on the server
            alert('Ping functionality will be implemented in the next version');
        }

        async function removeAgent(agentId) {
            if (!confirm('Are you sure you want to remove this agent? This action cannot be undone.')) {
                return;
            }
            
            // This would require a remove endpoint on the server
            alert('Agent removal functionality will be implemented in the next version');
        }

        async function exportAgentData() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                if (data.success) {
                    const exportData = {
                        export_timestamp: new Date().toISOString(),
                        agents: data.agents
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                        type: 'application/json'
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `agents_export_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export agent data: ' + data.error);
                }
            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard');
            });
        }

        // Handle page visibility changes to pause/resume auto-refresh
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                refreshAgents(); // Refresh immediately when page becomes visible
            }
        });
    </script>
</body>
</html>
