<!DOCTYPE html>
<html>
<head>
    <title>Test Markdown Parsing</title>
    <style>
        .code-block {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            margin: 0.75rem 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
            background: #1a202c;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #e2e8f0;
        }
        
        .code-block code {
            background: transparent;
            padding: 0;
            border: none;
            font-family: inherit;
            color: #e2e8f0;
        }
        
        .code-header {
            background: #2d3748;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #a0aec0;
        }
        
        .copy-code-btn {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .copy-code-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <h1>Markdown Parsing Test</h1>
    
    <h2>Test Input (simulating API response):</h2>
    <pre id="input"></pre>
    
    <h2>Parsed Output:</h2>
    <div id="output"></div>
    
    <script>
        // Test content with escaped newlines (as received from API)
        const testContent = `I've generated a script for your request: **Show memory usage**\\n\\n**Generated Script:**\\n\`\`\`bash\\n#!/bin/bash\\n# Generated script for: Show memory usage\\n# Template: Check memory usage\\n# Generated at: 2025-08-19T15:01:14.305083\\n\\necho '=== Check memory usage ==='\\necho 'Hostname:' $(hostname)\\necho 'Timestamp:' $(date)\\necho ''\\n\\nfree -h\\n\\necho ''\\necho '=== Command completed successfully ==='\\n\`\`\`\\n\\n**What this script does:**\\nThis script handles your request.`;
        
        // Show the input
        document.getElementById('input').textContent = testContent;
        
        // Function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format message content function (from chatbot.html)
        function formatMessageContent(content) {
            console.log('Input content:', content);
            
            // First, handle code blocks before doing other replacements
            const codeBlocks = [];
            let codeBlockIndex = 0;
            
            // Extract and preserve code blocks (including bash)
            // Handle both actual newlines and escaped \\n characters
            content = content.replace(/```(\\w+)?[\\s\\n]*([\\s\\S]*?)```/g, (match, language, code) => {
                console.log('Found code block:', { match, language, code });
                const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
                // Convert literal \\n to actual newlines if present
                const processedCode = code.replace(/\\\\n/g, '\\n').trim();
                console.log('Processed code:', processedCode);
                codeBlocks[codeBlockIndex] = {
                    language: language || '',
                    code: processedCode
                };
                codeBlockIndex++;
                return placeholder;
            });
            
            console.log('Content after code block extraction:', content);
            console.log('Code blocks found:', codeBlocks);
            
            // Convert **bold** text
            content = content.replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>');
            
            // Convert newlines to <br> (but preserve existing HTML)
            content = content.replace(/\\n/g, '<br>');
            
            // Restore code blocks
            codeBlocks.forEach((block, index) => {
                const placeholder = `__CODE_BLOCK_${index}__`;
                const languageClass = block.language ? ` language-${block.language}` : '';
                const codeHtml = `<div class="code-block"><div class="code-header"><span><i class="fas fa-code"></i> ${block.language ? block.language.toUpperCase() + ' ' : ''}Code</span><button class="copy-code-btn" onclick="copyCodeBlock(this)" title="Copy code"><i class="fas fa-copy"></i></button></div><pre><code class="${languageClass}">${escapeHtml(block.code)}</code></pre></div>`;
                content = content.replace(placeholder, codeHtml);
            });
            
            console.log('Final formatted content:', content);
            return content;
        }
        
        // Test the function
        const result = formatMessageContent(testContent);
        document.getElementById('output').innerHTML = result;
    </script>
</body>
</html>
